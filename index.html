<!-- Global Hillview Helpdesk (GitHub Pages SPA)
     - Plain HTML + React 18 UMD + Babel Standalone
     - Works with your GAS backend (Auth.gs / Code.gs)
     - Login gate + admin-only inline edits
     - Displays Issues table with ALL columns, dates in DD-MM-YYYY
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Global Hillview ‚Äì Helpdesk</title>

  <!-- Tailwind for utilities (optional, lightweight) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD + Babel for in-browser JSX (NOT TypeScript) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Configure your GAS Web App URL (can be overridden via ?gas=...) -->
  <script>
    window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";
  </script>

  <style>
    body { background:#f7f9fc }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn  { background:#111827; color:#fff; border-radius:12px; padding:.6rem 1rem }
    .btn-secondary { background:#f3f4f6; color:#111827; border-radius:12px; padding:.5rem .9rem }
    .badge { display:inline-flex; padding:.15rem .5rem; font-size:.75rem; border-radius:.5rem; background:#eef2ff; color:#3730a3 }
    table th, table td { padding:.6rem .75rem }
    .muted { color:#6b7280 }
    .input { width:100%; border:1px solid #e5e7eb; border-radius:12px; padding:.55rem .7rem; background:#fff }
    .sticky-top { position:sticky; top:0; background:#fff; z-index:20 }
  </style>
</head>
<body>
  <div id="root" class="min-h-screen"></div>

  <script type="text/babel" data-presets="env,react">
    const {useEffect, useMemo, useState} = React;

    // ========= Config / helpers =========
    const SOCIETY = "Global Hillview, Sec-11, Sohna, Gurgaon";
    const params = new URLSearchParams(location.search);
    const GAS = (params.get("gas") || window.ENV_GAS_URL || "").trim();

    function ddmmyyyy(input){
      if(!input) return "";
      const d = input instanceof Date ? input : new Date(input);
      if (isNaN(d)) return String(input);
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yyyy = d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }
    const toDate = (v)=> v ? new Date(String(v).includes("T")? v : String(v).replace(" ","T")) : null;

    // Robust fetch with timeout
    async function fetchWithTimeout(url, opts={}, timeoutMs=30000){
      const ctl = new AbortController();
      const id = setTimeout(()=>ctl.abort(), timeoutMs);
      try { return await fetch(url, {...opts, signal: ctl.signal}); }
      finally { clearTimeout(id); }
    }

    async function postJSON(url, body){
      const res = await fetchWithTimeout(url, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
      return res.json();
    }

    // ========= API (matches your Code.gs/Auth.gs) =========
    // - GET ?mode=data           -> issues array
    // - POST {op:'login'}        -> {ok, token, role}
    // - POST {op:'sessionInfo'}  -> {ok, info:{role}}
    // - POST {op:'update'}       -> update ticket fields (admin)
    const api = {
      async listIssues(){
        const u = new URL(GAS);
        u.searchParams.set("mode","data");
        const r = await fetchWithTimeout(u.toString(), {cache:"no-store"});
        if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
        return r.json(); // returns array (per your Code.gs)
      },
      async login(username, password){
        return postJSON(GAS, {op:"login", username, password});
      },
      async sessionInfo(token){
        return postJSON(GAS, {op:"sessionInfo", token});
      },
      async update(token, payload){
        return postJSON(GAS, {op:"update", token, ...payload});
      }
    };

    // ========= UI bits =========
    const Banner = ({kind="info", children})=>{
      const cls = kind==="error" ? "bg-red-50 text-red-700 border-red-200"
                                 : "bg-blue-50 text-blue-700 border-blue-200";
      return <div className={`border rounded-xl p-3 ${cls}`}>{children}</div>;
    };

    function Login({onSuccess}){
      const [u,setU]=useState(""); const [p,setP]=useState("");
      const [err,setErr]=useState(""); const [busy,setBusy]=useState(false);

      async function submit(){
        if(busy) return;
        setErr(""); setBusy(true);
        try{
          const res = await api.login(u,p);
          if(res && res.ok && res.token){
            try { localStorage.setItem("session", res.token); } catch(e){}
            onSuccess({token: res.token, role: res.role || "user"});
          }else{
            setErr(res && res.error ? res.error : "Login failed");
          }
        }catch(e){ setErr(String(e)); }
        finally{ setBusy(false); }
      }

      return (
        <div className="min-h-screen grid place-items-center p-6">
          <div className="card w-full max-w-md p-6">
            <div className="text-xl font-semibold mb-2">Sign in</div>
            <div className="text-sm text-gray-500 mb-4">{SOCIETY}</div>
            <div className="grid gap-3">
              <div>
                <label className="text-sm text-gray-500">Username</label>
                <input className="input mt-1" value={u} onChange={e=>setU(e.target.value)} autoFocus />
              </div>
              <div>
                <label className="text-sm text-gray-500">Password</label>
                <input className="input mt-1" type="password" value={p} onChange={e=>setP(e.target.value)} />
              </div>
              <button className="btn" onClick={submit} disabled={busy}>{busy?"Signing in‚Ä¶":"Sign in"}</button>
              {err && <Banner kind="error">{err}</Banner>}
              <div className="text-xs text-gray-500">Tip: ask an admin to create/reset your account.</div>
            </div>
          </div>
        </div>
      );
    }

    function Issues({rows, isAdmin, onUpdate}){
      const COLS = [
        "Tracking ID","Date and Time Raised","Tower","Flat","Issue","Description",
        "Media URL","Status","Redressal Remark","User ID","Date and Time Resolved",
        "Time Taken","Feedback Rating"
      ];

      const [editRemark, setEditRemark] = useState({});
      const [editStatus, setEditStatus] = useState({});

      function val(row, key){
        const raw = row[key];
        if(!raw) return "";
        if(key.includes("Date")) return ddmmyyyy(raw);
        return String(raw);
      }

      async function saveRemark(id){
        const remark = editRemark[id] ?? "";
        await onUpdate({id, remark});
        setEditRemark(s => ({...s, [id]: undefined}));
      }
      async function saveStatus(id){
        const status = editStatus[id] ?? "Open";
        await onUpdate({id, status});
        setEditStatus(s => ({...s, [id]: undefined}));
      }

      return (
        <div className="card p-4">
          <div className="text-lg font-semibold mb-2">All Issues</div>
          <div className="overflow-auto">
            <table className="min-w-full text-sm">
              <thead className="sticky-top">
                <tr className="text-left text-gray-600">
                  {COLS.map(k => <th key={k} className="whitespace-nowrap">{k}</th>)}
                  {isAdmin && <th className="whitespace-nowrap">Actions</th>}
                </tr>
              </thead>
              <tbody>
                {rows.map((r,i)=>{
                  const id = String(r["Tracking ID"]||`row-${i}`);
                  const raised = toDate(r["Date and Time Raised"]);
                  const resolved = toDate(r["Date and Time Resolved"]);
                  return (
                    <tr key={id} className="border-t align-top">
                      {COLS.map(k=>{
                        if(k==="Status" && isAdmin){
                          const cur = editStatus[id] ?? r["Status"] ?? "Open";
                          return (
                            <td key={k} className="whitespace-nowrap">
                              <select
                                className="input"
                                value={cur}
                                onChange={e=>setEditStatus(s=>({...s,[id]:e.target.value}))}
                              >
                                {["Open","InProgress","Resolved","Closed"].map(o=><option key={o}>{o}</option>)}
                              </select>
                            </td>
                          );
                        }
                        if(k==="Redressal Remark" && isAdmin){
                          const cur = editRemark[id] ?? (r["Redressal Remark"]||"");
                          return (
                            <td key={k} style={{minWidth:220}}>
                              <textarea
                                className="input"
                                rows="2"
                                value={cur}
                                onChange={e=>setEditRemark(s=>({...s,[id]:e.target.value}))}
                              />
                            </td>
                          );
                        }
                        if(k==="Media URL"){
                          const url = r["Media URL"];
                          return <td key={k} className="whitespace-nowrap">{url ? <a className="underline" target="_blank" rel="noreferrer" href={url}>Open</a> : ""}</td>;
                        }
                        return <td key={k} className="whitespace-nowrap">{val(r,k)}</td>;
                      })}
                      {isAdmin && (
                        <td className="whitespace-nowrap">
                          <div className="flex gap-2">
                            <button className="btn-secondary" onClick={()=>saveStatus(id)}>Save Status</button>
                            <button className="btn-secondary" onClick={()=>saveRemark(id)}>Save Remark</button>
                            {/* Quick helper */}
                            <button className="btn-secondary" onClick={()=>{ setEditStatus(s=>({...s,[id]:"Resolved"})); const now = new Date(); alert("Status set to Resolved. Click Save Status to submit."); }}>Mark Resolved</button>
                          </div>
                        </td>
                      )}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function App(){
      const [session,setSession]=useState({token:null, role:null});
      const [loading,setLoading]=useState(true);
      const [error,setError]=useState("");
      const [rows,setRows]=useState([]);

      // read token (from URL ?session=... or localStorage)
      useEffect(()=>{
        const urlToken = new URLSearchParams(location.search).get("session");
        const stored = !urlToken ? (localStorage.getItem("session")||null) : null;
        const token = urlToken || stored;

        async function boot(){
          try{
            // Validate session (role) if token available
            if(token){
              const res = await api.sessionInfo(token);
              if(res && res.ok && res.info && res.info.ok){
                setSession({token, role: String(res.info.role||"user").toLowerCase()});
              }else{
                // invalid -> clear
                try{ localStorage.removeItem("session"); }catch(e){}
                setSession({token:null, role:null});
              }
            }
            // load data regardless (public)
            const data = await api.listIssues();
            setRows(Array.isArray(data) ? data : (data.rows||[]));
            setError("");
          }catch(e){
            setError(String(e));
          }finally{
            setLoading(false);
          }
        }
        boot();
      },[]);

      async function handleLogin(ok){
        setSession(ok);
        setLoading(true);
        try{
          const data = await api.listIssues();
          setRows(Array.isArray(data) ? data : (data.rows||[]));
          setError("");
        }catch(e){ setError(String(e)); }
        finally{ setLoading(false); }
      }

      async function handleUpdate(changes){
        if(!session.token) { alert("Not authenticated"); return; }
        try{
          await api.update(session.token, changes);
          // refresh table for stamps
          const data = await api.listIssues();
          setRows(Array.isArray(data) ? data : (data.rows||[]));
        }catch(e){ alert(String(e)); }
      }

      function logout(){
        try{ localStorage.removeItem("session"); }catch(e){}
        // reset session, keep data visible
        setSession({token:null, role:null});
      }

      if(loading) return <div className="p-6 text-gray-500">Loading‚Ä¶</div>;
      if(!GAS) return <div className="p-6"><Banner kind="error">Missing GAS URL. Add <code>?gas=&lt;your_web_app_url&gt;</code> or set <code>window.ENV_GAS_URL</code>.</Banner></div>;

      // Gate: if no valid session, show login page (issues remain visible after login‚Äîpublic read; write is gated)
      if(!session.token || !session.role){
        return <Login onSuccess={handleLogin} />;
      }

      const isAdmin = session.role === "admin";

      const openCount = rows.filter(r => String(r.Status||"Open").toLowerCase()==="open").length;
      const total = rows.length;

      return (
        <div className="max-w-7xl mx-auto p-4 md:p-6">
          <div className="flex items-center justify-between mb-4">
            <div>
              <div className="text-xl font-semibold">üè† {SOCIETY}</div>
              <div className="text-sm text-gray-500">Helpdesk Dashboard ‚Äî {isAdmin ? "Admin" : "User"}</div>
            </div>
            <div className="flex items-center gap-2">
              <span className="badge">Open: {openCount}</span>
              <span className="badge">Total: {total}</span>
              <button className="btn-secondary" onClick={logout}>Logout</button>
            </div>
          </div>

          {error && <div className="mb-3"><Banner kind="error">{error}</Banner></div>}

          <Issues rows={rows} isAdmin={isAdmin} onUpdate={handleUpdate} />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
