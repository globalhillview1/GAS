<!-- Single-file, no-build index.html for GitHub Pages
     ‚úÖ React 18 UMD + Babel Standalone (runs directly on GH Pages)
     ‚úÖ No imports/TypeScript/bundler needed
     ‚úÖ Connects to your Google Apps Script backend
     ‚úÖ Robust fetch with timeout+retries, clear errors, and Demo Mode fallback
     ‚úÖ Admin vs User roles (only Admin can post Notices, raise/edit Tickets, see & add Transactions)
     ‚úÖ Pages map 1:1 to sheet tabs; tables render ALL columns
     ‚úÖ Back button on every sub-page; INR ‚Çπ; dates in DD-MM-YYYY
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Hillview, Sec-11, Sohna, Gurgaon ‚Äî Society Portal</title>
  <meta name="description" content="Community management web app powered by Google Sheets (GAS backend)." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%8F%A1%3C/text%3E%3C/svg%3E" />

  <!-- Tailwind (utility styles) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { background: '#f9fafb', foreground: '#111827' } } } };
  </script>

  <!-- React 18 UMD + Babel Standalone for in-browser JSX (no build step) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Configure your Google Apps Script endpoint here (can be overridden by ?gas=... or disabled via ?demo=1) -->
  <script>
    window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";
  </script>

  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); border:1px solid #e5e7eb; }
    .btn  { padding:.5rem 1rem; border-radius:.75rem; background:#111827; color:#fff }
    .btn:hover { background:#0b0f1a }
    .btn-secondary { padding:.5rem .75rem; border-radius:.75rem; background:#f3f4f6; color:#111827 }
    .btn-secondary:hover { background:#e5e7eb }
    .badge { display:inline-flex; align-items:center; padding:.125rem .5rem; font-size:.75rem; border-radius:.5rem; background:#f3f4f6; color:#374151 }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace }
    th,td{ padding-right:1rem }
  </style>
</head>
<body class="bg-background text-foreground">
  <div id="root" class="min-h-screen"></div>

  <!-- App Code (JSX compiled in the browser) -->
  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;

    // =====================
    // Config & Utilities
    // =====================
    const SOCIETY_NAME = 'Global Hillview, Sec-11, Sohna, Gurgaon';
    document.title = SOCIETY_NAME + ' ‚Äî Society Portal';

    const params = new URLSearchParams(location.search);
    const URL_OVERRIDE = params.get('gas');
    const FORCE_DEMO   = params.get('demo') === '1' || params.get('offline') === '1';
    const BASE_URL = (URL_OVERRIDE || (window.ENV_GAS_URL || '')).trim();

    const INR = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 });
    function toDDMMYYYY(v){
      if (!v) return '';
      const tryParse = (s)=>{ const d=new Date(s); return isNaN(d.getTime())?null:d };
      let d=null;
      if (typeof v==='string') d = tryParse(v.replace(/\./g,'/')) || tryParse(v);
      else if (v instanceof Date) d = v;
      if (!d) return String(v);
      const dd=String(d.getDate()).padStart(2,'0');
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const yyyy=d.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }

    const DEMO = {
      Directory: [
        { Serial: 1, Name: 'Ayesha Khan',  Flat: 'A-302', Phone: '+91 98765 00001', Email: 'ayesha@example.com', Photo:'' },
        { Serial: 2, Name: 'Rohan Mehta',  Flat: 'B-1204', Phone: '+91 98765 00002', Email: 'rohan@example.com', Photo:'' },
        { Serial: 3, Name: 'Sofia Keller', Flat: 'C-803', Phone: '+91 98765 00003', Email: 'sofia@example.com', Photo:'' }
      ],
      Notices: [
        { 'Serial Number': 1, Subject: 'Water shutdown on Friday', Date: '2025-01-15', Notice: 'Maintenance from 10:00‚Äì12:00 in Block B.' },
        { 'Serial Number': 2, Subject: 'Diwali Fest ‚Äì Community Hall', Date: '2025-01-16', Notice: 'Potluck & games this Saturday 18:30.' }
      ],
      Issues: [
        { 'Tracking ID': 'demo-101', 'Date and Time Raised': '2025-01-16T09:00:00Z', Tower: 'T1', Flat: '1204', Issue:'Lift not working', Description: 'Lift stuck at floor 7.', 'Media URL':'', Status: 'Open', 'Redressal Remark':'', 'User ID':'resident', 'Date and Time Resolved':'', 'Time Taken':'', 'Feedback Rating':'' },
      ],
      Documents: [ { 'Serial Number': 1, Subject: 'AGM Minutes', Date: '2025-01-10', Media: 'PDF', Link: '#', Category: 'Governance' } ],
      Transactions: [ { Date: '2025-01-01', Type: 'Credit', Category: 'Maintenance', 'Sub-category': 'Monthly', Amount: 1200 } ],
      OpeningBalances: [ { Account: 'Maintenance Fund', Amount: 100000 } ],
      ChartOfAccounts: [ { Code: '1001', Name: 'Cash', Type: 'Asset', Parent:'' } ],
      Voters: [ { 'Tower No.': 'T1', 'Flat No.': '1204', 'First Owner Name': 'Mrs. SUNITA CHAWLA', 'Second Owner Name': '', 'Membership Card & Share Certificate No': '1', 'Elegible Voter': 'Yes', 'Discrepency':'', 'Voted Earlier':'Yes' } ],
      Users: [ { Username: 'admin', Password: 'admin', Role: 'admin', Active: 'Yes' }, { Username: 'resident', Password: 'resident', Role: 'user', Active: 'Yes' } ]
    };

    // Fetch with timeout + retries
    async function fetchWithTimeout(url, opts={}, timeoutMs=30000){
      // Increase timeout to 30s ‚Äî GAS cold starts can exceed 10‚Äì12s.
      const controller=new AbortController();
      const id=setTimeout(()=>controller.abort('timeout'), timeoutMs);
      try{ return await fetch(url,{...opts,signal:controller.signal}); }
      finally{ clearTimeout(id); }
    }); } finally{ clearTimeout(id); }
    }
    async function api(action, method='GET', payload, retries=2){
      if(!BASE_URL) throw new Error('Missing BASE_URL');
      const url=new URL(BASE_URL); url.searchParams.set('action', action);
      const headers = method==='POST' ? {'Content-Type':'text/plain;charset=utf-8'} : {};
      const opts={method, headers}; if(method==='POST' && payload) opts.body=JSON.stringify(payload);
      let lastErr;
      for(let i=0;i<=retries;i++){
        try{
          const res=await fetchWithTimeout(url.toString(), opts, 30000);
          if(!res.ok) throw new Error(await res.text());
          return await res.json();
        }catch(e){ lastErr=e; if(i===retries) throw e; await new Promise(r=>setTimeout(r, 800*(i+1))); }
      }
      throw lastErr;
    } : {};
      const opts={method, headers}; if(method==='POST' && payload) opts.body=JSON.stringify(payload);
      let lastErr;
      for(let i=0;i<=retries;i++){
        try{ const res=await fetchWithTimeout(url.toString(), opts, 12000); if(!res.ok) throw new Error(await res.text()); return await res.json(); }
        catch(e){ lastErr=e; if(i===retries) throw e; await new Promise(r=>setTimeout(r, 600*(i+1))); }
      }
      throw lastErr;
    }

    // UI bits
    const Banner=({kind='info',children})=>{ const cls = kind==='error'?'bg-red-50 text-red-700 border-red-200':'bg-blue-50 text-blue-700 border-blue-200'; return <div className={`border rounded-xl p-3 ${cls}`}>{children}</div>; };
    const Section=({children})=> <section className="grid gap-4">{children}</section>;
    const NavItem=({label,active,onClick})=> (<button className={`btn-secondary text-left ${active?'ring-2 ring-gray-300':''}`} onClick={onClick}>{label}</button>);
    const Stat=({label,value})=> (<div className="card p-5"><div className="text-2xl font-semibold">{value}</div><div className="text-sm text-gray-500">{label}</div></div>);
    const BackBar=({title,onBack})=> (<div className="flex items-center gap-2"><button className="btn-secondary" onClick={onBack}>‚Üê Back</button><div className="text-sm text-gray-500">{title}</div></div>);

    // =====================
    // Pages
    // =====================
    function Dashboard({residents,tickets,transactions,notices}){
      const openTickets=tickets.filter(t=>(t.Status||'').toLowerCase()!=='closed').length;
      const totalDue = transactions.filter(t=>(t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
      const totalPaid= transactions.filter(t=>(t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
      return (
        <Section>
          <div className="grid gap-4 md:grid-cols-3">
            <Stat label="Residents" value={residents.length} />
            <Stat label="Open issues" value={openTickets} />
            <Stat label="Net collected" value={INR.format(totalPaid-totalDue)} />
          </div>
          <div className="grid gap-4 md:grid-cols-2">
            <div className="card p-5">
              <div className="font-medium mb-1">Latest notices</div>
              <div className="text-xs text-gray-500 mb-3">From the "Notices" sheet</div>
              <div className="grid gap-2">
                {notices.slice(0,5).map((n,i)=> (
                  <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                    <div>
                      <div className="font-medium">{n['Subject']}</div>
                      <div className="text-xs text-gray-500">{toDDMMYYYY(n['Date'])}</div>
                    </div>
                    <span className="badge">{n['Serial Number']||i+1}</span>
                  </div>
                ))}
              </div>
            </div>
            <div className="card p-5">
              <div className="font-medium mb-1">Open issues</div>
              <div className="text-xs text-gray-500 mb-3">From the "Issues" sheet</div>
              <div className="grid gap-2">
                {tickets.filter(t=>(t.Status||'').toLowerCase()!=='closed').slice(0,5).map((t,i)=> (
                  <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                    <div>
                      <div className="font-medium">{t['Issue']||t['Title']}</div>
                      <div className="text-xs text-gray-500">{t['Category']||''} ‚Ä¢ {t['Flat']||t['Flat No.']||''}</div>
                    </div>
                    <span className="badge">{t['Status']||'Open'}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </Section>
      );
    }

    function Notices({notices,onCreate,writable,onBack,isAdmin}){
      const [subject,setSubject]=useState(''); const [notice,setNotice]=useState('');
      const submit=async()=>{ if(!subject||!isAdmin) return; const created=await onCreate({Subject:subject,Notice:notice,Date:new Date().toISOString()}); setSubject(''); setNotice(''); return created; };
      const COLS=['Serial Number','Subject','Date','Notice'];
      return (
        <Section>
          <BackBar title="Notices" onBack={onBack} />
          {!isAdmin && <Banner kind="error">Only Admin can post notices.</Banner>}
          {isAdmin && (
            <div className="card p-5">
              <div className="font-medium">Post notice</div>
              <div className="text-xs text-gray-500 mb-4">Writes to the "Notices" sheet</div>
              <div className="grid gap-3">
                <div><label className="block text-sm mb-1">Subject</label><input className="w-full border rounded-xl p-2" value={subject} onChange={e=>setSubject(e.target.value)} placeholder="e.g., Water shutdown" /></div>
                <div><label className="block text-sm mb-1">Notice</label><textarea className="w-full border rounded-xl p-2" rows="4" value={notice} onChange={e=>setNotice(e.target.value)} placeholder="Details‚Ä¶"></textarea></div>
                <div><button className="btn" onClick={submit} disabled={!writable}>Publish</button></div>
              </div>
            </div>
          )}
          <div className="card p-5">
            <div className="font-medium mb-2">All Notices</div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>
                  {notices.map((r,i)=> (
                    <tr key={i} className="border-t">
                      <td className="py-2 pr-4 whitespace-nowrap">{r['Serial Number']||i+1}</td>
                      <td className="py-2 pr-4">{r['Subject']||''}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{toDDMMYYYY(r['Date'])}</td>
                      <td className="py-2 pr-4">{r['Notice']||''}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function Issues({tickets,onCreate,writable,onBack,isAdmin}){
      // FULL columns as requested
      const COLS=['Tracking ID','Date and Time Raised','Tower','Flat','Issue','Description','Media URL','Status','Redressal Remark','User ID','Date and Time Resolved','Time Taken','Feedback Rating'];
      const [form,setForm]=useState({Issue:'',Category:'Infrastructure',Flat:'',Tower:'',Description:'',MediaURL:''});
      const submit=async()=>{
        if(!isAdmin) return alert('Only Admin can raise tickets.');
        if(!form.Issue||!form.Flat) return;
        const payload={
          'Issue': form.Issue,
          'Category': form.Category,
          'Flat': form.Flat,
          'Tower': form.Tower,
          'Description': form.Description,
          'Media URL': form.MediaURL,
          'Status': 'Open',
          'User ID': 'admin',
          'Date and Time Raised': new Date().toISOString()
        };
        await onCreate(payload);
        setForm({Issue:'',Category:'Infrastructure',Flat:'',Tower:'',Description:'',MediaURL:''});
      };
      return (
        <Section>
          <BackBar title="Tickets (Issues)" onBack={onBack} />
          {!isAdmin && <Banner kind="error">Only Admin can raise or edit tickets.</Banner>}
          {isAdmin && (
            <div className="card p-5">
              <div className="font-medium">Raise an issue</div>
              <div className="text-xs text-gray-500 mb-4">Writes to the "Issues" sheet</div>
              <div className="grid gap-3 md:grid-cols-2">
                <div>
                  <label className="block text-sm mb-1">Issue</label>
                  <input className="w-full border rounded-xl p-2" value={form.Issue} onChange={e=>setForm({...form,Issue:e.target.value})} placeholder="Short summary" />
                </div>
                <div>
                  <label className="block text-sm mb-1">Category</label>
                  <select className="w-full border rounded-xl p-2" value={form.Category} onChange={e=>setForm({...form,Category:e.target.value})}>
                    {['Infrastructure','Plumbing','Electrical','Housekeeping','Security'].map(c=> <option key={c} value={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm mb-1">Tower</label>
                  <input className="w-full border rounded-xl p-2" value={form.Tower} onChange={e=>setForm({...form,Tower:e.target.value})} placeholder="e.g., T1" />
                </div>
                <div>
                  <label className="block text-sm mb-1">Flat</label>
                  <input className="w-full border rounded-xl p-2" value={form.Flat} onChange={e=>setForm({...form,Flat:e.target.value})} placeholder="e.g., 1204" />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm mb-1">Description</label>
                  <input className="w-full border rounded-xl p-2" value={form.Description} onChange={e=>setForm({...form,Description:e.target.value})} placeholder="Optional" />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm mb-1">Media URL</label>
                  <input className="w-full border rounded-xl p-2" value={form.MediaURL} onChange={e=>setForm({...form,MediaURL:e.target.value})} placeholder="Paste image/file URL (optional)" />
                </div>
                <div className="md:col-span-2"><button className="btn" onClick={submit} disabled={!writable}>Submit</button></div>
              </div>
            </div>
          )}
          <div className="card p-5 mt-3">
            <div className="font-medium mb-2">All Issues</div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>
                  {tickets.map((row,i)=> (
                    <tr key={i} className="border-t">
                      {COLS.map(h=>{
                        const v=row[h] || row[h.replace('Media URL','MediaURL')] || '';
                        return <td key={h} className="py-2 pr-4 whitespace-nowrap">{h.includes('Date')?toDDMMYYYY(v):String(v)}</td>
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function Directory({rows,onBack,isAdmin,onCreate}){
      const COLS=['Serial','Name','Flat','Phone','Email','Photo'];
      const [photoData,setPhotoData]=useState('');
      const [form,setForm]=useState({Name:'',Flat:'',Phone:'',Email:''});
      const onFile=(e)=>{
        const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>setPhotoData(r.result); r.readAsDataURL(f);
      };
      const submit=async()=>{
        if(!isAdmin) return alert('Only Admin can add to Directory.');
        const payload={...form, Photo: photoData};
        await onCreate(payload);
        setForm({Name:'',Flat:'',Phone:'',Email:''}); setPhotoData('');
      };
      return (
        <Section>
          <BackBar title="Directory" onBack={onBack} />
          {isAdmin && (
            <div className="card p-5">
              <div className="font-medium">Add resident</div>
              <div className="text-xs text-gray-500 mb-4">Writes to the "Directory" sheet</div>
              <div className="grid gap-3 md:grid-cols-2">
                <div><label className="block text-sm mb-1">Name</label><input className="w-full border rounded-xl p-2" value={form.Name} onChange={e=>setForm({...form,Name:e.target.value})} /></div>
                <div><label className="block text-sm mb-1">Flat</label><input className="w-full border rounded-xl p-2" value={form.Flat} onChange={e=>setForm({...form,Flat:e.target.value})} placeholder="e.g., T1-1204"/></div>
                <div><label className="block text-sm mb-1">Phone</label><input className="w-full border rounded-xl p-2" value={form.Phone} onChange={e=>setForm({...form,Phone:e.target.value})} /></div>
                <div><label className="block text-sm mb-1">Email</label><input className="w-full border rounded-xl p-2" value={form.Email} onChange={e=>setForm({...form,Email:e.target.value})} /></div>
                <div className="md:col-span-2"><label className="block text-sm mb-1">Photo</label><input type="file" accept="image/*" onChange={onFile} /><div className="mt-2">{photoData && <img src={photoData} alt="preview" className="h-16 rounded"/>}</div></div>
                <div className="md:col-span-2"><button className="btn" onClick={submit}>Save to Directory</button></div>
              </div>
            </div>
          )}
          <div className="card p-5">
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>
                  {rows.map((r,i)=> (
                    <tr key={i} className="border-t">
                      <td className="py-2 pr-4 whitespace-nowrap">{r.Serial||i+1}</td>
                      <td className="py-2 pr-4">{r.Name}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{r.Flat}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{r.Phone}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{r.Email}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{r.Photo ? <a className="underline" href={r.Photo} target="_blank" rel="noreferrer">Open</a> : ''}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function Payments({transactions,onBack,isAdmin,onCreate}){
      const totals=useMemo(()=>{
        const paid=transactions.filter(t=>(t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
        const due =transactions.filter(t=>(t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
        return {paid,due};
      },[transactions]);
      const COLS=['Date','Type','Category','Sub-category','Amount'];

      const [openForm,setOpenForm]=useState(false);
      const [tx,setTx]=useState({Date:'',Type:'Credit',Category:'',Sub:'',Amount:''});
      const submit=async()=>{
        if(!isAdmin) return alert('Only Admin can add transactions.');
        const payload={'Date':tx.Date||new Date().toISOString(),'Type':tx.Type,'Category':tx.Category,'Sub-category':tx.Sub,'Amount':Number(tx.Amount||0)};
        await onCreate(payload); setOpenForm(false); setTx({Date:'',Type:'Credit',Category:'',Sub:'',Amount:''});
      };

      return (
        <Section>
          <BackBar title="Payments (Transactions)" onBack={onBack} />
          <div className="grid gap-4 md:grid-cols-2">
            <Stat label="Collected (credits)" value={INR.format(totals.paid)} />
            <Stat label="Debits" value={INR.format(totals.due)} />
          </div>
          {isAdmin && <div><button className="btn mt-2" onClick={()=>setOpenForm(v=>!v)}>‚ûï Add Transaction</button></div>}
          {isAdmin && openForm && (
            <div className="card p-5 mt-2">
              <div className="grid gap-3 md:grid-cols-2">
                <div><label className="block text-sm mb-1">Date</label><input className="w-full border rounded-xl p-2" type="date" value={tx.Date} onChange={e=>setTx({...tx,Date:e.target.value})} /></div>
                <div><label className="block text-sm mb-1">Type</label><select className="w-full border rounded-xl p-2" value={tx.Type} onChange={e=>setTx({...tx,Type:e.target.value})}><option>Credit</option><option>Debit</option></select></div>
                <div><label className="block text-sm mb-1">Category</label><input className="w-full border rounded-xl p-2" value={tx.Category} onChange={e=>setTx({...tx,Category:e.target.value})} /></div>
                <div><label className="block text-sm mb-1">Sub-category</label><input className="w-full border rounded-xl p-2" value={tx.Sub} onChange={e=>setTx({...tx,Sub:e.target.value})} /></div>
                <div className="md:col-span-2"><label className="block text-sm mb-1">Amount</label><input className="w-full border rounded-xl p-2" type="number" value={tx.Amount} onChange={e=>setTx({...tx,Amount:e.target.value})} /></div>
                <div className="md:col-span-2"><button className="btn" onClick={submit}>Save</button></div>
              </div>
            </div>
          )}

          <div className="card p-5 mt-2">
            <div className="font-medium mb-2">Transactions</div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>
                  {transactions.map((p,i)=> (
                    <tr key={i} className="border-t">
                      <td className="py-2 pr-4 whitespace-nowrap">{toDDMMYYYY(p['Date'])}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{p['Type']}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{p['Category']}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{p['Sub-category']}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">{INR.format(Number(p['Amount']||0))}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function OpeningBalances({rows,onBack}){
      const COLS=['Account','Amount'];
      const read=(r,k)=> r[k] ?? (k==='Account' ? (r['Account Name']||r['Name']) : (k==='Amount' ? (r['Opening Balance']||r['Amount']) : ''));
      return (
        <Section>
          <BackBar title="Opening Balances" onBack={onBack} />
          <div className="card p-5">
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>{rows.map((r,i)=> (<tr key={i} className="border-t"><td className="py-2 pr-4">{read(r,'Account')}</td><td className="py-2 pr-4 whitespace-nowrap">{INR.format(Number(read(r,'Amount')||0))}</td></tr>))}</tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function ChartOfAccounts({rows,onBack}){
      const COLS=['Code','Name','Type','Parent'];
      const read=(r,k)=> r[k] ?? ({'Code':r['Account Code'],'Name':r['Account Name'],'Type':r['Account Type'],'Parent':r['Parent']}[k]);
      return (
        <Section>
          <BackBar title="Chart of Accounts" onBack={onBack} />
          <div className="card p-5">
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>{rows.map((r,i)=> (<tr key={i} className="border-t">{COLS.map(h=> <td key={h} className="py-2 pr-4 whitespace-nowrap">{read(r,h)||''}</td>)}</tr>))}</tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function Documents({documents,onBack}){
      const COLS=['Serial Number','Subject','Date','Category','Link'];
      return (
        <Section>
          <BackBar title="Documents" onBack={onBack} />
          <div className="card p-5">
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>{documents.map((d,i)=> (<tr key={i} className="border-t"><td className="py-2 pr-4 whitespace-nowrap">{d['Serial Number']||i+1}</td><td className="py-2 pr-4">{d['Subject']||''}</td><td className="py-2 pr-4 whitespace-nowrap">{toDDMMYYYY(d['Date'])}</td><td className="py-2 pr-4 whitespace-nowrap">{d['Category']||''}</td><td className="py-2 pr-4 whitespace-nowrap">{d['Link']?<a className="underline" target="_blank" rel="noreferrer" href={d['Link']}>Open</a>:''}</td></tr>))}</tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function Voters({voters,onBack}){
      const COLS=['Tower No.','Flat No.','First Owner Name','Second Owner Name','Membership Card & Share Certificate No','Elegible Voter','Discrepency','Voted Earlier'];
      const read=(row,key)=>{ const aliases={ 'Tower No.':['Tower No.','Tower'], 'Flat No.':['Flat No.','Flat'], 'First Owner Name':['First Owner Name','Owner 1'], 'Second Owner Name':['Second Owner Name','Owner 2'], 'Membership Card & Share Certificate No':['Membership Card & Share Certificate No','Membership Card No','Share Certificate No'], 'Elegible Voter':['Elegible Voter','Eligible Voter'], 'Discrepency':['Discrepency','Discrepancy'], 'Voted Earlier':['Voted Earlier','VotedPreviously'] }; const keys=aliases[key]||[key]; for(const k of keys){ if(Object.prototype.hasOwnProperty.call(row,k)) return row[k]; } return '' };
      return (
        <Section>
          <BackBar title="Voters" onBack={onBack} />
          <div className="card p-5">
            <div className="font-medium">Voters list</div>
            <div className="text-xs text-gray-500 mb-3">Rendered exactly as per spreadsheet columns</div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>{voters.map((row,i)=> (<tr key={i} className="border-t">{COLS.map(h=> <td key={h} className="py-2 pr-4 whitespace-nowrap">{String(read(row,h)??'')}</td>)}</tr>))}</tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function Admin({users,session,onLogin,onLogout,onBack}){
      const [u,setU]=useState(''); const [p,setP]=useState('');
      return (
        <Section>
          <BackBar title="Admin" onBack={onBack} />
          {session.role!=='admin' ? (
            <div className="card p-5 max-w-md">
              <div className="font-medium mb-3">Admin login</div>
              <div className="grid gap-3">
                <div><label className="block text-sm mb-1">Username</label><input className="w-full border rounded-xl p-2" value={u} onChange={e=>setU(e.target.value)} /></div>
                <div><label className="block text-sm mb-1">Password</label><input type="password" className="w-full border rounded-xl p-2" value={p} onChange={e=>setP(e.target.value)} /></div>
                <div><button className="btn" onClick={()=>onLogin(u,p)}>Login</button></div>
              </div>
            </div>
          ) : (
            <div className="card p-5">
              <div className="flex items-center justify-between">
                <div className="font-medium">Logged in as <span className="mono">{session.username}</span> (Admin)</div>
                <button className="btn-secondary" onClick={onLogout}>Logout</button>
              </div>
              <div className="text-sm text-gray-500 mt-2">Use side navigation to manage data. Only Admin can post notices, raise/edit tickets, and view/add transactions.</div>
            </div>
          )}
        </Section>
      );
    }

    // Diagnostics
    function runTests(){ const results=[]; const t=(n,f)=>{try{f();results.push({name:n,pass:true});}catch(e){results.push({name:n,pass:false,err:String(e)})}}; t('currency format',()=>{ if(!INR.format(100).includes('‚Çπ')) throw new Error('INR not applied') }); t('date format',()=>{ if(toDDMMYYYY('2025-01-05')!=='05-01-2025') throw new Error('date fmt') }); return results; }
    function Diagnostics({baseUrl,lastError,mode,rerun,tests}){ const pass=tests.filter(x=>x.pass).length, fail=tests.length-pass; return (<div className="card p-4 text-sm"><div className="font-medium mb-1">Diagnostics</div><div>Society: <span className="mono">{SOCIETY_NAME}</span></div><div>Mode: <span className="mono">{mode}</span></div><div>BASE_URL: <code className="break-all mono">{baseUrl||'(empty)'}</code></div>{lastError && <div className="text-red-600 mt-1">Last error: {String(lastError)}</div>}<div className="text-xs text-gray-500 mt-2">Tests ‚Äî pass: {pass}, fail: {fail}</div>{fail>0 && <ul className="list-disc ml-5 mt-1 text-red-600">{tests.filter(x=>!x.pass).map((x,i)=>(<li key={i}>{x.name}: {x.err}</li>))}</ul>}<div className="text-xs text-gray-500 mt-1">Tip: override with <code>?gas=&lt;url&gt;</code> or force demo with <code>?demo=1</code></div><div className="mt-2 flex gap-2"><button className="btn" onClick={rerun}>Run connectivity tests</button><a className="btn-secondary" href="?demo=1">Open in Demo Mode</a></div></div>); }

    // =====================
    // App
    // =====================
    function App(){
      const [view,setView]=useState('dashboard');
      const [loading,setLoading]=useState(false);
      const [lastError,setLastError]=useState('');
      const [mode,setMode]=useState(FORCE_DEMO?'DEMO':'LIVE');
      const [tests,setTests]=useState(runTests());

      const [directory,setDirectory]=useState([]), [notices,setNotices]=useState([]), [tickets,setTickets]=useState([]), [transactions,setTransactions]=useState([]), [documents,setDocuments]=useState([]), [voters,setVoters]=useState([]), [openingBalances,setOpeningBalances]=useState([]), [chart,setChart]=useState([]), [users,setUsers]=useState([]);
      const [session,setSession]=useState({username:'guest',role:(new URLSearchParams(location.search).get('role'))||'user'});
      const [search,setSearch]=useState('');

      async function loadAll(){
        if(FORCE_DEMO || !BASE_URL){ useDemo(); return; }
        try{
          setLoading(true); setLastError('');
          // Warm-up ping (short timeout) to reduce cold-start latency
          try { await api('listIssues','GET',null,0); } catch(_) {}
          // Fetch everything, but don't fail the whole load on one slow/failed tab
          const calls = [
            ['dir', ()=>api('listDirectory')],
            ['nts', ()=>api('listNotices')],
            ['iss', ()=>api('listIssues')],
            ['txs', ()=>api('listTransactions')],
            ['docs', ()=>api('listDocuments')],
            ['vts', ()=>api('listVoters')],
            ['obs', ()=>api('listOpeningBalances')],
            ['coa', ()=>api('listChartOfAccounts')],
            ['usr', ()=>api('listUsers')],
          ];
          const settled = await Promise.allSettled(calls.map(([k,fn])=>fn()));
          const pick = (idx)=> settled[idx].status==='fulfilled' ? (settled[idx].value?.rows||[]) : [];
          setDirectory(pick(0));
          setNotices(pick(1));
          setTickets(pick(2));
          setTransactions(pick(3));
          setDocuments(pick(4));
          setVoters(pick(5));
          setOpeningBalances(pick(6));
          setChart(pick(7));
          setUsers(pick(8));
          const anyErr = settled.find(s=>s.status==='rejected');
          if(anyErr) setLastError(anyErr.reason||'Partial load ‚Äî some tabs timed out');
          setMode('LIVE');
        }catch(err){ setLastError(err); useDemo(); }
        finally{ setLoading(false); }
      }
        try{
          setLoading(true); setLastError('');
          const [dir,nts,iss,txs,docs,vts,obs,coa,us]=await Promise.all([
            api('listDirectory','GET',null,1),
            api('listNotices','GET',null,1),
            api('listIssues','GET',null,1),
            api('listTransactions','GET',null,1),
            api('listDocuments','GET',null,1),
            api('listVoters','GET',null,1),
            api('listOpeningBalances','GET',null,1).catch(()=>({rows:DEMO.OpeningBalances})),
            api('listChartOfAccounts','GET',null,1).catch(()=>({rows:DEMO.ChartOfAccounts})),
            api('listUsers','GET',null,1).catch(()=>({rows:DEMO.Users})),
          ]);
          setDirectory(dir?.rows||[]); setNotices(nts?.rows||[]); setTickets(iss?.rows||[]); setTransactions(txs?.rows||[]); setDocuments(docs?.rows||[]); setVoters(vts?.rows||[]); setOpeningBalances(obs?.rows||[]); setChart(coa?.rows||[]); setUsers(us?.rows||[]); setMode('LIVE');
        }catch(err){ setLastError(err); useDemo(); } finally{ setLoading(false); }
      }
      function useDemo(){ setDirectory(DEMO.Directory); setNotices(DEMO.Notices); setTickets(DEMO.Issues); setTransactions(DEMO.Transactions); setDocuments(DEMO.Documents); setVoters(DEMO.Voters); setOpeningBalances(DEMO.OpeningBalances); setChart(DEMO.ChartOfAccounts); setUsers(DEMO.Users); setMode('DEMO'); }
      useEffect(()=>{ loadAll(); },[]);

      function handleLogin(username,password){ const pool=users&&users.length?users:DEMO.Users; const m=pool.find(u=>(u.Username||'').toLowerCase()===String(username).toLowerCase() && String(u.Password||'')===String(password) && String(u.Active||'Yes').toLowerCase().startsWith('y')); if(m){ setSession({username:m.Username||username,role:(m.Role||'user').toLowerCase()}); alert('Logged in as '+(m.Username||username)); } else { alert('Invalid credentials'); } }
      function handleLogout(){ setSession({username:'guest',role:'user'}); }

      const residents = useMemo(()=> directory.map(r=>({ id:r.Serial??r.id??`${r.Name}-${r.Flat}`, Name:r.Name??r['First Owner Name']??'', Flat:r.Flat??`${r['Tower No.']||''}-${r['Flat No.']||''}`, Phone:r.Phone||r.Mobile||'', Email:r.Email||'', Photo:r.Photo||'' })),[directory]);
      const filteredResidents = useMemo(()=>{ const q=search.toLowerCase(); return residents.filter(r=>[r.Name,r.Flat,r.Phone,r.Email].some(v=>String(v||'').toLowerCase().includes(q))); },[search,residents]);

      const isAdmin = session.role==='admin';
      const writable = mode==='LIVE';

      return (
        <div className="max-w-7xl mx-auto p-4">
          <header className="sticky top-0 z-40 border-b bg-white/70 backdrop-blur mb-4">
            <div className="h-14 flex items-center justify-between">
              <div className="font-semibold text-lg">üè° {SOCIETY_NAME}</div>
              <div className="hidden md:flex gap-2">
                <input className="border rounded-xl px-3 py-2 w-80" placeholder="Search directory‚Ä¶" value={search} onChange={e=>setSearch(e.target.value)} />
                <button className="btn-secondary">Search</button>
              </div>
            </div>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-[220px_1fr] gap-4">
            <aside className="grid gap-2">
              {['dashboard','notices','tickets','directory','payments','openingBalances','chartOfAccounts','documents','voters','admin'].map(tab=> (
                <NavItem key={tab} label={tab.charAt(0).toUpperCase()+tab.slice(1)} active={view===tab} onClick={()=>setView(tab)} />
              ))}
              <Diagnostics baseUrl={BASE_URL} lastError={lastError} mode={mode} rerun={loadAll} tests={tests} />
            </aside>

            <main className="grid gap-4">
              {loading && <div className="text-sm text-gray-500">Loading from Google Sheets‚Ä¶</div>}
              {mode==='DEMO' && <Banner kind="error">Failed to reach backend. Running in Demo Mode so you can still try the app.</Banner>}
              {mode==='LIVE' && lastError && <Banner kind="error">Some data timed out. Page is using what loaded. Details: {String(lastError)}</Banner>}
              {view==='dashboard' && <Dashboard residents={residents} tickets={tickets} transactions={transactions} notices={notices} />}
              {view==='notices' && <Notices notices={notices} onCreate={async n=>{ if(!writable){alert('Demo Mode: write disabled'); return n;} const created=await api('createNotice','POST',n); setNotices(p=>[created,...p]); return created; }} writable={writable} isAdmin={isAdmin} onBack={()=>setView('dashboard')} />}
              {view==='tickets' && <Issues tickets={tickets} onCreate={async t=>{ if(!writable){alert('Demo Mode: write disabled'); return t;} const created=await api('createIssue','POST',t); setTickets(p=>[created,...p]); return created; }} writable={writable} isAdmin={isAdmin} onBack={()=>setView('dashboard')} />}
              {view==='directory' && <Directory rows={directory} onCreate={async r=>{ if(!writable){alert('Demo Mode: write disabled'); return r;} const created=await api('createDirectory','POST',r); setDirectory(p=>[...p, created]); return created; }} isAdmin={isAdmin} onBack={()=>setView('dashboard')} />}
              {view==='payments' && <Payments transactions={transactions} onCreate={async p=>{ if(!writable){alert('Demo Mode: write disabled'); return p;} const created=await api('createTransaction','POST',p); setTransactions(prev=>[...prev, created]); return created; }} isAdmin={isAdmin} onBack={()=>setView('dashboard')} />}
              {view==='openingBalances' && <OpeningBalances rows={openingBalances} onBack={()=>setView('dashboard')} />}
              {view==='chartOfAccounts' && <ChartOfAccounts rows={chart} onBack={()=>setView('dashboard')} />}
              {view==='documents' && <Documents documents={documents} onBack={()=>setView('dashboard')} />}
              {view==='voters' && <Voters voters={voters} onBack={()=>setView('dashboard')} />}
              {view==='admin' && <Admin users={users} session={session} onLogin={handleLogin} onLogout={handleLogout} onBack={()=>setView('dashboard')} />}
            </main>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

  <noscript><div class="p-8 text-center">‚ö†Ô∏è This app requires JavaScript. Please enable it.</div></noscript>
</body>
</html>
