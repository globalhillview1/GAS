<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Hillview — Society Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="assets/brand-mark.png" />

  <!-- Tailwind (no build step) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { ink: "#0f172a", mist: "#f8fafc", card: "#ffffff", border: "#e5e7eb" }
        }
      }
    };
  </script>

  <!-- React 18 UMD + Babel (JSX directly in the browser) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Configure your GAS Web App URL (override with ?gas=<url>) -->
  <script>
    window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";
  </script>

  <style>
    :root { --hdr: 64px; }
    .card { background: #fff; border:1px solid #e5e7eb; border-radius: 16px; }
    .btn  { background:#0f172a; color:#fff; border-radius:12px; padding:.65rem 1rem; }
    .btn-secondary { background:#f3f4f6; color:#0f172a; border-radius:12px; padding:.55rem .9rem; }
    .badge { font-size:.75rem; background:#f3f4f6; padding:.2rem .5rem; border-radius:.5rem; }

    /* Login animation */
    .login-bg {
      background: radial-gradient(1200px 600px at 10% 10%, rgba(125, 211, 252,.35), transparent 40%),
                  radial-gradient(900px 500px at 90% 10%, rgba(167, 139, 250,.35), transparent 45%),
                  radial-gradient(1000px 700px at 50% 90%, rgba(74, 222, 128,.35), transparent 40%),
                  #0b1220;
      animation: floaty 16s ease-in-out infinite alternate;
    }
    @keyframes floaty {
      0% { background-position: 0 0, 100% 0, 50% 100% }
      100% { background-position: 0 -40px, 100% -30px, 50% calc(100% + 40px) }
    }
    .logo-pulse { animation: pulseLogo 2.8s ease-in-out infinite; }
    @keyframes pulseLogo {
      0%,100%{ transform: scale(1); filter: drop-shadow(0 8px 20px rgba(59,130,246,.09)); }
      50%{ transform: scale(1.04); filter: drop-shadow(0 8px 28px rgba(167,139,250,.25)); }
    }
    .spin { border: 2px solid #fff; border-top-color: transparent; width: 14px; height: 14px; border-radius:50%; animation: s .9s linear infinite }
    @keyframes s { to { transform: rotate(360deg) } }

    /* sticky controls */
    .sticky-top { position: sticky; top: var(--hdr); z-index: 30; }
    header { position: sticky; top:0; z-index:40; height: var(--hdr); backdrop-filter: blur(10px) saturate(160%);
             background: rgba(255,255,255,.75); border-bottom:1px solid #e5e7eb; }
  </style>
</head>
<body class="bg-mist text-ink">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;

    // ---------- Config ----------
    const SOCIETY = "Global Hillview, Sec-11, Sohna, Gurgaon";
    const INR = new Intl.NumberFormat("en-IN", { style:"currency", currency:"INR", maximumFractionDigits:2 });
    const qs = new URLSearchParams(location.search);
    const GAS = (qs.get("gas") || window.ENV_GAS_URL || "").trim();

    // ---------- Utils ----------
    const parseDate = (v)=> v ? new Date(v) : null;
    const ddmmyyyy = (v)=> {
      const d = parseDate(v); if(!d || isNaN(d)) return "";
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      return `${dd}-${mm}-${d.getFullYear()}`;
    };
    const fmtDT = (d)=> {
      if(!d) return "";
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const HH = String(d.getHours()).padStart(2,"0");
      const MM = String(d.getMinutes()).padStart(2,"0");
      return `${dd}-${mm}-${d.getFullYear()} ${HH}:${MM}`;
    };

    async function fetchWithTimeout(url, opts={}, ms=30000){
      const ctl = new AbortController(); const id = setTimeout(()=>ctl.abort(), ms);
      try { return await fetch(url, { ...opts, signal: ctl.signal }); }
      finally { clearTimeout(id) }
    }
    async function postJSON(body){
      const res = await fetchWithTimeout(GAS, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
      return res.json();
    }
    const api = {
      async login(u,p){ return postJSON({ op:"login", username:u, password:p }); },
      async sessionInfo(token){ return postJSON({ op:"sessionInfo", token }); },
      async update(token, payload){ return postJSON({ op:"update", token, ...payload }); },
      async list(){
        const u = new URL(GAS); u.searchParams.set("mode","data");
        const r = await fetchWithTimeout(u, { cache:"no-store" });
        if(!r.ok) throw new Error(await r.text());
        return r.json();
      }
    };

    // ---------- UI atoms ----------
    const Btn = ({children, className="", ...rest}) => <button className={"btn "+className} {...rest}>{children}</button>;
    const Btn2 = ({children, className="", ...rest}) => <button className={"btn-secondary "+className} {...rest}>{children}</button>;

    // ---------- Login Screen (animated) ----------
    const Login = ({ onSuccess })=>{
      const [u,setU] = useState("");
      const [p,setP] = useState("");
      const [err,setErr] = useState("");
      const [busy,setBusy] = useState(false);

      async function go(){
        if(busy) return; setBusy(true); setErr("");
        try{
          const r = await api.login(u,p);
          if(r?.ok && r?.token){
            localStorage.setItem("session", r.token);
            onSuccess({ token: r.token, role: (r.role||"user").toLowerCase() });
          } else setErr(r?.error || "Invalid credentials");
        }catch(e){ setErr(String(e)); }
        finally{ setBusy(false); }
      }

      return (
        <div className="min-h-screen login-bg grid place-items-center p-6">
          <div className="w-full max-w-md">
            <div className="card p-6">
              <div className="flex items-center gap-3 mb-4">
                <img src="assets/logo.png" className="w-10 h-10 rounded-md logo-pulse" alt="logo"/>
                <div className="font-semibold">Global Hillview — Society Portal</div>
              </div>
              <div className="text-sm text-gray-500 mb-4">Sign in to continue</div>
              <div className="grid gap-3">
                <div>
                  <label className="text-sm text-gray-500">Username</label>
                  <input className="w-full border rounded-xl p-2 mt-1" value={u} onChange={e=>setU(e.target.value)} autoFocus/>
                </div>
                <div>
                  <label className="text-sm text-gray-500">Password</label>
                  <input className="w-full border rounded-xl p-2 mt-1" type="password" value={p} onChange={e=>setP(e.target.value)}/>
                </div>
                <Btn onClick={go} className="flex items-center gap-2 justify-center">
                  {busy && <span className="spin"></span>} <span>{busy ? "Signing in…" : "Sign in"}</span>
                </Btn>
                {err && <div className="text-red-600 text-sm">{err}</div>}
              </div>
            </div>
            <div className="flex items-center justify-between mt-3 text-white/70 text-xs px-1">
              <span>Backend: <code>{GAS || "(not set)"}</code></span>
              <span>Tip: use <code>?gas=&lt;url&gt;</code> to override</span>
            </div>
          </div>
        </div>
      );
    };

    // ---------- Header ----------
    const Header = ({user, onLogout})=>(
      <header>
        <div className="max-w-6xl mx-auto px-4 h-full flex items-center justify-between">
          <div className="flex items-center gap-3">
            <img src="assets/brand-mark.png" className="w-8 h-8 rounded-md" alt="brand"/>
            <div className="font-semibold">{SOCIETY}</div>
          </div>
          <div className="flex items-center gap-3">
            <span className="badge">Logged in: {user.role}</span>
            <Btn2 onClick={onLogout}>Logout</Btn2>
          </div>
        </div>
      </header>
    );

    // ---------- Dashboard (KPIs + Filters + Grid matching your GAS page) ----------
    function Dashboard({ rows, isAdmin, onUpdate }){
      const [from,setFrom]=useState(""); const [to,setTo]=useState("");
      const [tower,setTower]=useState(""); const [flat,setFlat]=useState("");
      const [issue,setIssue]=useState(""); const [status,setStatus]=useState(""); const [minRating,setMinRating]=useState("");

      const filtered = useMemo(()=>{
        let arr = rows.slice();
        const dFrom = from ? new Date(from) : null;
        const dTo = to ? new Date(to+"T23:59:59") : null;
        if(dFrom) arr = arr.filter(x => parseDate(x["Date and Time Raised"]) >= dFrom);
        if(dTo)   arr = arr.filter(x => parseDate(x["Date and Time Raised"]) <= dTo);
        if(tower) arr = arr.filter(x=> String(x["Tower"]||"").toLowerCase().includes(tower.toLowerCase()));
        if(flat)  arr = arr.filter(x=> String(x["Flat"]||"").toLowerCase().includes(flat.toLowerCase()));
        if(issue) arr = arr.filter(x=> String(x["Issue"]||"").toLowerCase().includes(issue.toLowerCase()) || String(x["Description"]||"").toLowerCase().includes(issue.toLowerCase()));
        if(status) arr = arr.filter(x=> String(x["Status"]||"").toLowerCase() === status.toLowerCase());
        if(minRating) arr= arr.filter(x=> Number(x["Feedback Rating"]||0) >= Number(minRating));
        return arr.map(r=>{
          const raised = parseDate(r["Date and Time Raised"]);
          const resolved = parseDate(r["Date and Time Resolved"]);
          return { ...r, __raised: raised, __resolved: resolved, __ms: (raised && resolved) ? (resolved - raised) : null };
        });
      },[rows,from,to,tower,flat,issue,status,minRating]);

      const kpi = useMemo(()=>{
        const total = filtered.length;
        const open = filtered.filter(x=>x["Status"]==="Open").length;
        const prog = filtered.filter(x=>x["Status"]==="InProgress").length;
        const res  = filtered.filter(x=>x["Status"]==="Resolved").length;
        const done = filtered.filter(x=>x.__ms!=null);
        const avg = done.length ? Math.round(done.reduce((a,b)=>a+b.__ms,0)/done.length) : 0;
        const mm = Math.round(avg/60000), h=Math.floor(mm/60), d=Math.floor(h/24);
        const ktime=`${d}d ${h%24}h ${mm%60}m`;
        const rating = filtered.length ? (filtered.reduce((a,b)=>a+Number(b["Feedback Rating"]||0),0)/filtered.length).toFixed(2) : "0.00";
        return { total, open, prog, res, ktime, rating };
      },[filtered]);

      const [sort,setSort]=useState({key:"Date and Time Raised",dir:"desc"});
      const sorted = useMemo(()=>{
        const s=filtered.slice();
        s.sort((a,b)=>{
          const k=sort.key;
          const av = k==="Time Taken" ? a.__ms : (k==="Date and Time Raised"? a.__raised : (k==="Date and Time Resolved"?a.__resolved : a[k]));
          const bv = k==="Time Taken" ? b.__ms : (k==="Date and Time Raised"? b.__raised : (k==="Date and Time Resolved"?b.__resolved : b[k]));
          if(av<bv) return sort.dir==="asc"?-1:1;
          if(av>bv) return sort.dir==="asc"? 1:-1;
          return 0;
        });
        return s;
      },[filtered,sort]);

      function th(lbl){
        const toggle=()=> setSort(s=>({key:lbl, dir: s.key===lbl && s.dir==="asc" ? "desc":"asc"}));
        const ind = sort.key===lbl ? (sort.dir==="asc"?" ▲":" ▼") : "";
        return <th className="whitespace-nowrap cursor-pointer" onClick={toggle}>{lbl}{ind}</th>;
      }

      async function saveStatus(id,val){ await onUpdate({ id, status:val }); }
      async function saveRemark(id,val){ await onUpdate({ id, remark:val }); }

      return (
        <div className="max-w-6xl mx-auto px-4 py-4">
          {/* KPIs */}
          <div className="grid md:grid-cols-6 gap-3">
            <div className="card p-4"><div className="text-xs text-gray-500 uppercase">Total</div><div className="text-2xl font-semibold">{kpi.total}</div></div>
            <div className="card p-4"><div className="text-xs text-gray-500 uppercase">Open</div><div className="text-2xl font-semibold">{kpi.open}</div></div>
            <div className="card p-4"><div className="text-xs text-gray-500 uppercase">In progress</div><div className="text-2xl font-semibold">{kpi.prog}</div></div>
            <div className="card p-4"><div className="text-xs text-gray-500 uppercase">Resolved</div><div className="text-2xl font-semibold">{kpi.res}</div></div>
            <div className="card p-4"><div className="text-xs text-gray-500 uppercase">Avg time</div><div className="text-2xl font-semibold">{kpi.ktime}</div></div>
            <div className="card p-4"><div className="text-xs text-gray-500 uppercase">Avg rating</div><div className="text-2xl font-semibold">{kpi.rating}</div></div>
          </div>

          {/* Filters */}
          <div className="card p-4 mt-3 grid md:grid-cols-7 gap-3">
            <div><div className="text-xs text-gray-500 mb-1">From</div><input type="date" className="border rounded-lg p-2 w-full" value={from} onChange={e=>setFrom(e.target.value)}/></div>
            <div><div className="text-xs text-gray-500 mb-1">To</div><input type="date" className="border rounded-lg p-2 w-full" value={to} onChange={e=>setTo(e.target.value)}/></div>
            <div><div className="text-xs text-gray-500 mb-1">Tower</div><input className="border rounded-lg p-2 w-full" value={tower} onChange={e=>setTower(e.target.value)} placeholder="T1 / Tower 1"/></div>
            <div><div className="text-xs text-gray-500 mb-1">Flat</div><input className="border rounded-lg p-2 w-full" value={flat} onChange={e=>setFlat(e.target.value)} placeholder="1204 / T1-1204"/></div>
            <div><div className="text-xs text-gray-500 mb-1">Issue contains</div><input className="border rounded-lg p-2 w-full" value={issue} onChange={e=>setIssue(e.target.value)} /></div>
            <div><div className="text-xs text-gray-500 mb-1">Status</div>
              <select className="border rounded-lg p-2 w-full" value={status} onChange={e=>setStatus(e.target.value)}>
                <option value="">Any</option><option>Open</option><option>InProgress</option><option>Resolved</option><option>Closed</option>
              </select>
            </div>
            <div><div className="text-xs text-gray-500 mb-1">Min rating</div>
              <select className="border rounded-lg p-2 w-full" value={minRating} onChange={e=>setMinRating(e.target.value)}>
                <option value="">Any</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              </select>
            </div>
          </div>

          {/* Grid */}
          <div className="overflow-auto mt-3 card">
            <table className="min-w-full text-sm">
              <thead className="border-b">
                <tr className="text-left">
                  {th("Tracking ID")}
                  {th("Date and Time Raised")}
                  {th("Tower")}
                  {th("Flat")}
                  {th("Issue")}
                  {th("Description")}
                  <th>Media</th>
                  {th("Status")}
                  {th("Redressal Remark")}
                  {th("User ID")}
                  {th("Date and Time Resolved")}
                  {th("Time Taken")}
                  {th("Feedback Rating")}
                </tr>
              </thead>
              <tbody>
                {sorted.map((r, i) => {
                  const id = r["Tracking ID"] || `row-${i}`;
                  const raised = fmtDT(r.__raised);
                  const resolved = fmtDT(r.__resolved);
                  const timeTaken = r.__ms!=null ? (()=>{ const m=Math.round(r.__ms/60000); const h=Math.floor(m/60); const d=Math.floor(h/24); return `${d}d ${h%24}h ${m%60}m`; })() : "";
                  return (
                    <tr key={id} className="border-t align-top">
                      <td className="whitespace-nowrap">{id}</td>
                      <td className="whitespace-nowrap">{raised}</td>
                      <td className="whitespace-nowrap">{r["Tower"]||""}</td>
                      <td className="whitespace-nowrap">{r["Flat"]||""}</td>
                      <td>{r["Issue"]||""}</td>
                      <td>{r["Description"]||""}</td>
                      <td className="whitespace-nowrap">
                        {r["Media URL"] ? <a className="text-blue-600 underline" href={r["Media URL"]} target="_blank" rel="noreferrer">Open</a> : ""}
                      </td>
                      <td className="whitespace-nowrap">
                        {isAdmin ? (
                          <select defaultValue={r["Status"]||"Open"} onChange={e=>onUpdate({ id, status:e.target.value })}>
                            <option>Open</option><option>InProgress</option><option>Resolved</option><option>Closed</option>
                          </select>
                        ) : (r["Status"]||"")}
                      </td>
                      <td style={{minWidth:220}}>
                        {isAdmin ? (
                          <div className="flex items-center gap-2">
                            <textarea className="border rounded-lg p-2 w-full" rows="2" defaultValue={r["Redressal Remark"]||""}></textarea>
                            <Btn2 onClick={e=>{
                              const val = e.currentTarget.parentElement.querySelector("textarea").value;
                              onUpdate({ id, remark: val });
                            }}>Save</Btn2>
                          </div>
                        ) : (r["Redressal Remark"]||"")}
                      </td>
                      <td className="whitespace-nowrap">{r["User ID"]||""}</td>
                      <td className="whitespace-nowrap">{resolved}</td>
                      <td className="whitespace-nowrap">{timeTaken}</td>
                      <td className="whitespace-nowrap">{r["Feedback Rating"]||""}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function App(){
      const [session,setSession] = useState({ token:null, role:null });
      const [rows,setRows] = useState([]);
      const isAdmin = session.role === "admin";

      useEffect(()=>{
        (async ()=>{
          const tok = new URLSearchParams(location.search).get("session") || localStorage.getItem("session");
          if(tok){
            try{
              const ok = await api.sessionInfo(tok);
              if(ok?.ok && ok?.info?.ok){
                setSession({ token: tok, role: (ok.info.role||"user").toLowerCase() });
              } else {
                localStorage.removeItem("session");
              }
            }catch(_){}
          }
          try{
            const data = await api.list();
            setRows(Array.isArray(data)?data:(data.rows||[]));
          }catch(e){ /* page still loads, login will fix CORS */ }
        })();
      },[]);

      async function update(payload){
        if(!session.token) return alert("Not authenticated");
        try{
          await api.update(session.token, payload);
          const data = await api.list(); setRows(Array.isArray(data)?data:(data.rows||[]));
        }catch(e){ alert(String(e)); }
      }
      function logout(){ localStorage.removeItem("session"); setSession({token:null, role:null}); }

      if(!session.token || !session.role){
        return <Login onSuccess={(s)=>{ setSession(s); api.list().then(d=>setRows(Array.isArray(d)?d:(d.rows||[]))); }} />
      }
      return (
        <>
          <Header user={{role:session.role}} onLogout={logout} />
          <Dashboard rows={rows} isAdmin={isAdmin} onUpdate={update} />
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
