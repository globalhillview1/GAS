<!-- Single-file, no-build index.html for GitHub Pages
     ‚úÖ React 18 UMD + Babel Standalone (runs directly on GH Pages)
     ‚úÖ No imports/TypeScript/bundler needed
     ‚úÖ Connects to your Google Apps Script backend
     ‚úÖ Robust fetch with timeout+retries, clear errors, and Demo Mode fallback
     ‚úÖ Admin login + role-based access (admin/user)
     ‚úÖ Admin-only: create Notice, raise Ticket (writes blocked for non-admin)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Hillview ‚Äî Society Portal</title>
  <meta name="description" content="Community management web app powered by Google Sheets (GAS backend)." />
  <link rel="icon" href="assets/brand-mark.png" />

  <!-- Tailwind (utility styles) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { background: '#f9fafb', foreground: '#111827' } } }
    }
  </script>

  <!-- React 18 UMD + Babel Standalone for in-browser JSX (no build step) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Configure your Google Apps Script endpoint here (can be overridden by ?gas=... or disabled via ?demo=1) -->
  <script>
    // IMPORTANT: use your *exec* URL here; you can still override with ?gas=<url>
    window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";
  </script>

  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); border:1px solid #e5e7eb; }
    .btn  { padding:.55rem 1rem; border-radius:.75rem; background:#111827; color:#fff; }
    .btn:hover { background:#0b0f1a; }
    .btn-secondary { padding:.5rem .75rem; border-radius:.75rem; background:#f3f4f6; color:#111827; }
    .btn-secondary:hover { background:#e5e7eb; }
    .badge { display:inline-flex; align-items:center; padding:.125rem .5rem; font-size:.75rem; border-radius:.5rem; background:#f3f4f6; color:#374151; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Login animation */
    .login-bg {
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(125, 211, 252,.35), transparent 40%),
        radial-gradient(900px 500px at 90% 10%, rgba(167, 139, 250,.35), transparent 45%),
        radial-gradient(1000px 700px at 50% 90%, rgba(74, 222, 128,.35), transparent 40%),
        #0b1220;
      animation: floaty 16s ease-in-out infinite alternate;
    }
    @keyframes floaty {
      0% { background-position: 0 0, 100% 0, 50% 100% }
      100% { background-position: 0 -40px, 100% -30px, 50% calc(100% + 40px) }
    }
    .spin { border: 2px solid #fff; border-top-color: transparent; width: 14px; height: 14px; border-radius:50%; animation: s .9s linear infinite }
    @keyframes s { to { transform: rotate(360deg) } }
  </style>
</head>
<body class="bg-background text-foreground">
  <div id="root" class="min-h-screen"></div>

  <!-- App Code (JSX compiled in the browser) -->
  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;

    // =====================
    // Config & Utilities
    // =====================
    const params = new URLSearchParams(location.search);
    const URL_OVERRIDE = params.get('gas');
    const FORCE_DEMO   = params.get('demo') === '1' || params.get('offline') === '1';
    const BASE_URL = (URL_OVERRIDE || (window.ENV_GAS_URL || '')).trim();

    const INR = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 });

    // Demo fallback data
    const DEMO = {
      Directory: [
        { Serial: 1, Name: 'Ayesha Khan',  Flat: 'A-302', Phone: '+91 98765 00001', Email: 'ayesha@example.com' },
        { Serial: 2, Name: 'Rohan Mehta',  Flat: 'B-1204', Phone: '+91 98765 00002', Email: 'rohan@example.com' },
      ],
      Notices: [
        { 'Serial Number': 1, Subject: 'Water shutdown on Friday', Date: '15-01-2025', Notice: 'Maintenance 10:00‚Äì12:00 Block B.' },
      ],
      Issues: [
        { 'Tracking ID': 'demo-101', 'Date and Time Raised': '2025-01-16T09:00:00Z', Tower: 'T1', Flat: '1204', Issue:'Lift not working', Description: 'Stuck at 7.', 'Media URL':'', Status: 'Open', 'Redressal Remark':'', 'User ID':'resident', 'Date and Time Resolved':'', 'Time Taken':'', 'Feedback Rating':'' },
      ],
      Documents: [ { 'Serial Number': 1, Subject: 'AGM Minutes', Date: '10-01-2025', Media: 'PDF', Link: '#', Category: 'Governance' } ],
      Transactions: [ { Date:'2025-01-01', Type:'Credit', Category:'Maintenance', 'Sub-category':'Monthly', Amount:1200 } ],
      Voters: [ { 'Tower No.':'T1', 'Flat No.':'1204', 'First Owner Name':'Mrs. SUNITA CHAWLA', 'Second Owner Name':'', 'Elegible Voter':'Yes', 'Voted Earlier':'Yes' } ],
    };

    // Helpers
    async function fetchWithTimeout(url, opts={}, timeoutMs=12000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try { return await fetch(url, { ...opts, signal: controller.signal }); }
      finally { clearTimeout(id); }
    }
    // Make POSTs "simple" for GAS (no CORS preflight)
    async function postPlain(body) {
      const res = await fetchWithTimeout(BASE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
      return res.json();
    }
    async function getJSON(action, extra={}) {
      const u = new URL(BASE_URL);
      u.searchParams.set('action', action);
      for (const [k,v] of Object.entries(extra)) u.searchParams.set(k,v);
      const r = await fetchWithTimeout(u, { cache:'no-store' });
      if (!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
      return r.json();
    }

    const api = {
      async login(username, password) {
        // Primary: POST simple
        try { return await postPlain({ op:'login', username, password }); }
        catch {
          // Fallback: GET ?action=login&u=&p=
          return getJSON('login', { u:username, p:password });
        }
      },
      async sessionInfo(token) { return postPlain({ op:'sessionInfo', token }); },
      async update(token, payload) { return postPlain({ op:'update', token, ...payload }); },

      async listAll() {
        const calls = await Promise.allSettled([
          getJSON('listDirectory'),
          getJSON('listNotices'),
          getJSON('listIssues'),
          getJSON('listTransactions'),
          getJSON('listDocuments'),
          getJSON('listVoters'),
        ]);
        const pick = (i)=> calls[i].status==='fulfilled' ? (calls[i].value?.rows||[]) : [];
        return {
          directory: pick(0), notices: pick(1), issues: pick(2),
          transactions: pick(3), documents: pick(4), voters: pick(5)
        };
      },

      async createNotice(row){ return postPlain({ action:'createNotice', ...row }); },
      async createIssue(row){ return postPlain({ action:'createIssue', ...row }); },
    };

    // UI atoms
    const NavItem = ({ label, active, onClick }) => (
      <button className={`btn-secondary text-left ${active ? 'ring-2 ring-gray-300' : ''}`} onClick={onClick}>{label}</button>
    );
    const Stat = ({ label, value }) => (
      <div className="card p-5"><div className="text-2xl font-semibold">{value}</div><div className="text-sm text-gray-500">{label}</div></div>
    );
    const Banner = ({ kind='info', children }) => {
      const cls = kind==='error' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-blue-50 text-blue-700 border-blue-200';
      return <div className={`border rounded-xl p-3 ${cls}`}>{children}</div>;
    };
    const Section = ({ children }) => <section className="grid gap-4">{children}</section>;

    // =====================
    // Login (animated)
    // =====================
    const Login = ({ onSuccess, lastBackend })=>{
      const [u,setU] = useState('');
      const [p,setP] = useState('');
      const [err,setErr] = useState('');
      const [busy,setBusy] = useState(false);

      async function go(){
        if(busy) return;
        setBusy(true); setErr('');
        try {
          const r = await api.login(u,p);
          if (r?.ok && r?.token) {
            localStorage.setItem('session', r.token);
            onSuccess({ token:r.token, role:(r.role||'user').toLowerCase(), username:r.username||u });
          } else setErr(r?.error || 'Invalid credentials');
        } catch(e){ setErr(String(e)); }
        finally { setBusy(false); }
      }

      return (
        <div className="login-bg grid place-items-center p-6">
          <div className="w-full max-w-md">
            <div className="card p-6">
              <div className="flex items-center gap-3 mb-4">
                <img src="assets/logo.png" className="w-10 h-10 rounded-md" alt="logo"/>
                <div className="font-semibold">Global Hillview ‚Äî Society Portal</div>
              </div>
              <div className="text-sm text-gray-500 mb-4">Sign in to continue</div>
              <div className="grid gap-3">
                <div>
                  <label className="text-sm text-gray-500">Username</label>
                  <input className="w-full border rounded-xl p-2 mt-1" value={u} onChange={e=>setU(e.target.value)} autoFocus/>
                </div>
                <div>
                  <label className="text-sm text-gray-500">Password</label>
                  <input className="w-full border rounded-xl p-2 mt-1" type="password" value={p} onChange={e=>setP(e.target.value)}/>
                </div>
                <button className="btn flex items-center gap-2 justify-center" onClick={go} disabled={busy}>
                  {busy && <span className="spin"></span>} <span>{busy ? 'Signing in‚Ä¶' : 'Sign in'}</span>
                </button>
                {err && <div className="text-red-600 text-sm">{err}</div>}
              </div>
            </div>
            <div className="flex items-center justify-between mt-3 text-white/70 text-xs px-1">
              <span>Backend: <code>{lastBackend || '(not set)'}</code></span>
              <span>Tip: <code>?gas=&lt;url&gt;</code> to override</span>
            </div>
          </div>
        </div>
      );
    };

    // =====================
    // Pages
    // =====================
    function Dashboard({ residents, tickets, transactions, notices }){
      const openTickets = tickets.filter(t => (t.Status||'').toLowerCase() !== 'closed').length;
      const due  = transactions.filter(t => (t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
      const paid = transactions.filter(t => (t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
      return (
        <Section>
          <div className="grid gap-4 md:grid-cols-3">
            <Stat label="Residents" value={residents.length} />
            <Stat label="Open issues" value={openTickets} />
            <Stat label="Net collected" value={INR.format(paid-due)} />
          </div>
          <div className="grid gap-4 md:grid-cols-2">
            <div className="card p-5">
              <div className="font-medium mb-1">Latest notices</div>
              <div className="text-xs text-gray-500 mb-3">From the "Notices" sheet</div>
              <div className="grid gap-2">
                {notices.slice(0,5).map((n,i)=> (
                  <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                    <div>
                      <div className="font-medium">{n['Subject']}</div>
                      <div className="text-xs text-gray-500">{n['Date']}</div>
                    </div>
                    <span className="badge">{n['Serial Number']||i+1}</span>
                  </div>
                ))}
              </div>
            </div>
            <div className="card p-5">
              <div className="font-medium mb-1">Open issues</div>
              <div className="text-xs text-gray-500 mb-3">From the "Issues" sheet</div>
              <div className="grid gap-2">
                {tickets.filter(t=>(t.Status||'').toLowerCase()!=='closed').slice(0,5).map((t,i)=> (
                  <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                    <div>
                      <div className="font-medium">{t['Issue']||t['Title']}</div>
                      <div className="text-xs text-gray-500">{t['Category']||''} ‚Ä¢ {t['Flat']||t['Flat No.']||''}</div>
                    </div>
                    <span className="badge">{t['Status']||'Open'}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </Section>
      );
    }

    function Notices({ notices, onCreate, canWrite }){
      const [subject, setSubject] = useState('');
      const [notice, setNotice]   = useState('');
      async function submit(){
        if(!subject || !canWrite) return;
        const row = { Subject:subject, Notice:notice, Date: new Date().toISOString().slice(0,10) };
        await onCreate(row);
        setSubject(''); setNotice('');
      }
      return (
        <Section>
          {!canWrite && <Banner kind="error">Only admin can post notices.</Banner>}
          {canWrite && (
            <div className="card p-5">
              <div className="font-medium">Post notice</div>
              <div className="text-xs text-gray-500 mb-4">Writes to the "Notices" sheet</div>
              <div className="grid gap-3">
                <div><label className="block text-sm mb-1">Subject</label><input className="w-full border rounded-xl p-2" value={subject} onChange={e=>setSubject(e.target.value)} placeholder="e.g., Water shutdown" /></div>
                <div><label className="block text-sm mb-1">Notice</label><textarea className="w-full border rounded-xl p-2" rows="4" value={notice} onChange={e=>setNotice(e.target.value)} placeholder="Details‚Ä¶"></textarea></div>
                <div><button className="btn" onClick={submit}>Publish</button></div>
              </div>
            </div>
          )}
          <div className="grid gap-3">
            {notices.map((n,i)=> (
              <div key={i} className="card p-4">
                <div className="flex items-center justify-between">
                  <div className="font-medium">{n['Subject']}</div>
                  <span className="badge">{n['Serial Number']||i+1}</span>
                </div>
                <div className="text-xs text-gray-500 mb-2">{n['Date']}</div>
                <div className="text-sm">{n['Notice']||''}</div>
              </div>
            ))}
          </div>
        </Section>
      );
    }

    function Issues({ tickets, onCreate, canWrite }){
      const [form,setForm]=useState({ Issue:'', Category:'Infrastructure', Flat:'', Description:'' });
      const submit=async()=>{
        if(!canWrite) return;
        if(!form.Issue || !form.Flat) return;
        const row = { ...form, Status:'Open', 'Date and Time Raised': new Date().toISOString() };
        await onCreate(row);
        setForm({ Issue:'', Category:'Infrastructure', Flat:'', Description:'' });
      };
      const categories=['Infrastructure','Plumbing','Electrical','Housekeeping','Security'];
      return (
        <Section>
          {!canWrite && <Banner kind="error">Only admin can raise tickets.</Banner>}
          {canWrite && (
            <div className="card p-5">
              <div className="font-medium">Raise an issue</div>
              <div className="text-xs text-gray-500 mb-4">Writes to the "Issues" sheet</div>
              <div className="grid gap-3 md:grid-cols-2">
                <div><label className="block text-sm mb-1">Issue</label><input className="w-full border rounded-xl p-2" value={form.Issue} onChange={e=>setForm({...form,Issue:e.target.value})} placeholder="Short summary" /></div>
                <div><label className="block text-sm mb-1">Category</label><select className="w-full border rounded-xl p-2" value={form.Category} onChange={e=>setForm({...form,Category:e.target.value})}>{categories.map(c=><option key={c}>{c}</option>)}</select></div>
                <div><label className="block text-sm mb-1">Flat</label><input className="w-full border rounded-xl p-2" value={form.Flat} onChange={e=>setForm({...form,Flat:e.target.value})} placeholder="e.g., T1-1204" /></div>
                <div className="md:col-span-2"><label className="block text-sm mb-1">Description</label><input className="w-full border rounded-xl p-2" value={form.Description} onChange={e=>setForm({...form,Description:e.target.value})} placeholder="Optional" /></div>
                <div className="md:col-span-2"><button className="btn" onClick={submit}>Submit</button></div>
              </div>
            </div>
          )}
          <div className="card p-5 mt-3">
            <div className="font-medium mb-2">All Issues</div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">
                  {['Tracking ID','Date and Time Raised','Tower','Flat','Issue','Description','Media URL','Status','Redressal Remark','User ID','Date and Time Resolved','Time Taken','Feedback Rating'].map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}
                </tr></thead>
                <tbody>
                  {tickets.map((t,i)=> (
                    <tr key={i} className="border-t align-top">
                      {['Tracking ID','Date and Time Raised','Tower','Flat','Issue','Description','Media URL','Status','Redressal Remark','User ID','Date and Time Resolved','Time Taken','Feedback Rating'].map(h=>{
                        const v=t[h]||''; return <td key={h} className="py-2 pr-4 whitespace-nowrap">{String(v)}</td>;
                      })}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    function Directory({ residents }){
      return (
        <Section>
          <div className="card p-5">
            <div className="font-medium">Residents directory</div>
            <div className="text-xs text-gray-500 mb-4">From the "Directory" sheet</div>
            <div className="grid gap-3">
              {residents.map(r=>(
                <div key={r.id} className="flex flex-col md:flex-row md:items-center justify-between gap-3 border rounded-2xl p-4">
                  <div>
                    <div className="font-medium">{r.name} <span className="badge ml-2">{r.flat}</span></div>
                    <div className="flex flex-wrap gap-4 text-sm text-gray-600 mt-1">
                      {r.phone && <span>üìû {r.phone}</span>}
                      {r.email && <span>‚úâÔ∏è {r.email}</span>}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Payments({ transactions }){
      const totals=useMemo(()=>{
        const paid=transactions.filter(t=>(t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
        const due =transactions.filter(t=>(t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
        return {paid,due};
      },[transactions]);
      return (
        <Section>
          <div className="grid gap-4 md:grid-cols-2">
            <Stat label="Collected (credits)" value={INR.format(totals.paid)} />
            <Stat label="Debits" value={INR.format(totals.due)} />
          </div>
          <div className="card p-5 mt-2">
            <div className="font-medium">Transactions</div>
            <div className="text-xs text-gray-500 mb-3">From the "Transactions" sheet</div>
            <div className="grid gap-2">
              {transactions.map((p,i)=> (
                <div key={i} className="grid md:grid-cols-6 gap-2 items-center border rounded-2xl p-3 text-sm">
                  <div className="font-medium md:col-span-2">{p['Date']}</div>
                  <div>{p['Type']}</div>
                  <div>{p['Category']}</div>
                  <div>{p['Sub-category']}</div>
                  <div className="md:text-right">{INR.format(Number(p['Amount']||0))}</div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Documents({ documents }){
      return (
        <Section>
          <div className="card p-5">
            <div className="font-medium">Documents</div>
            <div className="text-xs text-gray-500 mb-3">From the "Documents" sheet</div>
            <div className="grid gap-2">
              {documents.map((d,i)=> (
                <div key={i} className="flex items-center justify-between border rounded-2xl p-4">
                  <div>
                    <div className="font-medium">{d['Subject']}</div>
                    <div className="text-xs text-gray-500">{d['Date']} ‚Ä¢ {d['Category']}</div>
                  </div>
                  {d['Link'] && <a className="underline" target="_blank" rel="noreferrer" href={d['Link']}>Open</a>}
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Voters({ voters }){
      const COLS=['Tower No.','Flat No.','First Owner Name','Second Owner Name','Membership Card & Share Certificate No','Elegible Voter','Discrepency','Voted Earlier'];
      return (
        <Section>
          <div className="card p-5">
            <div className="font-medium">Voters list</div>
            <div className="text-xs text-gray-500 mb-3">From the "Voters" sheet</div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead><tr className="text-left text-gray-600">{COLS.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}</tr></thead>
                <tbody>{voters.map((row,i)=> (<tr key={i} className="border-t">{COLS.map(h=> <td key={h} className="py-2 pr-4 whitespace-nowrap">{String(row[h]??'')}</td>)}</tr>))}</tbody>
              </table>
            </div>
          </div>
        </Section>
      );
    }

    // Diagnostics
    function runTests(){
      const results=[]; const t=(n,f)=>{try{f();results.push({name:n,pass:true});}catch(e){results.push({name:n,pass:false,err:String(e)})}};
      t('currency INR',()=>{ if(!INR.format(100).includes('‚Çπ')) throw new Error('INR not applied'); });
      t('demo notices exist',()=>{ if(!DEMO.Notices?.length) throw new Error('no demo notices'); });
      return results;
    }
    function Diagnostics({ baseUrl, lastError, mode, rerun, tests }){
      const pass=tests.filter(x=>x.pass).length, fail=tests.length-pass;
      return (<div className="card p-4 text-sm"><div className="font-medium mb-1">Diagnostics</div><div>Mode: <span className="mono">{mode}</span></div><div>BASE_URL: <code className="break-all mono">{baseUrl||'(empty)'}</code></div>{lastError && <div className="text-red-600 mt-1">Last error: {String(lastError)}</div>}<div className="text-xs text-gray-500 mt-2">Tests ‚Äî pass: {pass}, fail: {fail}</div>{fail>0 && <ul className="list-disc ml-5 mt-1 text-red-600">{tests.filter(x=>!x.pass).map((x,i)=>(<li key={i}>{x.name}: {x.err}</li>))}</ul>}<div className="text-xs text-gray-500 mt-1">Tip: override with <code>?gas=&lt;url&gt;</code> or force demo with <code>?demo=1</code></div><div className="mt-2 flex gap-2"><button className="btn" onClick={rerun}>Run connectivity tests</button><a className="btn-secondary" href="?demo=1">Open in Demo Mode</a></div></div>);
    }

    // =====================
    // App
    // =====================
    function App(){
      const [view,setView]=useState('dashboard');
      const [loading,setLoading]=useState(false);
      const [lastError,setLastError]=useState('');
      const [mode,setMode]=useState(FORCE_DEMO?'DEMO':'LIVE');
      const [tests,setTests]=useState(runTests());

      const [directory,setDirectory]=useState([]);
      const [notices,setNotices]=useState([]);
      const [tickets,setTickets]=useState([]);
      const [transactions,setTransactions]=useState([]);
      const [documents,setDocuments]=useState([]);
      const [voters,setVoters]=useState([]);

      const [session,setSession]=useState({ token:null, role:null, username:null });

      // Load session if present
      useEffect(()=>{
        const tok = params.get('session') || localStorage.getItem('session');
        if(tok){
          api.sessionInfo(tok).then(res=>{
            if(res?.ok){
              setSession({ token:tok, role:(res.role||'user').toLowerCase(), username:res.username||'user' });
            }else{
              localStorage.removeItem('session');
            }
          }).catch(()=>{ /* ignore */ });
        }
      },[]);

      async function loadAll(){
        if(FORCE_DEMO || !BASE_URL){ useDemo(); return; }
        try{
          setLoading(true); setLastError('');
          const data = await api.listAll();
          setDirectory(data.directory); setNotices(data.notices); setTickets(data.issues); setTransactions(data.transactions); setDocuments(data.documents); setVoters(data.voters);
          setMode('LIVE');
        }catch(err){ setLastError(err); useDemo(); }
        finally{ setLoading(false); }
      }
      function useDemo(){ setDirectory(DEMO.Directory); setNotices(DEMO.Notices); setTickets(DEMO.Issues); setTransactions(DEMO.Transactions); setDocuments(DEMO.Documents); setVoters(DEMO.Voters); setMode('DEMO'); }
      useEffect(()=>{ loadAll(); },[]);

      const residents = useMemo(()=> directory.map(r=>({
        id: r.Serial ?? r.id ?? `${r.Name}-${r.Flat}`,
        name: r.Name ?? r['First Owner Name'] ?? '',
        flat: r.Flat ?? `${r['Tower No.']||''}-${r['Flat No.']||''}`,
        phone: r.Phone || r.Mobile || '',
        email: r.Email || '',
      })),[directory]);

      const isAdmin = (session.role === 'admin');
      const canWrite = (mode==='LIVE' && isAdmin);

      function logout(){ localStorage.removeItem('session'); setSession({token:null,role:null,username:null}); }

      // Gate: if no session, show login page first (still allows demo via ?demo=1)
      if(!session.token || !session.role){
        return <Login onSuccess={(s)=>{ setSession(s); loadAll(); }} lastBackend={BASE_URL} />;
      }

      return (
        <div className="max-w-7xl mx-auto p-4">
          <header className="sticky top-0 z-40 border-b bg-white/70 backdrop-blur mb-4">
            <div className="h-14 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <img src="assets/brand-mark.png" className="w-8 h-8 rounded-md" alt="brand"/>
                <div className="font-semibold">Global Hillview, Sec-11, Sohna, Gurgaon</div>
              </div>
              <div className="flex items-center gap-2">
                <span className="badge">Logged in: {session.role}</span>
                <button className="btn-secondary" onClick={logout}>Logout</button>
              </div>
            </div>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-[220px_1fr] gap-4">
            <aside className="grid gap-2">
              {['dashboard','notices','tickets','directory','payments','documents','voters'].map(tab=> (
                <NavItem key={tab} label={tab.charAt(0).toUpperCase()+tab.slice(1)} active={view===tab} onClick={()=>setView(tab)} />
              ))}
              <Diagnostics baseUrl={BASE_URL} lastError={lastError} mode={mode} rerun={loadAll} tests={tests} />
            </aside>

            <main className="grid gap-4">
              {loading && <div className="text-sm text-gray-500">Loading from Google Sheets‚Ä¶</div>}
              {mode==='DEMO' && <Banner kind="error">Failed to reach backend. Running in Demo Mode so you can still try the app.</Banner>}

              {view==='dashboard' && <Dashboard residents={residents} tickets={tickets} transactions={transactions} notices={notices} />}

              {view==='notices' && (
                <Notices
                  notices={notices}
                  canWrite={canWrite}
                  onCreate={async row=>{
                    if(!canWrite){ alert('Only admin can post notices.'); return; }
                    const created = await api.createNotice(row);
                    // Reload to reflect spreadsheet append
                    loadAll();
                    return created;
                  }}
                />
              )}

              {view==='tickets' && (
                <Issues
                  tickets={tickets}
                  canWrite={canWrite}
                  onCreate={async row=>{
                    if(!canWrite){ alert('Only admin can raise tickets.'); return; }
                    const created = await api.createIssue(row);
                    loadAll();
                    return created;
                  }}
                />
              )}

              {view==='directory' && <Directory residents={residents} />}
              {view==='payments'  && <Payments transactions={transactions} />}
              {view==='documents' && <Documents documents={documents} />}
              {view==='voters'    && <Voters voters={voters} />}
            </main>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <noscript>
    <div class="p-8 text-center">‚ö†Ô∏è This app requires JavaScript. Please enable it.</div>
  </noscript>
</body>
</html>
