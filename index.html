<!-- Single-file, no-build index.html for GitHub Pages
     ‚úÖ React 18 UMD + Babel Standalone (runs directly on GH Pages)
     ‚úÖ No imports/TypeScript/bundler needed
     ‚úÖ Connects to your Google Apps Script backend
     ‚úÖ Robust fetch with timeout+retries, clear errors, and Demo Mode fallback
     ‚úÖ FIX: Babel presets (env,react) prevent JSX parse errors
     ‚úÖ Admin vs User roles; Payments visible to Admin only
     ‚úÖ Pages map to sheet tabs: Issues, Transactions, OpeningBalances, ChartOfAccounts, Voters, Directory, Notices
     ‚úÖ "Back" button on sub-pages
     ‚úÖ Currency: INR (‚Çπ)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Global Hillview, Sec-11, Sohna, Gurgaon ‚Äî Society Portal</title>
  <meta name="description" content="Community management web app powered by Google Sheets (GAS backend)." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%8F%A1%3C/text%3E%3C/svg%3E" />

  <!-- Tailwind (utility styles) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { background: '#f9fafb', foreground: '#111827' } } }
    }
  </script>

  <!-- React 18 UMD + Babel Standalone for in-browser JSX (no build step) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Configure your Google Apps Script endpoint here (can be overridden by ?gas=... or disabled via ?demo=1) -->
  <script>
    // IMPORTANT: Keep this value or override via the URL param `?gas=...`
    window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";
  </script>

  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); border:1px solid #e5e7eb; }
    .btn  { padding:.5rem 1rem; border-radius:.75rem; background:#111827; color:#fff; }
    .btn:hover { background:#0b0f1a; }
    .btn-secondary { padding:.5rem .75rem; border-radius:.75rem; background:#f3f4f6; color:#111827; }
    .btn-secondary:hover { background:#e5e7eb; }
    .badge { display:inline-flex; align-items:center; padding:.125rem .5rem; font-size:.75rem; border-radius:.5rem; background:#f3f4f6; color:#374151; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-background text-foreground">
  <div id="root" class="min-h-screen"></div>

  <!-- App Code (JSX compiled in the browser) -->
  <!-- IMPORTANT: data-presets enables JSX transpilation (react) + modern JS (env) -->
  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;

    // =====================
    // Config & Utilities
    // =====================
    const SOCIETY_NAME = 'Global Hillview, Sec-11, Sohna, Gurgaon';
    document.title = SOCIETY_NAME + ' ‚Äî Society Portal';

    const params = new URLSearchParams(location.search);
    const URL_OVERRIDE = params.get('gas');
    const FORCE_DEMO   = params.get('demo') === '1' || params.get('offline') === '1';
    const BASE_URL = (URL_OVERRIDE || (window.ENV_GAS_URL || '')).trim();

    const INR = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 2 });

    const DEMO = {
      Directory: [
        { Serial: 1, Name: 'Ayesha Khan',  Flat: 'A-302', Phone: '+91 98765 00001', Email: 'ayesha@example.com' },
        { Serial: 2, Name: 'Rohan Mehta',  Flat: 'B-1204', Phone: '+91 98765 00002', Email: 'rohan@example.com' },
        { Serial: 3, Name: 'Sofia Keller', Flat: 'C-803', Phone: '+91 98765 00003', Email: 'sofia@example.com' }
      ],
      Notices: [
        { 'Serial Number': 1, Subject: 'Water shutdown on Friday', Date: '2025-01-15', Notice: 'Maintenance from 10:00‚Äì12:00 in Block B.' },
        { 'Serial Number': 2, Subject: 'Diwali Fest ‚Äì Community Hall', Date: '2025-01-16', Notice: 'Potluck & games this Saturday 18:30.' }
      ],
      Issues: [
        { 'Tracking ID': 'demo-101', 'Date and Time Raised': '2025-01-16T09:00:00Z', Tower: 'T1', Flat: '1204', Title: 'Lift not working', Category: 'Infrastructure', Description: 'Lift stuck at floor 7.', Status: 'Open' },
        { 'Tracking ID': 'demo-102', 'Date and Time Raised': '2025-01-16T09:15:00Z', Tower: 'T5', Flat: '505', Title: 'Water leakage', Category: 'Plumbing', Description: 'Leak in kitchen sink.', Status: 'In Progress' }
      ],
      Documents: [
        { 'Serial Number': 1, Subject: 'AGM Minutes', Date: '2025-01-10', Media: 'PDF', Link: '#', Category: 'Governance' }
      ],
      Transactions: [
        { Date: '2025-01-01', Type: 'Credit', Category: 'Maintenance', 'Sub-category': 'Monthly', Amount: 1200 },
        { Date: '2025-01-01', Type: 'Debit',  Category: 'Clubhouse',  'Sub-category': 'Snacks',  Amount: 250 }
      ],
      OpeningBalances: [
        { Account: 'Maintenance Fund', Amount: 100000 },
        { Account: 'Corpus Fund', Amount: 250000 }
      ],
      ChartOfAccounts: [
        { Code: '1001', Name: 'Cash', Type: 'Asset' },
        { Code: '4001', Name: 'Maintenance Income', Type: 'Income' }
      ],
      Voters: [
        { 'Tower No.': 'T1', 'Flat No.': '1204', 'First Owner Name': 'Mrs. SUNITA CHAWLA', 'Second Owner Name': '' }
      ],
      Users: [
        { Username: 'admin', Password: 'admin', Role: 'admin', Active: 'Yes' },
        { Username: 'resident', Password: 'resident', Role: 'user', Active: 'Yes' }
      ]
    };

    // Fetch with timeout + retries to avoid hanging "Failed to fetch" and surface CORS issues clearly
    async function fetchWithTimeout(url, opts={}, timeoutMs=10000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try { return await fetch(url, { ...opts, signal: controller.signal }); }
      finally { clearTimeout(id); }
    }

    async function api(action, method='GET', payload, retries=1) {
      if (!BASE_URL) throw new Error('Missing BASE_URL');
      const url = new URL(BASE_URL);
      url.searchParams.set('action', action);

      // IMPORTANT: Avoid CORS preflight to Google Apps Script by
      //  ‚Ä¢ not sending Content-Type for GET
      //  ‚Ä¢ using text/plain for POST (GAS reads e.postData.contents)
      const headers = method === 'POST' ? { 'Content-Type': 'text/plain;charset=utf-8' } : {};
      const opts = { method, headers };
      if (method === 'POST' && payload) opts.body = JSON.stringify(payload);

      let lastErr;
      for (let i=0; i<=retries; i++) {
        try {
          const res = await fetchWithTimeout(url.toString(), opts, 12000);
          if (!res.ok) throw new Error(await res.text());
          return await res.json();
        } catch (e) {
          lastErr = e;
          if (i === retries) throw e;
          await new Promise(r => setTimeout(r, 600 * (i+1)));
        }
      }
      throw lastErr;
    }

    function NavItem({ label, active, onClick }) {
      return (
        <button className={`btn-secondary text-left ${active ? 'ring-2 ring-gray-300' : ''}`} onClick={onClick}>{label}</button>
      );
    }

    function Stat({ label, value }) {
      return (
        <div className="card p-5">
          <div className="text-2xl font-semibold">{value}</div>
          <div className="text-sm text-gray-500">{label}</div>
        </div>
      );
    }

    function Banner({ kind='info', children }) {
      const cls = kind==='error' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-blue-50 text-blue-700 border-blue-200';
      return <div className={`border rounded-xl p-3 ${cls}`}>{children}</div>;
    }

    function Section({ children }) { return <section className="grid gap-4">{children}</section>; }

    // Reusable Back bar
    function BackBar({ title, onBack }) {
      return (
        <div className="flex items-center gap-2">
          <button className="btn-secondary" onClick={onBack}>‚Üê Back</button>
          <div className="text-sm text-gray-500">{title}</div>
        </div>
      );
    }

    // =====================
    // Pages
    // =====================
    function Dashboard({ residents, tickets, transactions, notices }) {
      const openTickets = tickets.filter(t => String(t.Status||t.status||'').toLowerCase() !== 'closed').length;
      const totalDue  = transactions.filter(t => String(t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
      const totalPaid = transactions.filter(t => String(t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
      return (
        <Section>
          <div className="grid gap-4 md:grid-cols-3">
            <Stat label="Residents" value={residents.length} />
            <Stat label="Open issues" value={openTickets} />
            <Stat label="Net collected" value={INR.format(totalPaid-totalDue)} />
          </div>
          <div className="grid gap-4 md:grid-cols-2">
            <div className="card p-5">
              <div className="font-medium mb-1">Latest notices</div>
              <div className="text-xs text-gray-500 mb-3">From the "Notices" sheet</div>
              <div className="grid gap-2">
                {notices.slice(0,5).map((n,i)=> (
                  <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                    <div>
                      <div className="font-medium">{n['Subject']||n.title}</div>
                      <div className="text-xs text-gray-500">{n.Date||n.createdAt}</div>
                    </div>
                    <span className="badge">{n['Serial Number']||n.id||''}</span>
                  </div>
                ))}
              </div>
            </div>
            <div className="card p-5">
              <div className="font-medium mb-1">Open issues</div>
              <div className="text-xs text-gray-500 mb-3">From the "Issues" sheet</div>
              <div className="grid gap-2">
                {tickets.filter(t=>String(t.Status||'').toLowerCase()!=='closed').slice(0,5).map((t,i)=> (
                  <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                    <div>
                      <div className="font-medium">{t['Title']||t['Category']}</div>
                      <div className="text-xs text-gray-500">{t['Category']} ‚Ä¢ {t['Flat']||t['Flat No.']||''}</div>
                    </div>
                    <span className="badge">{t['Status']||'Open'}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </Section>
      );
    }

    function Notices({ notices, onCreate, writable, onBack }) {
      const [subject, setSubject] = useState('');
      const [notice, setNotice]   = useState('');
      async function submit(){
        if(!subject) return;
        const created = await onCreate({ Subject: subject, Notice: notice, Date: new Date().toLocaleDateString() });
        setSubject(''); setNotice('');
        return created;
      }
      return (
        <Section>
          <BackBar title="Notices" onBack={onBack} />
          {!writable && <Banner kind="error">Demo Mode: write actions are disabled because the backend could not be reached.</Banner>}
          <div className="card p-5">
            <div className="font-medium">Post notice</div>
            <div className="text-xs text-gray-500 mb-4">Writes to the "Notices" sheet</div>
            <div className="grid gap-3">
              <div>
                <label className="block text-sm mb-1">Subject</label>
                <input className="w-full border rounded-xl p-2" value={subject} onChange={e=>setSubject(e.target.value)} placeholder="e.g., Water shutdown" />
              </div>
              <div>
                <label className="block text-sm mb-1">Notice</label>
                <textarea className="w-full border rounded-xl p-2" rows="4" value={notice} onChange={e=>setNotice(e.target.value)} placeholder="Details‚Ä¶"></textarea>
              </div>
              <div><button className="btn" onClick={submit} disabled={!writable}>Publish</button></div>
            </div>
          </div>
          <div className="grid gap-3">
            {notices.map((n,i)=> (
              <div key={i} className="card p-4">
                <div className="flex items-center justify-between">
                  <div className="font-medium">{n['Subject']}</div>
                  <span className="badge">{n['Serial Number']||i+1}</span>
                </div>
                <div className="text-xs text-gray-500 mb-2">{n['Date']}</div>
                <div className="text-sm">{n['Notice']||''}</div>
              </div>
            ))}
          </div>
        </Section>
      );
    }

    function Issues({ tickets, onCreate, writable, onBack }) {
      const [title, setTitle] = useState('');
      const [category, setCategory] = useState('Infrastructure');
      const [flat, setFlat] = useState('');
      const [description, setDescription] = useState('');

      async function submit(){
        if(!title || !flat) return;
        await onCreate({ Title: title, Category: category, Flat: flat, Description: description, Status: 'Open', 'Date and Time Raised': new Date().toISOString() });
        setTitle(''); setFlat(''); setDescription(''); setCategory('Infrastructure');
      }

      const categories = ['Infrastructure','Plumbing','Electrical','Housekeeping','Security'];

      return (
        <Section>
          <BackBar title="Tickets (Issues)" onBack={onBack} />
          {!writable && <Banner kind="error">Demo Mode: write actions are disabled because the backend could not be reached.</Banner>}
          <div className="card p-5">
            <div className="font-medium">Raise an issue</div>
            <div className="text-xs text-gray-500 mb-4">Writes to the "Issues" sheet</div>
            <div className="grid gap-3">
              <div>
                <label className="block text-sm mb-1">Title</label>
                <input className="w-full border rounded-xl p-2" value={title} onChange={e=>setTitle(e.target.value)} placeholder="Short summary" />
              </div>
              <div>
                <label className="block text-sm mb-1">Category</label>
                <select className="w-64 border rounded-xl p-2" value={category} onChange={e=>setCategory(e.target.value)}>
                  {categories.map(c=> <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              <div className="grid md:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">Flat</label>
                  <input className="w-full border rounded-xl p-2" value={flat} onChange={e=>setFlat(e.target.value)} placeholder="e.g., A-302" />
                </div>
                <div>
                  <label className="block text-sm mb-1">Details</label>
                  <input className="w-full border rounded-xl p-2" value={description} onChange={e=>setDescription(e.target.value)} placeholder="Optional" />
                </div>
              </div>
              <div><button className="btn" onClick={submit} disabled={!writable}>Submit</button></div>
            </div>
          </div>
          <div className="grid gap-3 mt-3">
            {tickets.map((t,i)=> (
              <div key={i} className="card p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium">{t['Title']||t['Category']}</div>
                    <div className="text-xs text-gray-500">{t['Category']} ‚Ä¢ {t['Flat']}</div>
                  </div>
                  <span className="badge">{t['Status']}</span>
                </div>
                {t['Description'] && <div className="text-sm text-gray-600 mt-1">{t['Description']}</div>}
              </div>
            ))}
          </div>
        </Section>
      );
    }

    function Directory({ residents, onBack }) {
      return (
        <Section>
          <BackBar title="Directory" onBack={onBack} />
          <div className="card p-5">
            <div className="font-medium">Residents directory</div>
            <div className="text-xs text-gray-500 mb-4">From the "Directory" sheet</div>
            <div className="grid gap-3">
              {residents.map(r => (
                <div key={r.id} className="flex flex-col md:flex-row md:items-center justify-between gap-3 border rounded-2xl p-4">
                  <div>
                    <div className="font-medium">{r.name} <span className="badge ml-2">{r.flat}</span></div>
                    <div className="flex flex-wrap gap-4 text-sm text-gray-600 mt-1">
                      {r.phone && <span>üìû {r.phone}</span>}
                      {r.email && <span>‚úâÔ∏è {r.email}</span>}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Payments({ transactions, canView, onBack }) {
      const totals = useMemo(()=>{
        const paid = transactions.filter(t=>String(t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
        const due  = transactions.filter(t=>String(t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
        return { paid, due };
      }, [transactions]);
      if(!canView) return (<Section><BackBar title="Payments (Transactions)" onBack={onBack} /><Banner kind="error">Access restricted. Payments are visible to Admin only.</Banner></Section>);
      return (
        <Section>
          <BackBar title="Payments (Transactions)" onBack={onBack} />
          <div className="grid gap-4 md:grid-cols-2">
            <Stat label="Collected (credits)" value={INR.format(totals.paid)} />
            <Stat label="Debits" value={INR.format(totals.due)} />
          </div>
          <div className="card p-5 mt-2">
            <div className="font-medium">Transactions</div>
            <div className="text-xs text-gray-500 mb-3">From the "Transactions" sheet</div>
            <div className="grid gap-2">
              {transactions.map((p,i)=> (
                <div key={i} className="grid md:grid-cols-6 gap-2 items-center border rounded-2xl p-3 text-sm">
                  <div className="font-medium md:col-span-2">{p['Date']}</div>
                  <div>{p['Type']}</div>
                  <div>{p['Category']}</div>
                  <div>{p['Sub-category']}</div>
                  <div className="md:text-right">{INR.format(Number(p['Amount']||0))}</div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function OpeningBalances({ rows, onBack }){
      return (
        <Section>
          <BackBar title="Opening Balances" onBack={onBack} />
          <div className="card p-5">
            <div className="grid gap-2">
              {rows.map((r,i)=> (
                <div key={i} className="flex items-center justify-between border rounded-2xl p-3">
                  <div className="font-medium">{r['Account']||r['Account Name']||r['Name']}</div>
                  <div className="text-sm">{INR.format(Number(r['Amount']||r['Opening Balance']||0))}</div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function ChartOfAccounts({ rows, onBack }){
      return (
        <Section>
          <BackBar title="Chart of Accounts" onBack={onBack} />
          <div className="card p-5">
            <div className="grid gap-2">
              {rows.map((r,i)=> (
                <div key={i} className="grid md:grid-cols-4 gap-2 items-center border rounded-2xl p-3 text-sm">
                  <div className="font-medium">{r['Code']||r['Account Code']}</div>
                  <div>{r['Name']||r['Account Name']}</div>
                  <div>{r['Type']||r['Account Type']}</div>
                  <div>{r['Parent']||''}</div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Documents({ documents, onBack }) {
      return (
        <Section>
          <BackBar title="Documents" onBack={onBack} />
          <div className="card p-5">
            <div className="font-medium">Documents</div>
            <div className="text-xs text-gray-500 mb-3">From the "Documents" sheet</div>
            <div className="grid gap-2">
              {documents.map((d,i)=> (
                <div key={i} className="flex items-center justify-between border rounded-2xl p-4">
                  <div>
                    <div className="font-medium">{d['Subject']}</div>
                    <div className="text-xs text-gray-500">{d['Date']} ‚Ä¢ {d['Category']}</div>
                  </div>
                  {d['Link'] && <a className="underline" target="_blank" rel="noreferrer" href={d['Link']}>Open</a>}
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Voters({ voters, onBack }) {
      return (
        <Section>
          <BackBar title="Voters" onBack={onBack} />
          <div className="card p-5">
            <div className="font-medium">Voters list</div>
            <div className="text-xs text-gray-500 mb-3">From the "Voters" sheet</div>
            <div className="grid gap-2">
              {voters.map((v,i)=> (
                <div key={i} className="border rounded-2xl p-4">
                  <div className="font-medium">{v['First Owner Name']}{v['Second Owner Name'] ? ` & ${v['Second Owner Name']}` : ''}</div>
                  <div className="text-xs text-gray-500">Tower {v['Tower No.']} ‚Ä¢ Flat {v['Flat No.']}</div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Admin({ users, session, onLogin, onLogout, onBack }){
      const [u, setU] = useState('');
      const [p, setP] = useState('');
      const me = session || { role:'user' };
      const tryLogin = () => onLogin(u,p);
      return (
        <Section>
          <BackBar title="Admin Portal" onBack={onBack} />
          {me.role!=='admin' && (
            <div className="card p-5">
              <div className="font-medium mb-2">Login (sheet-backed)</div>
              <div className="grid md:grid-cols-3 gap-2">
                <input className="border rounded-xl p-2" placeholder="Username" value={u} onChange={e=>setU(e.target.value)} />
                <input className="border rounded-xl p-2" placeholder="Password" type="password" value={p} onChange={e=>setP(e.target.value)} />
                <button className="btn" onClick={tryLogin}>Login</button>
              </div>
              <div className="text-xs text-gray-500 mt-2">Hint (demo): admin/admin</div>
            </div>
          )}
          {me.role==='admin' && (
            <>
              <div className="flex items-center justify-between card p-4">
                <div>Signed in as <span className="font-medium">{me.username}</span> (<span className="badge">admin</span>)</div>
                <button className="btn-secondary" onClick={onLogout}>Logout</button>
              </div>
              <div className="card p-5 mt-3">
                <div className="font-medium mb-2">Users</div>
                <div className="grid gap-2">
                  {users.map((x,i)=> (
                    <div key={i} className="grid md:grid-cols-5 gap-2 items-center border rounded-2xl p-3 text-sm">
                      <div className="font-medium">{x['Username']||x['Email']}</div>
                      <div>{x['Role']||'user'}</div>
                      <div>{x['Active']||'Yes'}</div>
                      <div>{x['CreatedAt']||''}</div>
                      <div className="text-xs text-gray-500">(editing requires GAS update)</div>
                    </div>
                  ))}
                </div>
              </div>
            </>
          )}
        </Section>
      );
    }

    // =====================
    // Self-tests (show in Diagnostics)
    // =====================
    function runTests() {
      const results = [];
      function t(name, fn){
        try { fn(); results.push({ name, pass:true }); }
        catch(e){ results.push({ name, pass:false, err:String(e) }); }
      }
      // Test: totals calc
      t('payments totals', ()=>{
        const paid = DEMO.Transactions.filter(x=>x.Type==='Credit').reduce((a,b)=>a+b.Amount,0);
        const due  = DEMO.Transactions.filter(x=>x.Type==='Debit').reduce((a,b)=>a+b.Amount,0);
        if (paid !== 1200) throw new Error('paid mismatch');
        if (due  !== 250)  throw new Error('due mismatch');
      });
      // Test: residents mapping
      t('directory mapping', ()=>{
        const r = DEMO.Directory[0];
        const id = r.Serial || `${r.Name}-${r.Flat}`;
        if (!id) throw new Error('id missing');
      });
      // Test: demo notices exist
      t('notices exist', ()=>{
        if (!Array.isArray(DEMO.Notices) || DEMO.Notices.length < 2) throw new Error('notices missing');
      });
      return results;
    }

    function Diagnostics({ baseUrl, lastError, mode, rerun, tests }) {
      const passCount = tests.filter(x=>x.pass).length;
      const failCount = tests.length - passCount;
      return (
        <div className="card p-4 text-sm">
          <div className="font-medium mb-1">Diagnostics</div>
          <div>Society: <span className="mono">{SOCIETY_NAME}</span></div>
          <div>Mode: <span className="mono">{mode}</span></div>
          <div>BASE_URL: <code className="break-all mono">{baseUrl || '(empty)'}</code></div>
          {lastError && <div className="text-red-600 mt-1">Last error: {String(lastError)}</div>}
          <div className="text-xs text-gray-500 mt-2">Tests ‚Äî pass: {passCount}, fail: {failCount}</div>
          {failCount>0 && (
            <ul className="list-disc ml-5 mt-1 text-red-600">
              {tests.filter(x=>!x.pass).map((x,i)=>(<li key={i}>{x.name}: {x.err}</li>))}
            </ul>
          )}
          <div className="text-xs text-gray-500 mt-1">Tip: override with <code>?gas=&lt;url&gt;</code> or force demo with <code>?demo=1</code></div>
          <div className="mt-2 flex gap-2">
            <button className="btn" onClick={rerun}>Run connectivity tests</button>
            <a className="btn-secondary" href="?demo=1">Open in Demo Mode</a>
          </div>
        </div>
      );
    }

    // =====================
    // App (with Demo fallback)
    // =====================
    function App(){
      const [view, setView] = useState('dashboard');
      const [loading, setLoading] = useState(false);
      const [lastError, setLastError] = useState('');
      const [mode, setMode] = useState(FORCE_DEMO ? 'DEMO' : 'LIVE');
      const [tests, setTests] = useState(runTests());

      const [directory, setDirectory] = useState([]);
      const [notices, setNotices] = useState([]);
      const [tickets, setTickets] = useState([]);
      const [transactions, setTransactions] = useState([]);
      const [documents, setDocuments] = useState([]);
      const [voters, setVoters] = useState([]);
      const [openingBalances, setOpeningBalances] = useState([]);
      const [chart, setChart] = useState([]);
      const [users, setUsers] = useState([]);
      const [session, setSession] = useState({ username: 'guest', role: (new URLSearchParams(location.search).get('role')) || 'user' });
      const [search, setSearch] = useState('');

      async function loadAll() {
        if (FORCE_DEMO || !BASE_URL) { useDemo(); return; }
        try {
          setLoading(true); setLastError('');
          const [dir, nts, iss, txs, docs, vts, obs, coa, us] = await Promise.all([
            api('listDirectory', 'GET', null, 1),
            api('listNotices',   'GET', null, 1),
            api('listIssues',    'GET', null, 1),
            api('listTransactions','GET',null,1),
            api('listDocuments', 'GET', null, 1),
            api('listVoters',    'GET', null, 1),
            api('listOpeningBalances','GET',null,1).catch(()=>({rows:DEMO.OpeningBalances})),
            api('listChartOfAccounts','GET',null,1).catch(()=>({rows:DEMO.ChartOfAccounts})),
            api('listUsers','GET',null,1).catch(()=>({rows:DEMO.Users})),
          ]);
          setDirectory(dir?.rows||[]);
          setNotices(nts?.rows||[]);
          setTickets(iss?.rows||[]);
          setTransactions(txs?.rows||[]);
          setDocuments(docs?.rows||[]);
          setVoters(vts?.rows||[]);
          setOpeningBalances(obs?.rows||[]);
          setChart(coa?.rows||[]);
          setUsers(us?.rows||[]);
          setMode('LIVE');
        } catch (err) {
          setLastError(err);
          useDemo();
        } finally { setLoading(false); }
      }

      function useDemo(){
        setDirectory(DEMO.Directory);
        setNotices(DEMO.Notices);
        setTickets(DEMO.Issues);
        setTransactions(DEMO.Transactions);
        setDocuments(DEMO.Documents);
        setVoters(DEMO.Voters);
        setOpeningBalances(DEMO.OpeningBalances);
        setChart(DEMO.ChartOfAccounts);
        setUsers(DEMO.Users);
        setMode('DEMO');
      }

      useEffect(()=>{ loadAll(); },[]);

      function handleLogin(username, password){
        const pool = users && users.length ? users : DEMO.Users;
        const match = pool.find(u => (u.Username||'').toLowerCase()===String(username).toLowerCase() && String(u.Password||'')===String(password) && String(u.Active||'Yes').toLowerCase().startsWith('y'));
        if(match){ setSession({ username: match.Username||username, role: (match.Role||'user').toLowerCase() }); alert('Logged in as '+(match.Username||username)); }
        else { alert('Invalid credentials'); }
      }
      function handleLogout(){ setSession({ username:'guest', role:'user' }); }

      const residents = useMemo(()=> directory.map(r=>({
        id: r.Serial ?? r.id ?? `${r.Name}-${r.Flat}`,
        name: r.Name ?? r['First Owner Name'] ?? '',
        flat: r.Flat ?? `${r['Tower No.']||''}-${r['Flat No.']||''}`,
        phone: r.Phone || r.Mobile || '',
        email: r.Email || '',
      })), [directory]);

      const filteredResidents = useMemo(()=>{
        const q = search.toLowerCase();
        return residents.filter(r=>[r.name,r.flat,r.phone,r.email].some(v=>String(v||'').toLowerCase().includes(q)));
      }, [search, residents]);

      const writable = mode === 'LIVE';
      const canSeePayments = session.role === 'admin';

      return (
        <div className="max-w-7xl mx-auto p-4">
          {/* Topbar */}
          <header className="sticky top-0 z-40 border-b bg-white/70 backdrop-blur mb-4">
            <div className="h-14 flex items-center justify-between">
              <div className="font-semibold text-lg">üè° {SOCIETY_NAME}</div>
              <div className="hidden md:flex gap-2">
                <input className="border rounded-xl px-3 py-2 w-80" placeholder="Search directory‚Ä¶" value={search} onChange={e=>setSearch(e.target.value)} />
                <button className="btn-secondary">Search</button>
              </div>
            </div>
          </header>

          {/* Shell */}
          <div className="grid grid-cols-1 md:grid-cols-[220px_1fr] gap-4">
            {/* Sidebar */}
            <aside className="grid gap-2">
              {['dashboard','notices','tickets','directory','payments','openingBalances','chartOfAccounts','documents','voters','admin'].map(tab=> (
                <NavItem key={tab} label={tab.charAt(0).toUpperCase()+tab.slice(1)} active={view===tab} onClick={()=>setView(tab)} />
              ))}
              <Diagnostics baseUrl={BASE_URL} lastError={lastError} mode={mode} rerun={loadAll} tests={tests} />
            </aside>

            {/* Content */}
            <main className="grid gap-4">
              {loading && <div className="text-sm text-gray-500">Loading from Google Sheets‚Ä¶</div>}
              {mode==='DEMO' && <Banner kind="error">Failed to reach backend. Running in Demo Mode so you can still try the app.</Banner>}
              {view==='dashboard' && <Dashboard residents={residents} tickets={tickets} transactions={transactions} notices={notices} />}
              {view==='notices' && <Notices notices={notices} onCreate={async n=>{ if(!writable){ alert('Demo Mode: write disabled'); return n; } const created = await api('createNotice','POST',n); setNotices(p=>[created,...p]); return created; }} writable={writable} onBack={()=>setView('dashboard')} />}
              {view==='tickets' && <Issues tickets={tickets} onCreate={async t=>{ if(!writable){ alert('Demo Mode: write disabled'); return t; } const created = await api('createIssue','POST',t); setTickets(p=>[created,...p]); return created; }} writable={writable} onBack={()=>setView('dashboard')} />}
              {view==='directory' && <Directory residents={filteredResidents} onBack={()=>setView('dashboard')} />}
              {view==='payments' && <Payments transactions={transactions} canView={canSeePayments} onBack={()=>setView('dashboard')} />}
              {view==='openingBalances' && <OpeningBalances rows={openingBalances} onBack={()=>setView('dashboard')} />}
              {view==='chartOfAccounts' && <ChartOfAccounts rows={chart} onBack={()=>setView('dashboard')} />}
              {view==='documents' && <Documents documents={documents} onBack={()=>setView('dashboard')} />}
              {view==='voters' && <Voters voters={voters} onBack={()=>setView('dashboard')} />}
              {view==='admin' && <Admin users={users} session={session} onLogin={handleLogin} onLogout={handleLogout} onBack={()=>setView('dashboard')} />}
            </main>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <noscript>
    <div class="p-8 text-center">‚ö†Ô∏è This app requires JavaScript. Please enable it.</div>
  </noscript>
</body>
</html>
