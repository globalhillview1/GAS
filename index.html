<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Hillview ‚Äî Society Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" href="assets/favicon.ico" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { ink:"#0f172a", mist:"#0b1020", card:"#121833", border:"#233160" } } }
    };
  </script>

  <!-- React 18 UMD + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- GAS URL (override with ?gas=<url>) -->
  <script>
    window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";
  </script>

  <style>
    body{ background:#0b1020; color:#eaf0ff }
    .card { background:#0f1734; border:1px solid #233160; border-radius:16px }
    .btn { background:#1c2752; color:#eaf0ff; border-radius:10px; padding:.55rem .9rem }
    .btn:hover{ background:#223067 }
    .btn2 { background:#121833; color:#cfd7ff; border:1px solid #263057; border-radius:10px; padding:.5rem .85rem }
    .spin{ border:2px solid #fff; border-top-color:transparent; width:14px; height:14px; border-radius:50%; animation:s .9s linear infinite }
    @keyframes s { to { transform:rotate(360deg) } }
    header{ position:sticky; top:0; z-index:40; height:64px; backdrop-filter: blur(8px); background:#0b1020cc; border-bottom:1px solid #1f2748 }
    .chip{ padding:.55rem .75rem; background:#121833; border:1px solid #263057; border-radius:10px; color:#aab3d0 }
    .kpi{ border-radius:14px; padding:16px; text-align:center; background:linear-gradient(135deg,#5b79ff 0%,#7a4de0 100%); color:white; box-shadow:0 6px 20px rgba(20,30,70,.25) }
    .kpi .k{ font-size:15px; font-weight:700; opacity:.95 }
    .kpi .v{ font-size:28px; font-weight:800; margin-top:6px }
    .tablewrap{ overflow:auto; border:1px solid #263057; border-radius:14px; background:#121833 }
    table{ width:100%; border-collapse:collapse; font-size:14px; min-width:1000px }
    thead th{ position:sticky; top:0; background:#161e3c; color:#cfd7ff; text-align:left; padding:12px 10px; border-bottom:1px solid #263057; user-select:none }
    tbody td{ padding:10px; border-bottom:1px dashed #223058; vertical-align:top }
    tbody tr:hover{ background:#10183a }
    input, select, textarea{ background:#0f1530; color:#fff; border:1px solid #2a3770; border-radius:8px; padding:6px 8px; outline: none }
    .toolbar > *{ margin-right:8px }
    .toolbar input[type="search"]{ width:260px }
    .titlebar{ display:flex; align-items:center; justify-content:center; gap:10px; padding:6px 0 2px }
    .titlebar img{ width:28px; height:28px; border-radius:8px }
    .titlebar h1{ margin:0; font-size:22px; font-weight:800 }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const {useState,useEffect,useMemo} = React;

    // ---------- Config ----------
    const qs = new URLSearchParams(location.search);
    const GAS = (qs.get("gas") || window.ENV_GAS_URL || "").trim();
    const INR = new Intl.NumberFormat("en-IN",{style:"currency",currency:"INR"});

    const DEMO = {
      Directory:[{Serial:1,Name:'Demo',Flat:'T1-101',Phone:'',Email:''}],
      Notices:[{'Serial Number':1,Subject:'Welcome',Date:'2025-01-10',Notice:'Demo'}],
      Issues:[{'Tracking ID':'demo-1','Date and Time Raised':'2025-01-10T10:00:00Z',Tower:'T1',Flat:'101',Issue:'Demo',Status:'Open','Feedback Rating':5}],
      Transactions:[{Date:'2025-01-01',Type:'Credit',Category:'Maintenance','Sub-category':'Monthly',Amount:1200},
                    {Date:'2025-01-03',Type:'Debit',Category:'Repairs','Sub-category':'Lift',Amount:300}],
      Documents:[{'Serial Number':1,Subject:'AGM',Date:'2025-01-01',Category:'Gov',Link:'#'}],
      Voters:[{'Tower No.':'T1','Flat No.':'101','First Owner Name':'Demo','Second Owner Name':'','Membership Card & Share Certificate No':'','Eligible Voter':'Yes','Discrepency':'','Voted Earlier':'No','Remark':''}],
      OpeningBalances:[{Account:'Maintenance Fund',Amount:100000}],
      ChartOfAccounts:[{Code:'1001',Name:'Cash',Type:'Asset',Parent:''}],
    };

    // ---------- HTTP ----------
    async function fetchWithTimeout(url,opts={},ms=12000){
      const ctl=new AbortController(); const id=setTimeout(()=>ctl.abort('timeout'),ms);
      try{ return await fetch(url,{...opts,signal:ctl.signal}); } finally{ clearTimeout(id); }
    }
    async function getJSON(action){
      const u=new URL(GAS); u.searchParams.set('action',action);
      const r=await fetchWithTimeout(u); if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText)); return r.json();
    }
    async function postJSON(body){
      const r=await fetchWithTimeout(GAS,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(body)});
      if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText)); return r.json();
    }

    const API = {
      login:(username,password)=> postJSON({op:'login',username,password}).catch(()=>getJSON('login?u='+username+'&p='+password)),
      sessionInfo:(token)=> postJSON({op:'sessionInfo',token}),
      listAll: async()=>{
        const calls = await Promise.allSettled([
          getJSON('listDirectory'),getJSON('listNotices'),getJSON('listIssues'),
          getJSON('listTransactions'),getJSON('listDocuments'),getJSON('listVoters'),
          getJSON('listOpeningBalances'),getJSON('listChartOfAccounts')
        ]);
        const pick=i=> calls[i].status==='fulfilled'?(calls[i].value?.rows||[]):[];
        return {Directory:pick(0),Notices:pick(1),Issues:pick(2),Transactions:pick(3),Documents:pick(4),Voters:pick(5),OpeningBalances:pick(6),ChartOfAccounts:pick(7)};
      },
      create:(sheet,row)=> postJSON({op:'create',sheet,row}),
      update:(sheet,key,value,updates)=> postJSON({op:'update',sheet,key,value,updates}),
    };

    // ---------- Small atoms ----------
    const Btn=({className="",...p})=><button className={"btn "+className} {...p}/>;
    const Btn2=({className="",...p})=><button className={"btn2 "+className} {...p}/>;
    const Back=({onClick})=><Btn2 onClick={onClick}>‚Üê Back</Btn2>;
    const Chip=({children})=><span className="chip">{children}</span>;

    // ---------- Login ----------
    function Login({onOK}){
      const [u,setU]=useState(''); const [p,setP]=useState(''); const [err,setErr]=useState(''); const [busy,setBusy]=useState(false);
      async function go(){ if(busy) return; setBusy(true); setErr('');
        try{ const r=await API.login(u,p); if(r?.ok && r?.token){ localStorage.setItem('session',r.token); onOK({token:r.token,role:(r.role||'user').toLowerCase(),username:r.username||u}); } else setErr(r?.error||'Invalid'); }
        catch(e){ setErr(String(e)); } finally{ setBusy(false); }
      }
      return (
        <div className="min-h-screen grid place-items-center" style={{ background: '#0b1020' }}>
          <div className="card p-6 w-full max-w-md">
            <div className="flex items-center gap-3 mb-3"><img src="assets/favicon.ico" className="w-8 h-8"/><div className="font-semibold">Global Hillview ‚Äî Sign in</div></div>
            <div className="grid gap-3">
              <div><label className="text-sm">Username</label><input className="w-full mt-1" value={u} onChange={e=>setU(e.target.value)} /></div>
              <div><label className="text-sm">Password</label><input className="w-full mt-1" type="password" value={p} onChange={e=>setP(e.target.value)} /></div>
              <Btn onClick={go} className="flex gap-2 items-center justify-center">{busy && <span className="spin"></span>}<span>Sign in</span></Btn>
              {err && <div style={{ color: '#ff8a8a' }} className="text-sm">{err}</div>}
              <div className="text-xs text-[#9aa6d1]">Backend: <code>{GAS||'(unset)'}</code> ‚Ä¢ tip: <code>?gas=&lt;url&gt;</code></div>
            </div>
          </div>
        </div>
      );
    }

    // ---------- Toolbar + Summary ----------
    function Toolbar({state,setState,total,extraRight}){
      const set=(k,v)=> setState(s=>({...s,[k]:v,page:1}));
      return (
        <div className="toolbar flex items-center flex-wrap">
          <input type="search" placeholder="Quick search‚Ä¶" value={state.q} onChange={e=>set('q',e.target.value)} />
          <select value={state.sort} onChange={e=>set('sort',e.target.value)}>
            <option value="">(No sort)</option>
            {state.columns.map(c=><option key={c} value={c}>{c}</option>)}
          </select>
          <select value={state.dir} onChange={e=>set('dir',e.target.value)}>
            <option value="asc">‚ñ≤ Asc</option><option value="desc">‚ñº Desc</option>
          </select>
          <select value={state.limit} onChange={e=>set('limit',parseInt(e.target.value,10))}>
            {[25,50,100,250].map(n=><option key={n} value={n}>{n}</option>)}
          </select>
          <Chip>{total} rows</Chip>
          <div className="ml-auto">{extraRight}</div>
        </div>
      );
    }

    function SummaryCards({items}){
      return (
        <div className="grid md:grid-cols-6 sm:grid-cols-3 grid-cols-2 gap-3">
          {items.map(([k,v])=>(
            <div className="kpi" key={k}><div className="k">{k}</div><div className="v">{v}</div></div>
          ))}
        </div>
      );
    }

    // ---------- Generic, editable grid view for any sheet ----------
    function SheetView({title, rows, sheetName, keyGuess, isAdmin, onBack, onRefresh, summaryFn}){
      // build columns (union)
      const columns = useMemo(()=>{
        const s=new Set(); (rows||[]).forEach(r=>Object.keys(r||{}).forEach(k=>s.add(k))); return Array.from(s);
      },[rows]);

      // pick key column
      const keyCol = useMemo(()=>{
        const low = columns.map(c=>c.toLowerCase());
        const candidates=[keyGuess,'tracking id','serial number','code','id','account','date','name'];
        for(const c of candidates){ const i=low.indexOf(String(c||'').toLowerCase()); if(i>-1) return columns[i]; }
        return columns[0]||'id';
      },[columns,keyGuess]);

      // grid state
      const [st,setSt]=useState({q:'',sort:'',dir:'asc',limit:100,page:1,columns});
      useEffect(()=>{ setSt(s=>({...s,columns})); },[columns]);

      // filtered, sorted, paged
      const filtered = useMemo(()=>{
        const q = st.q.trim().toLowerCase();
        let arr = rows||[];
        if(q) arr = arr.filter(r=> columns.some(c=> String(r[c]??'').toLowerCase().includes(q)));
        if(st.sort){
          const k=st.sort;
          arr = arr.slice().sort((a,b)=>{
            const A=a[k]??'', B=b[k]??'';
            if(A===B) return 0;
            return (A > B ? 1 : -1) * (st.dir==='asc'?1:-1);
          });
        }
        return arr;
      },[rows,st.q,st.sort,st.dir,columns]);

      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / st.limit));
      const page = Math.min(st.page, pages);
      const start = (page-1)*st.limit;
      const pageRows = filtered.slice(start, start + st.limit);

      // Add form
      const [add,setAdd]=useState(()=>Object.fromEntries(columns.map(c=>[c,''])));
      useEffect(()=>{ setAdd(Object.fromEntries(columns.map(c=>[c,'']))); },[columns]);

      async function saveRow(row){
        if(!isAdmin) return;
        const key = row[keyCol];
        if(key==null||key==='') return alert(`Missing key column "${keyCol}" value`);
        try{ await API.update(sheetName,keyCol,String(key),row); await onRefresh(); }
        catch(e){ alert(String(e)); }
      }
      async function create(){
        if(!isAdmin) return alert('Only admin can add.');
        try{ await API.create(sheetName,add); await onRefresh(); setAdd(Object.fromEntries(columns.map(c=>[c,'']))); }
        catch(e){ alert(String(e)); }
      }

      // summary items per sheet (callable)
      const summaryItems = summaryFn ? summaryFn(rows) : [['Rows', (rows||[]).length]];

      return (
        <div className="grid gap-3">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Back onClick={onBack} />
              <div className="text-sm text-[#aab3d0]">{title}</div>
            </div>
            <div className="text-xs text-[#9aa6d1]">Key: <code>{keyCol}</code></div>
          </div>

          <div className="card p-3">
            <div className="titlebar">
              <img src="assets/favicon.ico" alt="logo"/><h1>{title}</h1>
            </div>
          </div>

          <div className="card p-4">
            <h2 className="text-xl font-extrabold mb-2">üìä Summary Statistics</h2>
            <SummaryCards items={summaryItems} />
          </div>

          <div className="card p-3">
            <Toolbar state={st} setState={setSt} total={total} />
          </div>

          {/* Add new */}
          <div className="card p-4">
            <div className="font-semibold">Add new</div>
            {!isAdmin && <div className="text-[#ffb3b3] text-sm mt-1">Only admin can add/edit.</div>}
            <div className="grid md:grid-cols-3 gap-2 mt-3">
              {columns.map(c=>(
                <div key={'add-'+c}><div className="text-xs mb-1">{c}</div>
                  <input className="w-full" value={add[c]||''} onChange={e=>setAdd({...add,[c]:e.target.value})} disabled={!isAdmin}/>
                </div>
              ))}
            </div>
            <div className="mt-3"><Btn onClick={create} disabled={!isAdmin}>Save</Btn></div>
          </div>

          {/* Grid */}
          <div className="tablewrap">
            <table>
              <thead><tr>
                {columns.map(h=>(
                  <th key={h} onClick={()=>setSt(s=>({...s, sort:(s.sort===h?'':h), dir:(s.sort===h && s.dir==='asc')?'desc':'asc'}))}>
                    {h}{st.sort===h ? (st.dir==='asc'?' ‚ñ≤':' ‚ñº') : ''}
                  </th>
                ))}
                {isAdmin && <th>Actions</th>}
              </tr></thead>
              <tbody>
                {pageRows.length===0 && <tr><td colSpan={columns.length+(isAdmin?1:0)} style={{color:'#f99',padding:'12px'}}>No results</td></tr>}
                {pageRows.map((r,idx)=><Row key={idx} row={r} cols={columns} isAdmin={isAdmin} onSave={saveRow} />)}
              </tbody>
            </table>
          </div>

          <div className="flex items-center justify-end gap-2 text-sm">
            <Btn2 onClick={()=>st.page>1 && setSt(s=>({...s,page:s.page-1}))}>Prev</Btn2>
            <span className="text-[#aab3d0]">Page {page} of {pages}</span>
            <Btn2 onClick={()=>page<pages && setSt(s=>({...s,page:s.page+1}))}>Next</Btn2>
          </div>
        </div>
      );
    }

    function Row({row,cols,isAdmin,onSave}){
      const [edit,setEdit]=useState(false);
      const [val,setVal]=useState({...row});
      useEffect(()=>{ setVal({...row}); },[row]);
      return (
        <tr>
          {cols.map(c=>(
            <td key={c}>
              {edit && isAdmin
                ? <input className="w-full" value={val[c]??''} onChange={e=>setVal({...val,[c]:e.target.value})}/>
                : String(row[c]??'')}
            </td>
          ))}
          {isAdmin && (
            <td className="whitespace-nowrap">
              {edit
                ? (<><Btn2 onClick={()=>{setEdit(false);setVal({...row});}}>Cancel</Btn2>
                    <Btn onClick={()=>onSave(val).then(()=>setEdit(false))} className="ml-2">Save</Btn></>)
                : <Btn2 onClick={()=>setEdit(true)}>Edit</Btn2>}
            </td>
          )}
        </tr>
      );
    }

    // ---------- Dashboard KPIs ----------
    function Dashboard({data,isAdmin,onOpen}){
      const open = data.Issues.filter(t=>(t.Status||'').toLowerCase()!=='closed').length;
      const paid = data.Transactions.filter(t=>(t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
      const due  = data.Transactions.filter(t=>(t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
      return (
        <div className="grid gap-3">
          <div className="grid md:grid-cols-6 sm:grid-cols-3 grid-cols-2 gap-3">
            <div className="kpi"><div className="k">Residents</div><div className="v">{data.Directory.length}</div></div>
            <div className="kpi"><div className="k">Open issues</div><div className="v">{open}</div></div>
            <div className="kpi"><div className="k">Credits</div><div className="v">{INR.format(paid)}</div></div>
            <div className="kpi"><div className="k">Debits</div><div className="v">{INR.format(due)}</div></div>
            <div className="kpi"><div className="k">Net</div><div className="v">{INR.format(paid-due)}</div></div>
            <div className="kpi"><div className="k">Role</div><div className="v">{isAdmin?'Admin':'User'}</div></div>
          </div>

          <div className="card p-3">
            <div className="flex flex-wrap gap-2">
              {['Notices','Issues','Directory','Transactions','Documents','Voters','OpeningBalances','ChartOfAccounts'].map(n=>(
                <Btn2 key={n} onClick={()=>onOpen(n.toLowerCase())}>{n}</Btn2>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ---------- App ----------
    function App(){
      const [session,setSession]=useState({token:null,role:null,username:null});
      const [data,setData]=useState(DEMO);
      const [view,setView]=useState('dashboard');
      const isAdmin = session.role==='admin';

      useEffect(()=>{
        (async()=>{
          const tok = qs.get('session') || localStorage.getItem('session');
          if(tok){ try{ const s=await API.sessionInfo(tok); if(s?.ok){ setSession({token:tok,role:(s.role||'user').toLowerCase(),username:s.username||'user'}); } }catch(_){} }
          try{ setData(await API.listAll()); } catch{ setData(DEMO); }
        })();
      },[]);

      async function refresh(){ try{ setData(await API.listAll()); } catch(e){ alert(String(e)); } }
      function logout(){ localStorage.removeItem('session'); setSession({token:null,role:null,username:null}); }

      if(!session.token || !session.role) return <Login onOK={(s)=>{ setSession(s); refresh(); }} />;

      const towersSummary = (rows)=>{
        const counts = {T1:0,T2:0,T3:0,T4:0,T5:0};
        rows.forEach(r=>{ const t=String(r['Tower No.']||r.Tower||'').toUpperCase(); if(counts[t]!=null) counts[t]++; });
        const total = rows.length;
        return [['Tower T1',counts.T1],['Tower T2',counts.T2],['Tower T3',counts.T3],['Tower T4',counts.T4],['Tower T5',counts.T5],['Total Flats',total]];
      };
      const txSummary = (rows)=>{
        const paid = rows.filter(r=>(r.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
        const due  = rows.filter(r=>(r.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
        return [['Credits',INR.format(paid)],['Debits',INR.format(due)],['Net',INR.format(paid-due)],['Rows',rows.length],['‚Äî',''],['‚Äî','']];
      };
      const issuesSummary = (rows)=>{
        const s = {Open:0,InProgress:0,Resolved:0,Closed:0};
        rows.forEach(r=>{ const v=(r.Status||'').toString(); if(s[v]!=null) s[v]++; });
        return [['Open',s.Open],['In Progress',s.InProgress],['Resolved',s.Resolved],['Closed',s.Closed],['Rows',rows.length],['‚Äî','']];
      };

      return (
        <div>
          <header className="flex items-center justify-between px-3">
            <div className="flex items-center gap-2">
              <img src="assets/favicon.ico" className="w-7 h-7"/>
              <div className="font-semibold">Global Hillview ‚Äî Society Portal</div>
            </div>
            <div className="flex items-center gap-2">
              <Chip>Logged in: {session.role}</Chip>
              <Btn2 onClick={logout}>Logout</Btn2>
            </div>
          </header>

          <div className="max-w-7xl mx-auto p-4 grid grid-cols-1 md:grid-cols-[220px_1fr] gap-4">
            <aside className="grid gap-2">
              {['dashboard','notices','issues','directory','transactions','documents','voters','openingbalances','chartofaccounts'].map(t=>(
                <Btn2 key={t} onClick={()=>setView(t)} className={view===t?'ring-2 ring-[#3b82f6]':''}>
                  {t[0].toUpperCase()+t.slice(1)}
                </Btn2>
              ))}
            </aside>

            <main className="grid gap-4">
              {view==='dashboard' && <Dashboard data={data} isAdmin={isAdmin} onOpen={setView} />}

              {view==='notices' && (
                <SheetView
                  title="Notices"
                  rows={data.Notices}
                  sheetName="Notices"
                  keyGuess="Serial Number"
                  isAdmin={isAdmin}
                  onBack={()=>setView('dashboard')}
                  onRefresh={refresh}
                />
              )}

              {view==='issues' && (
                <SheetView
                  title="Tickets (Issues)"
                  rows={data.Issues}
                  sheetName="Issues"
                  keyGuess="Tracking ID"
                  isAdmin={isAdmin}
                  onBack={()=>setView('dashboard')}
                  onRefresh={refresh}
                  summaryFn={issuesSummary}
                />
              )}

              {view==='directory' && (
                <SheetView
                  title="Directory"
                  rows={data.Directory}
                  sheetName="Directory"
                  keyGuess="Serial"
                  isAdmin={isAdmin}
                  onBack={()=>setView('dashboard')}
                  onRefresh={refresh}
                />
              )}

              {view==='transactions' && (
                <SheetView
                  title="Payments (Transactions)"
                  rows={data.Transactions}
                  sheetName="Transactions"
                  keyGuess="Date"
                  isAdmin={isAdmin}
                  onBack={()=>setView('dashboard')}
                  onRefresh={refresh}
                  summaryFn={txSummary}
                />
              )}

              {view==='documents' && (
                <SheetView
                  title="Documents"
                  rows={data.Documents}
                  sheetName="Documents"
                  keyGuess="Serial Number"
                  isAdmin={isAdmin}
                  onBack={()=>setView('dashboard')}
                  onRefresh={refresh}
                />
              )}

              {view==='voters' && (
                <SheetView
                  title="Voters"
                  rows={data.Voters}
                  sheetName="Voters"
                  keyGuess="Flat No."
                  isAdmin={isAdmin}
                  onBack={()=>setView('dashboard')}
                  onRefresh={refresh}
                  summaryFn={towersSummary}
                />
              )}

              {view==='openingbalances' && (
                <SheetView
                  title="Opening Balances"
                  rows={data.OpeningBalances}
                  sheetName="OpeningBalances"
                  keyGuess="Account"
                  isAdmin={isAdmin}
                  onBack={()=>setView('dashboard')}
                  onRefresh={refresh}
                />
              )}

              {view==='chartofaccounts' && (
                <SheetView
                  title="Chart of Accounts"
                  rows={data.ChartOfAccounts}
                  sheetName="ChartOfAccounts"
                  keyGuess="Code"
                  isAdmin={isAdmin}
                  onBack={()=>setView('dashboard')}
                  onRefresh={refresh}
                />
              )}
            </main>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
