<!-- Global Hillview Helpdesk (GitHub Pages SPA)
     Layout replicated from GAS Index.html: KPIs + Filters + Grid
     - Plain HTML + React 18 UMD + Babel Standalone
     - Works with your GAS backend (op=login/sessionInfo/update, ?mode=data)
     - Admin-only inline edits (Status + Redressal Remark)
     - Timezone toggle, auto-refresh, CSV export, pagination, sorting, media preview
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Global Hillview, Enviro Helpdesk Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://drive.google.com/uc?export=view&id=1opE1H0_mWwguRjSaDlGPPVV3wN8Pn2jM" />

  <!-- Tailwind for quick layout utilities -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 UMD + Babel (no bundler/TypeScript) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Configure your GAS Web App URL (fallback; you can override via ?gas=...) -->
  <script>window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";</script>

  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --muted:#6b7280; --text:#0f172a;
      --blue:#0d6efd; --green:#22c55e; --amber:#f59e0b; --violet:#7c3aed; --cyan:#06b6d4; --gray:#374151; --danger:#ef4444;
      --border:#e5e7eb; --hover:#f1f5f9; --header-h:72px; --controls-h:0px;
    }
    .dark{ --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --border:#1f2937; --hover:#111827 }
    body{ background:var(--bg); color:var(--text); margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial }
    header{ position:sticky; top:0; z-index:30; height:var(--header-h); backdrop-filter:saturate(180%) blur(8px);
            border-bottom:1px solid var(--border); background:color-mix(in oklab, var(--bg) 70%, #fff 30%) }
    header .brand{ display:flex; align-items:center; gap:12px }
    header .brand img{ width:40px; height:40px; border-radius:8px }
    header .toolbar{ display:flex; gap:10px; align-items:center }
    .container{ max-width:1200px; margin:0 auto; padding:14px 20px }
    .btn{ background:#111827; color:#fff; border:0; border-radius:12px; padding:.6rem 1rem; cursor:pointer }
    .btn.secondary{ background:#f3f4f6; color:#111827 }
    .btn.danger{ background:var(--danger) }
    .switch{ display:inline-flex; align-items:center; gap:8px }
    .spinner{ width:14px; height:14px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; display:inline-block; animation:spin 1s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .sticky-controls{ position:sticky; top:var(--header-h); z-index:25; background:var(--bg); padding:8px 20px 12px; box-shadow:0 2px 0 rgba(0,0,0,.04) }
    .kpis{ display:grid; grid-template-columns:repeat(6, minmax(150px, 1fr)); gap:12px; margin:8px 0 14px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px }
    .card .label{ font-size:12px; color:var(--muted); text-transform:uppercase }
    .card .value{ font-size:20px; font-weight:800; margin-top:6px }
    .card.total{ border-left:6px solid var(--green) }
    .card.open{ border-left:6px solid var(--gray) }
    .card.progress{ border-left:6px solid var(--amber) }
    .card.resolved{ border-left:6px solid var(--blue) }
    .card.avgtime{ border-left:6px solid var(--cyan) }
    .card.avgrating{ border-left:6px solid var(--violet) }
    .filters{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .tablewrap{ margin:12px 20px; height:calc(100vh - var(--header-h) - var(--controls-h) - 140px); overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:16px }
    table{ width:100%; border-collapse:separate; border-spacing:0 }
    th,td{ padding:.6rem .75rem; font-size:14px }
    thead tr th{ position:sticky; top:0; background:var(--card); z-index:10; border-bottom:1px solid var(--border) }
    tbody tr{ border-top:1px solid var(--border) }
    tbody tr:hover{ background:var(--hover) }
    .sortable{ cursor:pointer; white-space:nowrap }
    .media img{ width:60px; height:60px; object-fit:cover; border-radius:8px; border:1px solid var(--border); cursor:pointer }
    .pagination{ display:flex; align-items:center; gap:12px; padding:10px 0 14px 20px }
    .banner{ margin:10px 20px; padding:10px 12px; border:1px solid; border-radius:12px }
    .banner.info{ background:#eff6ff; color:#1d4ed8; border-color:#bfdbfe }
    .banner.error{ background:#fee2e2; color:#b91c1c; border-color:#fecaca }
    .muted{ color:var(--muted); font-size:12px }
    #lightbox{ position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:50 }
    #lightbox img{ max-width:90vw; max-height:90vh; border-radius:12px; border:1px solid var(--border) }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;

    // --- Config from query ---
    const params = new URLSearchParams(location.search);
    const GAS = (params.get("gas") || window.ENV_GAS_URL || "").trim();

    // --- Helpers ---
    function parseDateSafe(s){ if(!s) return null; if(s instanceof Date) return s; const d=new Date(String(s).includes("T")?s:String(s).replace(" ","T")); return isNaN(d)?null:d; }
    function fmtDate(d, tz){ if(!d) return ""; const o={year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}; if(tz==="utc"){ o.timeZone="UTC"; } const s=new Intl.DateTimeFormat(undefined,o).format(d); return tz==="utc"?s+" UTC":s; }
    function endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }
    function msToHuman(ms){ if(ms==null||isNaN(ms)) return ""; const m=Math.round(ms/60000); const h=Math.floor(m/60); const rem=m%60; const days=Math.floor(h/24),rh=h%24; return `${days}d ${rh}h ${rem}m`; }
    function esc(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

    // --- Networking ---
    async function fetchWithTimeout(url, opts={}, timeoutMs=30000){
      const ctl = new AbortController(); const id = setTimeout(()=>ctl.abort(), timeoutMs);
      try { return await fetch(url, {...opts, signal: ctl.signal}); } finally { clearTimeout(id); }
    }
    async function postJSON(body){
      const res = await fetchWithTimeout(GAS, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
      if(!res.ok) throw new Error(await res.text().catch(()=>res.statusText));
      return res.json();
    }
    const api = {
      async list(){ const u=new URL(GAS); u.searchParams.set("mode","data"); const r=await fetchWithTimeout(u,{cache:"no-store"}); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async login(username,password){ return postJSON({op:"login", username, password}); },
      async sessionInfo(token){ return postJSON({op:"sessionInfo", token}); },
      async update(token, payload){ return postJSON({op:"update", token, ...payload}); }
    };

    // --- Components ---
    const Header = ({tz, setTz, auto, setAuto, onDark, onExport, onLogout, busyLogout, isAdmin}) => (
      <header>
        <div className="container" style={{display:"flex", alignItems:"center", justifyContent:"space-between", height:"var(--header-h)"}}>
          <div className="brand">
            <img src="https://drive.google.com/uc?export=view&id=1opE1H0_mWwguRjSaDlGPPVV3wN8Pn2jM" alt="logo"/>
            <h1 style={{fontSize:18, margin:0}}>Global Hillview, Enviro Helpdesk Dashboard</h1>
          </div>
          <div className="toolbar">
            <label className="switch"><span>Timezone:</span>
              <select value={tz} onChange={e=>setTz(e.target.value)}><option value="local">Local</option><option value="utc">UTC</option></select>
            </label>
            <label className="switch"><span>Auto-refresh</span>
              <input type="checkbox" checked={auto} onChange={e=>setAuto(e.target.checked)} /><span className="muted">60s</span>
            </label>
            <button className="btn" onClick={onDark}>Dark mode</button>
            <button className="btn" onClick={onExport}>Export CSV</button>
            {isAdmin && <span className="badge" style="display:none"></span>}
            <button className="btn danger" onClick={onLogout} disabled={busyLogout} style={{display:"inline-flex",alignItems:"center",gap:8}}>
              <span>Logout</span>{busyLogout && <span className="spinner" />}
            </button>
          </div>
        </div>
      </header>
    );

    const Filters = ({state, setState, apply, reset}) => (
      <div className="sticky-controls">
        <div className="container">
          <div className="kpis">
            <div className="card total"><div className="label">Total</div><div className="value" id="kpiTotal">{state.kpis.total}</div></div>
            <div className="card open"><div className="label">Open</div><div className="value" id="kpiOpen">{state.kpis.open}</div></div>
            <div className="card progress"><div className="label">In Progress</div><div className="value" id="kpiProgress">{state.kpis.progress}</div></div>
            <div className="card resolved"><div className="label">Resolved</div><div className="value" id="kpiResolved">{state.kpis.resolved}</div></div>
            <div className="card avgtime"><div className="label">Avg Time</div><div className="value" id="kpiAvgTime">{state.kpis.avgTime}</div></div>
            <div className="card avgrating"><div className="label">Avg Rating</div><div className="value" id="kpiAvgRating">{state.kpis.avgRating}</div></div>
          </div>

          <section className="card filters" style="margin-top:6px">
            <div><label class="muted">From</label><br/><input type="date" value={state.ui.from} onChange={e=>setState(s=>({...s, ui:{...s.ui, from:e.target.value}}))} /></div>
            <div><label class="muted">To</label><br/><input type="date" value={state.ui.to} onChange={e=>setState(s=>({...s, ui:{...s.ui, to:e.target.value}}))} /></div>
            <div><label class="muted">Tower</label><br/><input class="input" placeholder="e.g., Tower 1 / T1" value={state.ui.tower} onChange={e=>setState(s=>({...s, ui:{...s.ui, tower:e.target.value}}))} /></div>
            <div><label class="muted">Flat</label><br/><input class="input" placeholder="e.g., 1204 or T1-1204" value={state.ui.flat} onChange={e=>setState(s=>({...s, ui:{...s.ui, flat:e.target.value}}))} /></div>
            <div><label class="muted">Issue contains</label><br/><input class="input" placeholder="text" value={state.ui.issue} onChange={e=>setState(s=>({...s, ui:{...s.ui, issue:e.target.value}}))} /></div>
            <div><label class="muted">Status</label><br/>
              <select value={state.ui.status} onChange={e=>setState(s=>({...s, ui:{...s.ui, status:e.target.value}}))}>
                <option value="">(any)</option><option>Open</option><option>InProgress</option><option>Resolved</option><option>Closed</option>
              </select>
            </div>
            <div><label class="muted">Min Rating</label><br/>
              <select value={state.ui.minRating} onChange={e=>setState(s=>({...s, ui:{...s.ui, minRating:e.target.value}}))}>
                <option value="">(any)</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
              </select>
            </div>
            <div><label class="muted">Page size</label><br/>
              <select value={state.pageSize} onChange={e=>setState(s=>({...s, pageSize: Math.max(10, parseInt(e.target.value)||10), page:1}))}>
                <option>10</option><option>25</option><option>50</option><option>100</option>
              </select>
            </div>
            <div style="margin-left:auto">
              <button className="btn" onClick={apply}>Apply</button>
              <button className="btn secondary" onClick={reset} style="margin-left:8px">Reset</button>
            </div>
          </section>
        </div>
      </div>
    );

    const Grid = ({rows, isAdmin, sort, setSort, page, setPage, pageSize, tz, onUpdate}) => {
      const COLS = ["Tracking ID","Date and Time Raised","Tower","Flat","Issue","Description","Media URL","Status","Redressal Remark","User ID","Date and Time Resolved","Time Taken","Feedback Rating"];
      function th(key,label=key){ const onClick=()=> setSort(s=>({ key, dir:s.key===key && s.dir==="asc" ? "desc":"asc" })); const ind = sort.key===key ? (sort.dir==="asc"?" ▲":" ▼") : ""; return <th className="sortable" onClick={onClick} title="Sort">{label}{ind}</th>; }
      function openLightbox(url){ const el=document.getElementById("lightbox"); const img=document.getElementById("lightboxImg"); img.src=url; el.style.display="flex"; }
      function closeLightbox(){ document.getElementById("lightbox").style.display="none"; }

      const rendered = rows.map(r=>{
        const raised = parseDateSafe(r["Date and Time Raised"]);
        const resolved = parseDateSafe(r["Date and Time Resolved"]);
        const computed = (raised && resolved) ? (resolved - raised) : null;
        return {...r, __raised:raised, __resolved:resolved, __time:computed};
      });

      // sorting
      const sorted = rendered.slice().sort((a,b)=>{
        const key = sort.key==="__time" ? "__time" : sort.key;
        const av = key==="__time" ? a.__time : (key==="Date and Time Raised"?a.__raised : (key==="Date and Time Resolved"?a.__resolved : a[key]));
        const bv = key==="__time" ? b.__time : (key==="Date and Time Raised"?b.__raised : (key==="Date and Time Resolved"?b.__resolved : b[key]));
        const aa = av==null ? "" : av, bb = bv==null ? "" : bv;
        if(aa<bb) return sort.dir==="asc" ? -1 : 1;
        if(aa>bb) return sort.dir==="asc" ? 1 : -1;
        return 0;
      });

      const start = (page-1) * pageSize;
      const slice = sorted.slice(start, start + pageSize);
      const maxPage = Math.max(1, Math.ceil(sorted.length / pageSize));

      async function saveStatus(id, val){ await onUpdate({id, status: val}); }
      async function saveRemark(id, val){ await onUpdate({id, remark: val}); }

      return (
        <>
          <div className="tablewrap">
            <table id="grid">
              <thead>
                <tr>
                  {th("Tracking ID")}
                  {th("Date and Time Raised", "Date & Time Raised")}
                  {th("Tower")}
                  {th("Flat")}
                  {th("Issue")}
                  {th("Description")}
                  <th>Media</th>
                  {th("Status")}
                  {th("Redressal Remark")}
                  {th("User ID")}
                  {th("Date and Time Resolved","Date & Time Resolved")}
                  {th("__time","Time Taken")}
                  {th("Feedback Rating","Feedback")}
                </tr>
              </thead>
              <tbody>
                {slice.map((r,i)=>{
                  const id = r["Tracking ID"] || `row-${start+i}`;
                  const raisedStr = fmtDate(r.__raised, tz);
                  const resolvedStr = fmtDate(r.__resolved, tz);
                  const timeStr = msToHuman(r.__time);
                  return (
                    <tr key={id}>
                      <td><span className="muted" style={{borderBottom:"1px dashed var(--muted)", cursor:"copy"}} title="Click to copy" onClick={()=>{navigator.clipboard?.writeText(String(id));}}>{id}</span></td>
                      <td>{raisedStr}</td>
                      <td>{r["Tower"]||""}</td>
                      <td>{r["Flat"]||""}</td>
                      <td>{r["Issue"]||""}</td>
                      <td>{r["Description"]||""}</td>
                      <td className="media">{r["Media URL"] ? <img src={r["Media URL"]} alt="media" onClick={()=>openLightbox(r["Media URL"])} /> : ""}</td>

                      <td>
                        {isAdmin ? (
                          <select defaultValue={r["Status"]||"Open"} onChange={e=>saveStatus(id, e.target.value)}>
                            <option>Open</option><option>InProgress</option><option>Resolved</option><option>Closed</option>
                          </select>
                        ) : (r["Status"]||"")}
                      </td>

                      <td>
                        {isAdmin ? (
                          <div style={{minWidth:220}}>
                            <textarea className="input" rows="2" defaultValue={r["Redressal Remark"]||""} />
                            <div style={{marginTop:6}}>
                              <button className="btn secondary" onClick={e=>{const val=e.target.closest('td').querySelector('textarea').value; saveRemark(id, val);}}>Save Remark</button>
                            </div>
                          </div>
                        ) : (r["Redressal Remark"]||"")}
                      </td>

                      <td>{r["User ID"]||""}</td>
                      <td>{resolvedStr}</td>
                      <td>{timeStr}</td>
                      <td>{r["Feedback Rating"]||""}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="pagination">
            <button className="btn secondary" onClick={()=>setPage(p=>Math.max(1,p-1))}>Prev</button>
            <span id="pageInfo">Page {page} / {maxPage}</span>
            <button className="btn secondary" onClick={()=>setPage(p=>Math.min(maxPage,p+1))}>Next</button>
            <span className="muted" id="rowCount">{sorted.length} row(s), showing {slice.length}</span>
          </div>

          <div id="lightbox" onClick={()=>document.getElementById("lightbox").style.display="none"} style="display:none;align-items:center;justify-content:center">
            <img id="lightboxImg" alt="media"/>
          </div>
        </>
      );
    };

    const Login = ({onSuccess})=>{
      const [u,setU]=useState(""); const [p,setP]=useState(""); const [err,setErr]=useState(""); const [busy,setBusy]=useState(false);
      async function submit(){
        if(busy) return; setBusy(true); setErr("");
        try{
          const res = await api.login(u,p);
          if(res && res.ok && res.token){
            try{ localStorage.setItem("session", res.token); }catch(e){}
            onSuccess({token:res.token, role: (res.role||"user").toLowerCase()});
          }else{
            setErr(res && res.error ? res.error : "Invalid credentials");
          }
        }catch(e){ setErr(String(e)); }
        finally{ setBusy(false); }
      }
      return (
        <div className="min-h-screen grid place-items-center p-6">
          <div className="card w-full max-w-md p-6">
            <div className="text-xl font-semibold mb-2">Sign in</div>
            <div className="text-sm text-gray-500 mb-4">Global Hillview, Sec-11, Sohna, Gurgaon</div>
            <div className="grid gap-3">
              <div><label className="muted">Username</label><input className="input" value={u} onChange={e=>setU(e.target.value)} autoFocus/></div>
              <div><label className="muted">Password</label><input className="input" type="password" value={p} onChange={e=>setP(e.target.value)}/></div>
              <button className="btn" onClick={submit} disabled={busy}>{busy?"Signing in…":"Sign in"}</button>
              {err && <div className="banner error">{err}</div>}
            </div>
          </div>
        </div>
      );
    };

    function App(){
      // session
      const [session,setSession]=useState({token:null, role:null});
      // UI state
      const [tz,setTz]=useState("local");
      const [auto,setAuto]=useState(true);
      const [busyLogout,setBusyLogout]=useState(false);

      // data + derived
      const [raw,setRaw]=useState([]); // all data
      const [rows,setRows]=useState([]); // filtered
      const [kpis,setKpis]=useState({total:0, open:0, progress:0, resolved:0, avgTime:"", avgRating:""});
      const [sort,setSort]=useState({key:"Date and Time Raised", dir:"desc"});
      const [page,setPage]=useState(1);
      const [pageSize,setPageSize]=useState(25);

      const [ui,setUI]=useState({ from:"", to:"", tower:"", flat:"", issue:"", status:"", minRating:"" });

      // Dark toggle
      function toggleDark(){ document.body.classList.toggle("dark"); }

      // CSV export
      function exportCsv(){
        const csvRows = [];
        const headers = ["Tracking ID","Date and Time Raised","Tower","Flat","Issue","Description","Media URL","Status","Redressal Remark","User ID","Date and Time Resolved","Time Taken","Feedback Rating"];
        csvRows.push(headers.join(","));
        rows.forEach(r=>{
          const raised = fmtDate(parseDateSafe(r["Date and Time Raised"]), tz);
          const resolved = fmtDate(parseDateSafe(r["Date and Time Resolved"]), tz);
          const time = msToHuman(r.__time);
          const vals = [
            r["Tracking ID"]||"", raised, r["Tower"]||"", r["Flat"]||"", r["Issue"]||"",
            (r["Description"]||"").replace(/"/g,'""'), r["Media URL"]||"", r["Status"]||"",
            (r["Redressal Remark"]||"").replace(/"/g,'""'), r["User ID"]||"", resolved, time,
            r["Feedback Rating"]||""
          ].map(v=>`"${String(v)}"`);
          csvRows.push(vals.join(","));
        });
        const blob = new Blob([csvRows.join("\n")], {type:"text/csv;charset=utf-8"});
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "helpdesk.csv"; a.click();
      }

      // session boot
      useEffect(()=>{
        (async ()=>{
          // pick token: ?session=... > localStorage
          const urlToken = new URLSearchParams(location.search).get("session");
          const stored = !urlToken ? (localStorage.getItem("session")||null) : null;
          const token = urlToken || stored;

          // validate role if token present
          if(token){
            try{
              const res = await api.sessionInfo(token);
              if(res && res.ok && res.info && res.info.ok){
                setSession({token, role: String(res.info.role||"user").toLowerCase()});
              }else{
                try{ localStorage.removeItem("session"); }catch(_){}
                setSession({token:null, role:null});
              }
            }catch(_){ setSession({token:null, role:null}); }
          }
          await refresh();
        })();
      },[]);

      // auto refresh
      useEffect(()=>{
        if(!auto) return;
        const id = setInterval(()=>{ refresh(true); }, 60000);
        return ()=>clearInterval(id);
      }, [auto, tz, session]);

      async function refresh(silent=false){
        try{
          const data = await api.list();
          const arr = Array.isArray(data) ? data : (data.rows||[]);
          setRaw(arr.map(r=>{
            const raised = parseDateSafe(r["Date and Time Raised"]);
            const resolved = parseDateSafe(r["Date and Time Resolved"]);
            return {...r, __raised:raised, __resolved:resolved, __time: (raised&&resolved) ? resolved-raised : null};
          }));
          setBanner({type:"", msg:""});
        }catch(e){
          if(!silent) setBanner({type:"error", msg:"Network error while fetching data."});
        }
      }

      const [banner,setBanner]=useState({type:"", msg:""});

      // apply/reset filters
      function applyFilters(){
        setPage(1);
        setRows(filterNow(raw, ui));
      }
      function resetFilters(){
        const fresh = { from:"", to:"", tower:"", flat:"", issue:"", status:"", minRating:"" };
        setUI(fresh);
        setPage(1);
        setRows(filterNow(raw, fresh));
      }

      function filterNow(src, ui){
        let list = src.slice();
        if(ui.from){ const d = parseDateSafe(ui.from); list = list.filter(x=> x.__raised && x.__raised >= d); }
        if(ui.to){ const d = endOfDay(parseDateSafe(ui.to)); list = list.filter(x=> x.__raised && x.__raised <= d); }
        if(ui.tower){ const q = ui.tower.toLowerCase(); list = list.filter(x=> String(x["Tower"]||"").toLowerCase().includes(q)); }
        if(ui.flat){ const q = ui.flat.toLowerCase(); list = list.filter(x=> String(x["Flat"]||"").toLowerCase().includes(q)); }
        if(ui.issue){ const q = ui.issue.toLowerCase(); list = list.filter(x=> String(x["Issue"]||"").toLowerCase().includes(q) || String(x["Description"]||"").toLowerCase().includes(q)); }
        if(ui.status){ list = list.filter(x=> String(x["Status"]||"").toLowerCase() === ui.status.toLowerCase()); }
        if(ui.minRating){ const m = Number(ui.minRating)||0; list = list.filter(x=> Number(x["Feedback Rating"]||0) >= m); }
        // KPIs
        const total = list.length;
        const open = list.filter(x=>x["Status"]==="Open").length;
        const progress = list.filter(x=>x["Status"]==="InProgress").length;
        const resolved = list.filter(x=>x["Status"]==="Resolved").length;
        const resolvedRows = list.filter(x=>x.__time!=null);
        const avgMs = resolvedRows.length ? Math.round(resolvedRows.reduce((a,b)=>a+b.__time,0)/resolvedRows.length) : 0;
        const avgRating = list.length ? (list.reduce((a,b)=>a+(Number(b["Feedback Rating"]||0)),0)/list.length).toFixed(2) : "0.00";
        setKpis({ total, open, progress, resolved, avgTime: msToHuman(avgMs), avgRating });
        return list;
      }

      // recompute filtered whenever raw or ui changes
      useEffect(()=>{ setRows(filterNow(raw, ui)); }, [raw]);

      async function onUpdate(payload){
        if(!session.token){ alert("Not authenticated"); return; }
        try{
          await api.update(session.token, payload);
          await refresh(true);
          setRows(filterNow(raw, ui));
        }catch(e){ alert(String(e)); }
      }

      async function logout(){
        setBusyLogout(true);
        try{ localStorage.removeItem("session"); }catch(_){}
        setSession({token:null, role:null});
        setBusyLogout(false);
      }

      if(!session.token || !session.role){
        return <Login onSuccess={(ok)=>{ setSession(ok); refresh(); }} />
      }

      const isAdmin = session.role === "admin";

      return (
        <>
          <Header
            tz={tz} setTz={setTz}
            auto={auto} setAuto={setAuto}
            onDark={()=>toggleDark()}
            onExport={exportCsv}
            onLogout={logout}
            busyLogout={busyLogout}
            isAdmin={isAdmin}
          />

          {banner.msg && <div className={`banner ${banner.type==="error"?"error":"info"}`}>{banner.msg}</div>}

          <Filters state={{ui, kpis:{...kpis}, pageSize}} setState={(fn)=>{
            // allow setState signature as used above
            // but we only expect updates to ui/pageSize
            const patch = fn({ui, pageSize, kpis});
            if(patch.ui) setUI(patch.ui);
            if(patch.pageSize) setPageSize(patch.pageSize);
          }} apply={applyFilters} reset={resetFilters} />

          <div className="container"><div className="muted">Tip: click column headers to sort. Admin can edit Status & Redressal Remark inline.</div></div>

          <div className="container">
            <Grid
              rows={rows}
              isAdmin={isAdmin}
              sort={sort}
              setSort={setSort}
              page={page}
              setPage={setPage}
              pageSize={pageSize}
              tz={tz}
              onUpdate={onUpdate}
            />
          </div>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
