<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Global Hillview — Society Portal</title>
  <meta name="color-scheme" content="light" />
  <link rel="icon" href="assets/favicon.ico" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { ink:"#0f172a", mist:"#f8fafc", card:"#fff", border:"#e5e7eb" } } }
    }
  </script>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- GAS endpoint (override with ?gas=<url>) -->
  <script>
    window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";
  </script>

  <style>
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; }
    .btn  { background:#0f172a; color:#fff; border-radius:12px; padding:.6rem 1rem; }
    .btn-ghost { background:#f3f4f6; color:#0f172a; border-radius:12px; padding:.5rem .9rem; }
    .badge{ font-size:.75rem;background:#f3f4f6;border-radius:.5rem;padding:.15rem .5rem }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Courier New', monospace }
    .spin { border:2px solid #11182740; border-top-color:#111827; width:14px;height:14px;border-radius:50%; animation:s .9s linear infinite }
    @keyframes s{to{transform:rotate(360deg)}}
    .login-bg{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(125,211,252,.35), transparent 40%),
        radial-gradient(900px 500px at 90% 10%, rgba(167,139,250,.35), transparent 45%),
        radial-gradient(1000px 700px at 50% 90%, rgba(74,222,128,.35), transparent 40%),
        #0b1220;
      animation:floaty 16s ease-in-out infinite alternate;
    }
    @keyframes floaty{0%{background-position:0 0,100% 0,50% 100%}100%{background-position:0 -40px,100% -30px,50% calc(100% + 40px)}}
  </style>
</head>
<body class="bg-mist text-ink">
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;

    // -------- config
    const qs = new URLSearchParams(location.search);
    const GAS = (qs.get('gas') || window.ENV_GAS_URL || '').trim();
    const INR = new Intl.NumberFormat('en-IN', { style:'currency', currency:'INR', maximumFractionDigits:2 });

    // -------- util
    async function fetchWithTimeout(url, opts={}, ms=12000){
      const ctl=new AbortController(); const id=setTimeout(()=>ctl.abort(), ms);
      try{ return await fetch(url,{...opts,signal:ctl.signal}); } finally{ clearTimeout(id); }
    }
    async function getJSON(action, extra={}){
      const u=new URL(GAS); u.searchParams.set('action', action);
      for(const [k,v] of Object.entries(extra)) u.searchParams.set(k,v);
      const r=await fetchWithTimeout(u,{cache:'no-store'}); if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
      return r.json();
    }
    async function postPlain(body){
      const r=await fetchWithTimeout(GAS,{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify(body)});
      if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
      return r.json();
    }

    const api = {
      // auth
      async login(u,p){ try{ return await postPlain({op:'login', username:u, password:p}); } catch{ return getJSON('login',{u,p}); } },
      async sessionInfo(token){ return postPlain({op:'sessionInfo', token}); },

      // list per sheet (your existing actions)
      list: {
        Directory: ()=>getJSON('listDirectory'),
        Notices: ()=>getJSON('listNotices'),
        Issues: ()=>getJSON('listIssues'),
        Transactions: ()=>getJSON('listTransactions'),
        Documents: ()=>getJSON('listDocuments'),
        Voters: ()=>getJSON('listVoters'),
        OpeningBalances: ()=>getJSON('listOpeningBalances').catch(()=>({rows:[]})),
        ChartOfAccounts: ()=>getJSON('listChartOfAccounts').catch(()=>({rows:[]})),
        Users: ()=>getJSON('listUsers').catch(()=>({rows:[]})),
      },

      // generic create + upsert
      async createRow(sheet, row){ return postPlain({ op:'createRow', sheet, row }); },
      async upsertRow(sheet, key, row){ return postPlain({ op:'upsertRow', sheet, key, row }); },
    };

    // -------- small atoms
    const Btn = (p)=><button className={"btn "+(p.className||'')} {...p}>{p.children}</button>;
    const Ghost = (p)=><button className={"btn-ghost "+(p.className||'')} {...p}>{p.children}</button>;
    const BackBar = ({onBack,title})=>(
      <div className="flex items-center justify-between">
        <Ghost onClick={onBack}>← Back</Ghost>
        <div className="text-sm text-gray-500">{title}</div>
      </div>
    );

    // -------- dynamic grid editor (admin only)
    function EditableGrid({ sheet, rows, isAdmin, onRefresh }){
      // Collect ALL columns present
      const columns = useMemo(()=>{
        const set=new Set();
        rows.forEach(r=>Object.keys(r||{}).forEach(k=>set.add(k)));
        return Array.from(set);
      },[rows]);

      // Heuristic: key column per sheet
      const keyField = useMemo(()=>{
        const candidates = {
          Issues: ['Tracking ID','Id','ID'],
          Notices: ['Serial Number','ID'],
          Directory: ['Serial','ID'],
          Transactions: ['ID'],
          Documents: ['Serial Number','ID'],
          Voters: ['ID','Serial Number'],
          OpeningBalances:['Account','ID'],
          ChartOfAccounts:['Code','ID'],
          Users:['Username','User','ID'],
        }[sheet] || ['ID','Serial Number','Tracking ID'];
        return candidates.find(c=>rows[0] && c in rows[0]) || candidates[0];
      },[sheet,rows]);

      // Local editable copies
      const [draft, setDraft] = useState(()=>rows.map(r=>({...r})));
      useEffect(()=>{ setDraft(rows.map(r=>({...r}))); },[rows]);

      function setCell(ridx, col, val){
        setDraft(d => { const cp=d.slice(); cp[ridx] = { ...cp[ridx], [col]: val }; return cp; });
      }

      async function saveRow(ridx){
        if(!isAdmin) return;
        const row = draft[ridx] || {};
        const keyVal = row[keyField] ?? rows[ridx]?.[keyField];
        try{
          await api.upsertRow(sheet, keyField, { ...rows[ridx], ...row, [keyField]: keyVal });
          await onRefresh();
          alert('Saved');
        }catch(e){ alert('Save failed: '+e); }
      }

      // new row form
      const emptyRow = Object.fromEntries(columns.map(c=>[c,'']));
      const [newRow, setNewRow] = useState(emptyRow);
      useEffect(()=>{ const e=Object.fromEntries(columns.map(c=>[c,''])); setNewRow(e); },[columns.join('|')]);

      async function addRow(){
        if(!isAdmin) return;
        try{ await api.createRow(sheet, newRow); await onRefresh(); setNewRow(Object.fromEntries(columns.map(c=>[c,'']))); alert('Added'); }
        catch(e){ alert('Add failed: '+e); }
      }

      return (
        <div className="card p-4">
          {!isAdmin && <div className="text-sm text-red-600 mb-2">Only admin can edit.</div>}

          {/* Add new */}
          {isAdmin && (
            <div className="mb-4">
              <div className="font-medium mb-2">Add to {sheet}</div>
              <div className="grid md:grid-cols-3 gap-2">
                {columns.map(c=>(
                  <div key={'add-'+c}>
                    <div className="text-xs text-gray-500 mb-1">{c}</div>
                    <input className="border rounded-lg p-2 w-full"
                      value={newRow[c]??''} onChange={e=>setNewRow(r=>({...r,[c]:e.target.value}))}/>
                  </div>
                ))}
              </div>
              <div className="mt-3"><Btn onClick={addRow}>Add</Btn></div>
              <hr className="my-4"/>
            </div>
          )}

          {/* Table */}
          <div className="overflow-auto">
            <table className="min-w-full text-sm">
              <thead>
                <tr className="text-left text-gray-600">
                  {columns.map(h=> <th key={h} className="py-2 pr-4 whitespace-nowrap">{h}</th>)}
                  {isAdmin && <th className="py-2 pr-4">Save</th>}
                </tr>
              </thead>
              <tbody>
                {draft.map((r,idx)=>(
                  <tr key={idx} className="border-t align-top">
                    {columns.map(h=>{
                      const v = r[h] ?? '';
                      const isLong = String(v).length > 60 || /[\n\r]/.test(String(v));
                      return (
                        <td key={h} className="py-2 pr-4 whitespace-nowrap">
                          {isAdmin
                            ? (isLong
                                ? <textarea rows="2" className="border rounded-lg p-2 w-[320px]" value={v} onChange={e=>setCell(idx,h, e.target.value)} />
                                : <input className="border rounded-lg p-2 w-[220px]" value={v} onChange={e=>setCell(idx,h, e.target.value)} />)
                            : String(v)}
                        </td>
                      );
                    })}
                    {isAdmin && <td className="py-2 pr-4"><Ghost onClick={()=>saveRow(idx)}>Save</Ghost></td>}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // -------- pages (each uses EditableGrid)
    const PageShell = ({title, onBack, children})=>(
      <section className="grid gap-3">
        <BackBar title={title} onBack={onBack} />
        {children}
      </section>
    );

    function Dashboard({issues, directory, transactions, notices}){
      const open = issues.filter(x=>(x.Status||'').toLowerCase()!=='closed').length;
      const paid = transactions.filter(x=>(x.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
      const deb  = transactions.filter(x=>(x.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
      return (
        <div className="grid gap-3">
          <div className="grid md:grid-cols-4 gap-3">
            <div className="card p-4"><div className="text-xs text-gray-500">Residents</div><div className="text-2xl font-semibold">{directory.length}</div></div>
            <div className="card p-4"><div className="text-xs text-gray-500">Open issues</div><div className="text-2xl font-semibold">{open}</div></div>
            <div className="card p-4"><div className="text-xs text-gray-500">Collected</div><div className="text-2xl font-semibold">{INR.format(paid)}</div></div>
            <div className="card p-4"><div className="text-xs text-gray-500">Debits</div><div className="text-2xl font-semibold">{INR.format(deb)}</div></div>
          </div>
          <div className="card p-4">
            <div className="font-medium mb-2">Latest notices</div>
            <div className="grid gap-2">
              {notices.slice(0,5).map((n,i)=>(
                <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                  <div>
                    <div className="font-medium">{n['Subject']}</div>
                    <div className="text-xs text-gray-500">{n['Date']}</div>
                  </div>
                  <span className="badge">{n['Serial Number']||i+1}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // -------- app
    function App(){
      const [view,setView]=useState('dashboard');               // dashboard | <sheetName>
      const [session,setSession]=useState({token:null, role:null, username:null});
      const [data,setData]=useState({ Directory:[], Notices:[], Issues:[], Transactions:[], Documents:[], Voters:[], OpeningBalances:[], ChartOfAccounts:[], Users:[] });
      const [busy,setBusy]=useState(false);
      const isAdmin = (session.role==='admin');

      async function refresh(sheet){
        setBusy(true);
        try{
          if(sheet){
            const r = await api.list[sheet]();
            setData(d=>({...d, [sheet]: (r?.rows||[])}));
          }else{
            const entries = await Promise.all(Object.keys(api.list).map(async k=>[k, (await api.list[k]())?.rows||[] ]));
            setData(Object.fromEntries(entries));
          }
        } finally { setBusy(false); }
      }

      // session boot
      useEffect(()=>{
        const tok = qs.get('session') || localStorage.getItem('session');
        (async ()=>{
          if(tok){
            try{
              const s = await api.sessionInfo(tok);
              if(s?.ok){ setSession({token:tok, role:(s.role||'user').toLowerCase(), username:s.username||'user'}); }
              else localStorage.removeItem('session');
            }catch(_){}
          }
          await refresh();
        })();
      },[]);

      // Login gate
      if(!session.token || !session.role){
        return <LoginScreen onSuccess={(s)=>{ setSession(s); refresh(); }} backend={GAS} />;
      }

      return (
        <div className="max-w-7xl mx-auto p-4">
          <header className="sticky top-0 z-40 border-b bg-white/70 backdrop-blur mb-4">
            <div className="h-14 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <img src="assets/brand-mark.png" className="w-8 h-8 rounded-md" alt="brand"/>
                <div className="font-semibold">Global Hillview, Sec-11, Sohna, Gurgaon</div>
              </div>
              <div className="flex items-center gap-2">
                <span className="badge">Logged in: {session.role}</span>
                <Ghost onClick={()=>{ localStorage.removeItem('session'); setSession({token:null,role:null,username:null}); }}>Logout</Ghost>
              </div>
            </div>
          </header>

          <div className="grid grid-cols-1 md:grid-cols-[220px_1fr] gap-4">
            <aside className="grid gap-2">
              {['dashboard','Directory','Notices','Issues','Transactions','Documents','Voters','OpeningBalances','ChartOfAccounts','Users'].map(tab=>(
                <button key={tab} className={`btn-ghost text-left ${view===tab?'ring-2 ring-gray-300':''}`} onClick={()=>setView(tab)}>
                  {tab==='dashboard'?'Dashboard':tab}
                </button>
              ))}
              <div className="card p-3 text-xs text-gray-500">
                Backend: <code className="mono break-all">{GAS||'(missing)'}</code>
                {busy && <div className="mt-2 flex items-center gap-2"><span className="spin"></span> Loading…</div>}
              </div>
            </aside>

            <main className="grid gap-4">
              {view==='dashboard' && <Dashboard
                issues={data.Issues} directory={data.Directory} transactions={data.Transactions} notices={data.Notices} />}

              {view!=='dashboard' && (
                <PageShell title={view} onBack={()=>setView('dashboard')}>
                  <EditableGrid
                    sheet={view}
                    rows={data[view]||[]}
                    isAdmin={isAdmin}
                    onRefresh={()=>refresh(view)}
                  />
                </PageShell>
              )}
            </main>
          </div>
        </div>
      );
    }

    function LoginScreen({ onSuccess, backend }){
      const [u,setU]=useState(''); const [p,setP]=useState(''); const [err,setErr]=useState(''); const [busy,setBusy]=useState(false);
      async function go(){
        setBusy(true); setErr('');
        try{
          const r=await api.login(u,p);
          if(r?.ok && r?.token){ localStorage.setItem('session', r.token); onSuccess({token:r.token, role:(r.role||'user').toLowerCase(), username:r.username||u}); }
          else setErr(r?.error||'Invalid credentials');
        }catch(e){ setErr(String(e)); } finally{ setBusy(false); }
      }
      return (
        <div className="login-bg grid place-items-center p-6">
          <div className="w-full max-w-md">
            <div className="card p-6">
              <div className="flex items-center gap-3 mb-4">
                <img src="assets/logo.png" className="w-10 h-10 rounded-md" alt="logo"/>
                <div className="font-semibold">Global Hillview — Society Portal</div>
              </div>
              <div className="grid gap-3">
                <div><div className="text-sm text-gray-500">Username</div><input className="border rounded-xl p-2 w-full" value={u} onChange={e=>setU(e.target.value)} autoFocus/></div>
                <div><div className="text-sm text-gray-500">Password</div><input type="password" className="border rounded-xl p-2 w-full" value={p} onChange={e=>setP(e.target.value)}/></div>
                <Btn onClick={go} disabled={busy} className="flex items-center gap-2 justify-center">{busy&&<span className="spin"></span>}<span>{busy?'Signing in…':'Sign in'}</span></Btn>
                {err && <div className="text-red-600 text-sm">{err}</div>}
              </div>
            </div>
            <div className="text-white/70 text-xs mt-3">Backend: <code className="mono">{backend||'(not set)'}</code></div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
