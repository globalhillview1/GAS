<!-- Single-file, no-build index.html for GitHub Pages
     ‚úÖ Uses React 18 UMD + Babel Standalone (runs directly on GH Pages)
     ‚úÖ No imports/TypeScript/bundler needed
     ‚úÖ Connects to your Google Apps Script backend
     ‚úÖ NEW: Robust fetch with timeout+retries, clear errors, and Demo Mode fallback
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SocietyGuard ‚Äî Sheets-backed Portal</title>
  <meta name="description" content="Community management web app powered by Google Sheets (GAS backend)." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%8F%A1%3C/text%3E%3C/svg%3E" />

  <!-- Tailwind (utility styles) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { background: '#f9fafb', foreground: '#111827' } } }
    }
  </script>

  <!-- React 18 UMD + Babel Standalone for in-browser JSX (no build step) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Configure your Google Apps Script endpoint here (can be overridden by ?gas=... or disabled via ?demo=1) -->
  <script>
    // IMPORTANT: Keep this value or override via the URL param `?gas=...`
    window.ENV_GAS_URL = "https://script.google.com/macros/s/AKfycbxzoyXJNkqqxNZprAfvAzpsszrkAKXiposW1WjbqHO-4Wu_5fJk7hJ6HCqihF76TKED/exec";
  </script>

  <style>
    .card { background:#fff; border-radius:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04); border:1px solid #e5e7eb; }
    .btn  { padding:.5rem 1rem; border-radius:.75rem; background:#111827; color:#fff; }
    .btn:hover { background:#0b0f1a; }
    .btn-secondary { padding:.5rem .75rem; border-radius:.75rem; background:#f3f4f6; color:#111827; }
    .btn-secondary:hover { background:#e5e7eb; }
    .badge { display:inline-flex; align-items:center; padding:.125rem .5rem; font-size:.75rem; border-radius:.5rem; background:#f3f4f6; color:#374151; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-background text-foreground">
  <div id="root" class="min-h-screen"></div>

  <!-- App Code (JSX compiled in the browser) -->
  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // =====================
    // Config & Utilities
    // =====================
    const params = new URLSearchParams(location.search);
    const URL_OVERRIDE = params.get('gas');
    const FORCE_DEMO   = params.get('demo') === '1' || params.get('offline') === '1';
    const BASE_URL = (URL_OVERRIDE || (window.ENV_GAS_URL || '')).trim();

    const DEMO = {
      Directory: [
        { Serial: 1, Name: 'Ayesha Khan',  Flat: 'A-302', Phone: '+49 160 555 0001', Email: 'ayesha@example.com' },
        { Serial: 2, Name: 'Rohan Mehta',  Flat: 'B-1204', Phone: '+49 160 555 0002', Email: 'rohan@example.com' },
        { Serial: 3, Name: 'Sofia Keller', Flat: 'C-803', Phone: '+49 160 555 0003', Email: 'sofia@example.com' }
      ],
      Notices: [
        { 'Serial Number': 1, Subject: 'Water shutdown on Friday', Date: '2025-01-15', Notice: 'Maintenance from 10:00‚Äì12:00 in Block B.' },
        { 'Serial Number': 2, Subject: 'Diwali Fest ‚Äì Community Hall', Date: '2025-01-16', Notice: 'Potluck & games this Saturday 18:30.' }
      ],
      Issues: [
        { 'Tracking ID': 'demo-101', 'Date and Time Raised': '2025-01-16T09:00:00Z', Tower: '', Flat: 'B-1204', Title: 'Lift not working', Category: 'Infrastructure', Description: 'Lift stuck at floor 7.', Status: 'Open' },
        { 'Tracking ID': 'demo-102', 'Date and Time Raised': '2025-01-16T09:15:00Z', Tower: '', Flat: 'A-302', Title: 'Water leakage', Category: 'Plumbing', Description: 'Leak in kitchen sink.', Status: 'In Progress' }
      ],
      Documents: [
        { 'Serial Number': 1, Subject: 'AGM Minutes', Date: '2025-01-10', Media: 'PDF', Link: '#', Category: 'Governance' }
      ],
      Transactions: [
        { Date: '2025-01-01', Type: 'Credit', Category: 'Maintenance', 'Sub-category': 'Monthly', Amount: 120 },
        { Date: '2025-01-01', Type: 'Debit',  Category: 'Clubhouse',  'Sub-category': 'Snacks',  Amount: 25 }
      ],
      Voters: [
        { 'Tower No.': 'A', 'Flat No.': '302', 'First Owner Name': 'Ayesha Khan', 'Second Owner Name': '' }
      ]
    };

    // Fetch with timeout + retries to avoid hanging "Failed to fetch" and surface CORS issues clearly
    async function fetchWithTimeout(url, opts={}, timeoutMs=10000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try { return await fetch(url, { ...opts, signal: controller.signal }); }
      finally { clearTimeout(id); }
    }

    async function api(action, method='GET', payload, retries=1) {
      if (!BASE_URL) throw new Error('Missing BASE_URL');
      const url = new URL(BASE_URL);
      url.searchParams.set('action', action);
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (method === 'POST' && payload) opts.body = JSON.stringify(payload);

      let lastErr;
      for (let i=0; i<=retries; i++) {
        try {
          const res = await fetchWithTimeout(url.toString(), opts, 12000);
          if (!res.ok) throw new Error(await res.text());
          return await res.json();
        } catch (e) {
          lastErr = e;
          if (i === retries) throw e;
          await new Promise(r => setTimeout(r, 600 * (i+1)));
        }
      }
      throw lastErr;
    }

    function NavItem({ label, active, onClick }) {
      return (
        <button className={`btn-secondary text-left ${active ? 'ring-2 ring-gray-300' : ''}`} onClick={onClick}>{label}</button>
      );
    }

    function Stat({ label, value }) {
      return (
        <div className="card p-5">
          <div className="text-2xl font-semibold">{value}</div>
          <div className="text-sm text-gray-500">{label}</div>
        </div>
      );
    }

    function Banner({ kind='info', children }) {
      const cls = kind==='error' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-blue-50 text-blue-700 border-blue-200';
      return <div className={`border rounded-xl p-3 ${cls}`}>{children}</div>;
    }

    function Section({ children }) { return <section className="grid gap-4">{children}</section>; }

    // =====================
    // Pages
    // =====================
    function Dashboard({ residents, tickets, transactions, notices }) {
      const openTickets = tickets.filter(t => String(t.Status||t.status||'').toLowerCase() !== 'closed').length;
      const totalDue  = transactions.filter(t => String(t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
      const totalPaid = transactions.filter(t => String(t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
      return (
        <Section>
          <div className="grid gap-4 md:grid-cols-3">
            <Stat label="Residents" value={residents.length} />
            <Stat label="Open issues" value={openTickets} />
            <Stat label="Net collected" value={`‚Ç¨ ${(totalPaid-totalDue).toFixed(2)}`} />
          </div>
          <div className="grid gap-4 md:grid-cols-2">
            <div className="card p-5">
              <div className="font-medium mb-1">Latest notices</div>
              <div className="text-xs text-gray-500 mb-3">From the "Notices" sheet</div>
              <div className="grid gap-2">
                {notices.slice(0,5).map((n,i)=> (
                  <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                    <div>
                      <div className="font-medium">{n['Subject']||n.title}</div>
                      <div className="text-xs text-gray-500">{n.Date||n.createdAt}</div>
                    </div>
                    <span className="badge">{n['Serial Number']||n.id||''}</span>
                  </div>
                ))}
              </div>
            </div>
            <div className="card p-5">
              <div className="font-medium mb-1">Open issues</div>
              <div className="text-xs text-gray-500 mb-3">From the "Issues" sheet</div>
              <div className="grid gap-2">
                {tickets.filter(t=>String(t.Status||'').toLowerCase()!=='closed').slice(0,5).map((t,i)=> (
                  <div key={i} className="flex items-center justify-between border rounded-xl p-3">
                    <div>
                      <div className="font-medium">{t['Title']||t['Category']}</div>
                      <div className="text-xs text-gray-500">{t['Category']} ‚Ä¢ {t['Flat']||t['Flat No.']||''}</div>
                    </div>
                    <span className="badge">{t['Status']||'Open'}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </Section>
      );
    }

    function Notices({ notices, onCreate, writable }) {
      const [subject, setSubject] = useState('');
      const [notice, setNotice]   = useState('');
      async function submit(){
        if(!subject) return;
        const created = await onCreate({ Subject: subject, Notice: notice, Date: new Date().toLocaleDateString() });
        setSubject(''); setNotice('');
        return created;
      }
      return (
        <Section>
          {!writable && <Banner kind="error">Demo Mode: write actions are disabled because the backend could not be reached.</Banner>}
          <div className="card p-5">
            <div className="font-medium">Post notice</div>
            <div className="text-xs text-gray-500 mb-4">Writes to the "Notices" sheet</div>
            <div className="grid gap-3">
              <div>
                <label className="block text-sm mb-1">Subject</label>
                <input className="w-full border rounded-xl p-2" value={subject} onChange={e=>setSubject(e.target.value)} placeholder="e.g., Water shutdown" />
              </div>
              <div>
                <label className="block text-sm mb-1">Notice</label>
                <textarea className="w-full border rounded-xl p-2" rows="4" value={notice} onChange={e=>setNotice(e.target.value)} placeholder="Details‚Ä¶"></textarea>
              </div>
              <div><button className="btn" onClick={submit} disabled={!writable}>Publish</button></div>
            </div>
          </div>
          <div className="grid gap-3">
            {notices.map((n,i)=> (
              <div key={i} className="card p-4">
                <div className="flex items-center justify-between">
                  <div className="font-medium">{n['Subject']}</div>
                  <span className="badge">{n['Serial Number']||i+1}</span>
                </div>
                <div className="text-xs text-gray-500 mb-2">{n['Date']}</div>
                <div className="text-sm">{n['Notice']||''}</div>
              </div>
            ))}
          </div>
        </Section>
      );
    }

    function Issues({ tickets, onCreate, writable }) {
      const [title, setTitle] = useState('');
      const [category, setCategory] = useState('Infrastructure');
      const [flat, setFlat] = useState('');
      const [description, setDescription] = useState('');

      async function submit(){
        if(!title || !flat) return;
        await onCreate({ Title: title, Category: category, Flat: flat, Description: description, Status: 'Open', 'Date and Time Raised': new Date().toISOString() });
        setTitle(''); setFlat(''); setDescription(''); setCategory('Infrastructure');
      }

      const categories = ['Infrastructure','Plumbing','Electrical','Housekeeping','Security'];

      return (
        <Section>
          {!writable && <Banner kind="error">Demo Mode: write actions are disabled because the backend could not be reached.</Banner>}
          <div className="card p-5">
            <div className="font-medium">Raise an issue</div>
            <div className="text-xs text-gray-500 mb-4">Writes to the "Issues" sheet</div>
            <div className="grid gap-3">
              <div>
                <label className="block text-sm mb-1">Title</label>
                <input className="w-full border rounded-xl p-2" value={title} onChange={e=>setTitle(e.target.value)} placeholder="Short summary" />
              </div>
              <div>
                <label className="block text-sm mb-1">Category</label>
                <select className="w-64 border rounded-xl p-2" value={category} onChange={e=>setCategory(e.target.value)}>
                  {categories.map(c=> <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              <div className="grid md:grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm mb-1">Flat</label>
                  <input className="w-full border rounded-xl p-2" value={flat} onChange={e=>setFlat(e.target.value)} placeholder="e.g., A-302" />
                </div>
                <div>
                  <label className="block text-sm mb-1">Details</label>
                  <input className="w-full border rounded-xl p-2" value={description} onChange={e=>setDescription(e.target.value)} placeholder="Optional" />
                </div>
              </div>
              <div><button className="btn" onClick={submit} disabled={!writable}>Submit</button></div>
            </div>
          </div>
          <div className="grid gap-3 mt-3">
            {tickets.map((t,i)=> (
              <div key={i} className="card p-4">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium">{t['Title']||t['Category']}</div>
                    <div className="text-xs text-gray-500">{t['Category']} ‚Ä¢ {t['Flat']}</div>
                  </div>
                  <span className="badge">{t['Status']}</span>
                </div>
                {t['Description'] && <div className="text-sm text-gray-600 mt-1">{t['Description']}</div>}
              </div>
            ))}
          </div>
        </Section>
      );
    }

    function Directory({ residents }) {
      return (
        <Section>
          <div className="card p-5">
            <div className="font-medium">Residents directory</div>
            <div className="text-xs text-gray-500 mb-4">From the "Directory" sheet (read-only demo)</div>
            <div className="grid gap-3">
              {residents.map(r => (
                <div key={r.id} className="flex flex-col md:flex-row md:items-center justify-between gap-3 border rounded-2xl p-4">
                  <div>
                    <div className="font-medium">{r.name} <span className="badge ml-2">{r.flat}</span></div>
                    <div className="flex flex-wrap gap-4 text-sm text-gray-600 mt-1">
                      {r.phone && <span>üìû {r.phone}</span>}
                      {r.email && <span>‚úâÔ∏è {r.email}</span>}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Payments({ transactions }) {
      const totals = useMemo(()=>{
        const paid = transactions.filter(t=>String(t.Type||'').toLowerCase()==='credit').reduce((a,b)=>a+Number(b.Amount||0),0);
        const due  = transactions.filter(t=>String(t.Type||'').toLowerCase()==='debit').reduce((a,b)=>a+Number(b.Amount||0),0);
        return { paid, due };
      }, [transactions]);
      return (
        <Section>
          <div className="grid gap-4 md:grid-cols-2">
            <Stat label="Collected (credits)" value={`‚Ç¨ ${totals.paid.toFixed(2)}`} />
            <Stat label="Debits" value={`‚Ç¨ ${totals.due.toFixed(2)}`} />
          </div>
          <div className="card p-5 mt-2">
            <div className="font-medium">Transactions</div>
            <div className="text-xs text-gray-500 mb-3">From the "Transactions" sheet</div>
            <div className="grid gap-2">
              {transactions.map((p,i)=> (
                <div key={i} className="grid md:grid-cols-6 gap-2 items-center border rounded-xl p-3 text-sm">
                  <div className="font-medium md:col-span-2">{p['Date']}</div>
                  <div>{p['Type']}</div>
                  <div>{p['Category']}</div>
                  <div>{p['Sub-category']}</div>
                  <div className="md:text-right">‚Ç¨ {Number(p['Amount']||0).toFixed(2)}</div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Documents({ documents }) {
      return (
        <Section>
          <div className="card p-5">
            <div className="font-medium">Documents</div>
            <div className="text-xs text-gray-500 mb-3">From the "Documents" sheet</div>
            <div className="grid gap-2">
              {documents.map((d,i)=> (
                <div key={i} className="flex items-center justify-between border rounded-2xl p-4">
                  <div>
                    <div className="font-medium">{d['Subject']}</div>
                    <div className="text-xs text-gray-500">{d['Date']} ‚Ä¢ {d['Category']}</div>
                  </div>
                  {d['Link'] && <a className="underline" target="_blank" rel="noreferrer" href={d['Link']}>Open</a>}
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Voters({ voters }) {
      return (
        <Section>
          <div className="card p-5">
            <div className="font-medium">Voters list</div>
            <div className="text-xs text-gray-500 mb-3">From the "Voters" sheet</div>
            <div className="grid gap-2">
              {voters.map((v,i)=> (
                <div key={i} className="border rounded-2xl p-4">
                  <div className="font-medium">{v['First Owner Name']}{v['Second Owner Name'] ? ` & ${v['Second Owner Name']}` : ''}</div>
                  <div className="text-xs text-gray-500">Tower {v['Tower No.']} ‚Ä¢ Flat {v['Flat No.']}</div>
                </div>
              ))}
            </div>
          </div>
        </Section>
      );
    }

    function Diagnostics({ baseUrl, lastError, mode, rerun }) {
      return (
        <div className="card p-4 text-sm">
          <div className="font-medium mb-1">Diagnostics</div>
          <div>Mode: <span className="mono">{mode}</span></div>
          <div>BASE_URL: <code className="break-all mono">{baseUrl || '(empty)'}</code></div>
          {lastError && <div className="text-red-600 mt-1">Last error: {String(lastError)}</div>}
          <div className="text-xs text-gray-500 mt-1">Tip: override with <code>?gas=&lt;url&gt;</code> or force demo with <code>?demo=1</code></div>
          <div className="mt-2 flex gap-2">
            <button className="btn" onClick={rerun}>Run connectivity tests</button>
            <a className="btn-secondary" href="?demo=1">Open in Demo Mode</a>
          </div>
        </div>
      );
    }

    // =====================
    // App (with Demo fallback)
    // =====================
    function App(){
      const [view, setView] = useState('dashboard');
      const [loading, setLoading] = useState(false);
      const [lastError, setLastError] = useState('');
      const [mode, setMode] = useState(FORCE_DEMO ? 'DEMO' : 'LIVE');

      const [directory, setDirectory] = useState([]);
      const [notices, setNotices] = useState([]);
      const [tickets, setTickets] = useState([]);
      const [transactions, setTransactions] = useState([]);
      const [documents, setDocuments] = useState([]);
      const [voters, setVoters] = useState([]);
      const [search, setSearch] = useState('');

      async function loadAll() {
        if (FORCE_DEMO || !BASE_URL) { useDemo(); return; }
        try {
          setLoading(true); setLastError('');
          const [dir, nts, iss, txs, docs, vts] = await Promise.all([
            api('listDirectory', 'GET', null, 1),
            api('listNotices',   'GET', null, 1),
            api('listIssues',    'GET', null, 1),
            api('listTransactions','GET',null,1),
            api('listDocuments', 'GET', null, 1),
            api('listVoters',    'GET', null, 1),
          ]);
          setDirectory(dir?.rows||[]);
          setNotices(nts?.rows||[]);
          setTickets(iss?.rows||[]);
          setTransactions(txs?.rows||[]);
          setDocuments(docs?.rows||[]);
          setVoters(vts?.rows||[]);
          setMode('LIVE');
        } catch (err) {
          setLastError(err);
          useDemo();
        } finally { setLoading(false); }
      }

      function useDemo(){
        setDirectory(DEMO.Directory);
        setNotices(DEMO.Notices);
        setTickets(DEMO.Issues);
        setTransactions(DEMO.Transactions);
        setDocuments(DEMO.Documents);
        setVoters(DEMO.Voters);
        setMode('DEMO');
      }

      useEffect(()=>{ loadAll(); },[]);

      const residents = useMemo(()=> directory.map(r=>({
        id: r.Serial ?? r.id ?? `${r.Name}-${r.Flat}`,
        name: r.Name ?? r['First Owner Name'] ?? '',
        flat: r.Flat ?? `${r['Tower No.']||''}-${r['Flat No.']||''}`,
        phone: r.Phone || r.Mobile || '',
        email: r.Email || '',
      })), [directory]);

      const filteredResidents = useMemo(()=>{
        const q = search.toLowerCase();
        return residents.filter(r=>[r.name,r.flat,r.phone,r.email].some(v=>String(v||'').toLowerCase().includes(q)));
      }, [search, residents]);

      const writable = mode === 'LIVE';

      return (
        <div className="max-w-7xl mx-auto p-4">
          {/* Topbar */}
          <header className="sticky top-0 z-40 border-b bg-white/70 backdrop-blur mb-4">
            <div className="h-14 flex items-center justify-between">
              <div className="font-semibold text-lg">üè° SocietyGuard</div>
              <div className="hidden md:flex gap-2">
                <input className="border rounded-xl px-3 py-2 w-80" placeholder="Search directory‚Ä¶" value={search} onChange={e=>setSearch(e.target.value)} />
                <button className="btn-secondary">Search</button>
              </div>
            </div>
          </header>

          {/* Shell */}
          <div className="grid grid-cols-1 md:grid-cols-[220px_1fr] gap-4">
            {/* Sidebar */}
            <aside className="grid gap-2">
              {['dashboard','notices','tickets','directory','payments','documents','voters'].map(tab=> (
                <NavItem key={tab} label={tab.charAt(0).toUpperCase()+tab.slice(1)} active={view===tab} onClick={()=>setView(tab)} />
              ))}
              <Diagnostics baseUrl={BASE_URL} lastError={lastError} mode={mode} rerun={loadAll} />
            </aside>

            {/* Content */}
            <main className="grid gap-4">
              {loading && <div className="text-sm text-gray-500">Loading from Google Sheets‚Ä¶</div>}
              {mode==='DEMO' && <Banner kind="error">Failed to reach backend. Running in Demo Mode so you can still try the app.</Banner>}
              {view==='dashboard' && <Dashboard residents={residents} tickets={tickets} transactions={transactions} notices={notices} />}
              {view==='notices' && <Notices notices={notices} onCreate={async n=>{ if(!writable){ alert('Demo Mode: write disabled'); return n; } const created = await api('createNotice','POST',n); setNotices(p=>[created,...p]); return created; }} writable={writable} />}
              {view==='tickets' && <Issues tickets={tickets} onCreate={async t=>{ if(!writable){ alert('Demo Mode: write disabled'); return t; } const created = await api('createIssue','POST',t); setTickets(p=>[created,...p]); return created; }} writable={writable} />}
              {view==='directory' && <Directory residents={filteredResidents} />}
              {view==='payments' && <Payments transactions={transactions} />}
              {view==='documents' && <Documents documents={documents} />}
              {view==='voters' && <Voters voters={voters} />}
            </main>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>

  <noscript>
    <div class="p-8 text-center">‚ö†Ô∏è This app requires JavaScript. Please enable it.</div>
  </noscript>
</body>
</html>
